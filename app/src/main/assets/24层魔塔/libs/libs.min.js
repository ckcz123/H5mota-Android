"use strict";function loader(){this._init()}loader.prototype._init=function(){};loader.prototype._setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};loader.prototype._setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerHTML=a};loader.prototype._load=function(a){this._loadIcons();this._loadAnimates();this._loadMusic();core.loader._loadMaterialImages(function(){core.loader._loadExtraImages(function(){core.loader._loadAutotiles(function(){core.loader._loadTilesets(a)})})})};loader.prototype._loadIcons=function(){this.loadImage("icons.png",function(a,b){var c=core.splitImage(b);for(var d in core.statusBar.icons){if(typeof core.statusBar.icons[d]=="number"){core.statusBar.icons[d]=c[core.statusBar.icons[d]];if(core.statusBar.image[d]!=null){core.statusBar.image[d].src=core.statusBar.icons[d].src}}}})};loader.prototype._loadMaterialImages=function(a){this.loadImages(core.materials,core.material.images,a)};loader.prototype._loadExtraImages=function(a){core.material.images.images={};var b=core.clone(core.images);if(b.indexOf("hero.png")<0){b.push("hero.png")}this.loadImages(b,core.material.images.images,a)};loader.prototype._loadAutotiles=function(b){core.material.images.autotile={};var c=Object.keys(core.material.icons.autotile);var a={};this.loadImages(c,a,function(){c.forEach(function(d){core.material.images.autotile[d]=a[d]});setTimeout(function(){core.maps._makeAutotileEdges()});b()})};loader.prototype._loadTilesets=function(a){core.material.images.tilesets={};core.tilesets=core.tilesets||[];core.loader.loadImages(core.clone(core.tilesets),core.material.images.tilesets,function(){for(var c in core.material.images.tilesets){var b=core.material.images.tilesets[c];if(b.width%32!=0||b.height%32!=0){console.warn("警告！"+c+"的宽或高不是32的倍数！")}if(b.width*b.height>32*32*3000){console.warn("警告！"+c+"上的图块素材个数大于3000！")}}a()})};loader.prototype.loadImages=function(d,e,a){if(!d||d.length==0){if(a){a()}return}var c=0;for(var b=0;b<d.length;b++){this.loadImage(d[b],function(f,g){core.loader._setStartLoadTipText("正在加载图片 "+f+"...");e[f]=g;c++;core.loader._setStartProgressVal(c*(100/d.length));if(c==d.length){if(a){a()}}})}};loader.prototype.loadImage=function(d,a){try{var f=d;if(f.indexOf(".")<0){f=f+".png"}var c=new Image();c.onload=function(){a(d,c)};c.src="project/images/"+f+"?v="+main.version}catch(b){main.log(b)}};loader.prototype._loadAnimates=function(){core.animates.forEach(function(a){core.http("GET","project/animates/"+a+".animate",null,function(b){try{b=JSON.parse(b);var c={};c.ratio=b.ratio;c.se=b.se;c.images=[];c.images_rev=[];b.bitmaps.forEach(function(h){if(!h){c.images.push(null)}else{try{var g=new Image();g.src=h;c.images.push(g)}catch(f){main.log(f);c.images.push(null)}}});c.frame=b.frame_max;c.frames=[];b.frames.forEach(function(f){var e=[];f.forEach(function(g){e.push({index:g[0],x:g[1],y:g[2],zoom:g[3],opacity:g[4],mirror:g[5]||0,angle:g[6]||0,})});c.frames.push(e)});core.material.animates[a]=c}catch(d){main.log(d);core.material.animates[a]=null}},function(b){main.log(b);core.material.animates[a]=null},"text/plain; charset=x-user-defined")})};loader.prototype._loadMusic=function(){core.bgms.forEach(function(a){core.loader.loadOneMusic(a)});core.sounds.forEach(function(a){core.loader.loadOneSound(a)});core.playBgm(main.startBgm)};loader.prototype.loadOneMusic=function(b){var a=new Audio();a.preload="none";if(main.bgmRemote){a.src=main.bgmRemoteRoot+core.firstData.name+"/"+b}else{a.src="project/sounds/"+b}a.loop="loop";core.material.bgms[b]=a};loader.prototype.loadOneSound=function(b){if(core.musicStatus.audioContext!=null){core.http("GET","project/sounds/"+b,null,function(c){try{core.musicStatus.audioContext.decodeAudioData(c,function(e){core.material.sounds[b]=e},function(f){main.log(f);core.material.sounds[b]=null})}catch(d){main.log(d);core.material.sounds[b]=null}},function(c){main.log(c);core.material.sounds[b]=null},null,"arraybuffer")}else{var a=new Audio();a.src="project/sounds/"+b;core.material.sounds[b]=a}};loader.prototype.loadBgm=function(b){b=core.getMappedName(b);if(!core.material.bgms[b]){return}if(!core.musicStatus.bgmStatus){return}var a=core.musicStatus.cachedBgms.indexOf(b);if(a>=0){core.musicStatus.cachedBgms.splice(a,1)}else{this._preloadBgm(core.material.bgms[b]);if(core.musicStatus.cachedBgms.length==core.musicStatus.cachedBgmCount){this.freeBgm(core.musicStatus.cachedBgms.pop())}}core.musicStatus.cachedBgms.unshift(b)};loader.prototype._preloadBgm=function(a){a.volume=0;a.play()};loader.prototype.freeBgm=function(a){a=core.getMappedName(a);if(!core.material.bgms[a]){return}core.musicStatus.cachedBgms=core.musicStatus.cachedBgms.filter(function(b){return b!=a});core.material.bgms[a].removeAttribute("src");core.material.bgms[a].load();core.material.bgms[a]=null;if(a==core.musicStatus.playingBgm){core.musicStatus.playingBgm=null}setTimeout(function(){core.loader.loadOneMusic(a)},3000)};"use strict";function control(){this._init()}control.prototype._init=function(){this.controldata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.control;this.renderFrameFuncs=[];this.replayActions=[];this.resizes=[];this.registerAnimationFrame("totalTime",false,this._animationFrame_totalTime);this.registerAnimationFrame("autoSave",true,this._animationFrame_autoSave);this.registerAnimationFrame("globalAnimate",true,this._animationFrame_globalAnimate);this.registerAnimationFrame("animate",true,this._animationFrame_animate);this.registerAnimationFrame("heroMoving",true,this._animationFrame_heroMoving);this.registerAnimationFrame("weather",true,this._animationFrame_weather);this.registerAnimationFrame("parallelDo",false,this._animationFrame_parallelDo);this.registerAnimationFrame("checkConsoleOpened",true,this._animationFrame_checkConsoleOpened);this.registerReplayAction("move",this._replayAction_move);this.registerReplayAction("item",this._replayAction_item);this.registerReplayAction("equip",this._replayAction_equip);this.registerReplayAction("unEquip",this._replayAction_unEquip);this.registerReplayAction("fly",this._replayAction_fly);this.registerReplayAction("shop",this._replayAction_shop);this.registerReplayAction("turn",this._replayAction_turn);this.registerReplayAction("getNext",this._replayAction_getNext);this.registerReplayAction("moveDirectly",this._replayAction_moveDirectly);this.registerReplayAction("key",this._replayAction_key);this.registerResize("gameGroup",this._resize_gameGroup);this.registerResize("canvas",this._resize_canvas);this.registerResize("statusBar",this._resize_statusBar);this.registerResize("status",this._resize_status);this.registerResize("toolBar",this._resize_toolBar);this.registerResize("tools",this._resize_tools)};control.prototype.registerAnimationFrame=function(b,c,a){this.unregisterAnimationFrame(b);this.renderFrameFuncs.push({name:b,needPlaying:c,func:a})};control.prototype.unregisterAnimationFrame=function(a){this.renderFrameFuncs=this.renderFrameFuncs.filter(function(b){return b.name!=a})};control.prototype._setRequestAnimationFrame=function(){this._checkRequestAnimationFrame();core.animateFrame.totalTime=Math.max(core.animateFrame.totalTime,core.getLocalStorage("totalTime",0));var a=function(b){core.control.renderFrameFuncs.forEach(function(c){if(c.func){try{if(core.isPlaying()||!c.needPlaying){core.doFunc(c.func,core.control,b)}}catch(d){main.log(d);main.log("ERROR in requestAnimationFrame["+c.name+"]：已自动注销该项。");core.unregisterAnimationFrame(c.name)}}});window.requestAnimationFrame(a)};window.requestAnimationFrame(a)};control.prototype._checkRequestAnimationFrame=function(){(function(){var a=0;var b=["webkit","moz"];for(var c=0;c<b.length&&!window.requestAnimationFrame;++c){window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(d,f){var e=new Date().getTime();var h=Math.max(0,16.7-(e-a));var g=window.setTimeout(function(){d(e+h)},h);a=e+h;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}())};control.prototype._animationFrame_totalTime=function(a){core.animateFrame.totalTime+=a-core.animateFrame.totalTimeStart;core.animateFrame.totalTimeStart=a;if(core.isPlaying()){core.status.hero.statistics.totalTime=core.animateFrame.totalTime;core.status.hero.statistics.currTime+=a-(core.status.hero.statistics.start||a);core.status.hero.statistics.start=a}};control.prototype._animationFrame_autoSave=function(a){if(a-core.saves.autosave.time<=5000){return}core.control.checkAutosave();core.saves.autosave.time=a};control.prototype._animationFrame_globalAnimate=function(a){if(a-core.animateFrame.globalTime<=core.values.animateSpeed){return}core.status.globalAnimateStatus++;if(core.status.floorId){core.status.globalAnimateObjs.forEach(function(b){core.drawBlock(b,core.status.globalAnimateStatus%(b.event.animate||1))});core.maps._drawFloorImages(core.status.floorId,core.canvas.bg,"bg",core.status.floorAnimateObjs||[],core.status.globalAnimateStatus);core.maps._drawFloorImages(core.status.floorId,core.canvas.fg,"fg",core.status.floorAnimateObjs||[],core.status.globalAnimateStatus);core.status.autotileAnimateObjs.blocks.forEach(function(b){core.maps._drawAutotileAnimate(b,core.status.globalAnimateStatus)})}core.drawBoxAnimate();core.animateFrame.globalTime=a};control.prototype._animationFrame_animate=function(c){if(c-core.animateFrame.animateTime<50||!core.status.animateObjs||core.status.animateObjs.length==0){return}core.clearMap("animate");for(var a=0;a<core.status.animateObjs.length;a++){var b=core.status.animateObjs[a];if(b.index==b.animate.frames.length){(function(d){setTimeout(function(){if(d){d()}})})(b.callback)}}core.status.animateObjs=core.status.animateObjs.filter(function(d){return d.index<d.animate.frames.length});core.status.animateObjs.forEach(function(d){core.maps._drawAnimateFrame(d.animate,d.centerX,d.centerY,d.index++)});core.animateFrame.animateTime=c};control.prototype._animationFrame_heroMoving=function(a){if(core.status.heroMoving<=0){return}if(a-core.animateFrame.moveTime>(core.values.moveSpeed||100)){core.animateFrame.leftLeg=!core.animateFrame.leftLeg;core.animateFrame.moveTime=a}core.drawHero(core.animateFrame.leftLeg?"leftFoot":"rightFoot",4*core.status.heroMoving)};control.prototype._animationFrame_weather=function(a){var b=core.animateFrame.weather;if(a-b.time<=30||!core.dymCanvas.weather){return}core.control["_animationFrame_weather_"+b.type]();b.time=a};control.prototype._animationFrame_weather_rain=function(){var a=core.dymCanvas.weather,b=core.bigmap.offsetX,c=core.bigmap.offsetY;core.clearMap("weather");a.strokeStyle="rgba(174,194,224,0.8)";a.lineWidth=1;a.lineCap="round";core.animateFrame.weather.nodes.forEach(function(d){a.beginPath();a.moveTo(d.x-b,d.y-c);a.lineTo(d.x+d.l*d.xs-b,d.y+d.l*d.ys-c);a.stroke();d.x+=d.xs;d.y+=d.ys;if(d.x>core.bigmap.width*32||d.y>core.bigmap.height*32){d.x=Math.random()*core.bigmap.width*32;d.y=-10}});a.fill()};control.prototype._animationFrame_weather_snow=function(){var b=core.dymCanvas.weather,c=core.bigmap.offsetX,d=core.bigmap.offsetY;core.clearMap("weather");b.fillStyle="rgba(255, 255, 255, 0.8)";b.beginPath();core.animateFrame.weather.data=core.animateFrame.weather.data||0;core.animateFrame.weather.data+=0.01;var a=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(e){b.moveTo(e.x-c,e.y-d);b.arc(e.x-c,e.y-d,e.r,0,Math.PI*2,true);e.x+=Math.sin(a)*2;e.y+=Math.cos(a+e.d)+1+e.r/2;if(e.x>core.bigmap.width*32+5||e.x<-5||e.y>core.bigmap.height*32){if(Math.random()>1/3){e.x=Math.random()*core.bigmap.width*32;e.y=-10}else{if(Math.sin(a)>0){e.x=-5}else{e.x=core.bigmap.width*32+5}e.y=Math.random()*core.bigmap.height*32}}});b.fill()};control.prototype._animationFrame_weather_fog=function(){var a=core.dymCanvas.weather,c=core.bigmap.offsetX,d=core.bigmap.offsetY;core.clearMap("weather");if(core.animateFrame.weather.fog){var e=core.__PIXELS__,b=core.__PIXELS__;core.setAlpha("weather",0.5);core.animateFrame.weather.nodes.forEach(function(f){a.drawImage(core.animateFrame.weather.fog,f.x-c,f.y-d,e,b);f.x+=f.xs;f.y+=f.ys;if(f.x>core.bigmap.width*32-e/2){f.x=core.bigmap.width*32-e/2-1;f.xs=-f.xs}if(f.x<-e/2){f.x=-e/2+1;f.xs=-f.xs}if(f.y>core.bigmap.height*32-b/2){f.y=core.bigmap.height*32-b/2-1;f.ys=-f.ys}if(f.y<-b/2){f.y=-b/2+1;f.ys=-f.ys}});core.setAlpha("weather",1)}};control.prototype._animationFrame_parallelDo=function(a){core.control.controldata.parallelDo(a)};control.prototype._animationFrame_checkConsoleOpened=function(a){if(core.consoleOpened()){core.setFlag("__consoleOpened__",true)}};control.prototype.showStartAnimate=function(b,a){this._showStartAnimate_resetDom();if(core.flags.startUsingCanvas||b){return this._showStartAnimate_finished(core.flags.startUsingCanvas,a)}core.hideWithAnimate(core.dom.startTop,20,function(){core.control._showStartAnimate_finished(false,a)})};control.prototype._showStartAnimate_resetDom=function(){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.status.played=false;core.clearStatus();core.clearMap("all");core.dom.musicBtn.style.display="block";core.setMusicBtn();core.events.setVolume(1,0);core.updateStatusBar()};control.prototype._showStartAnimate_finished=function(b,a){core.dom.startTop.style.display="none";core.dom.startButtonGroup.style.display="block";main.selectedButton=null;main.selectButton(0);if(b){core.startGame()}if(a){a()}};control.prototype.hideStartAnimate=function(a){core.hideWithAnimate(core.dom.startPanel,20,a)};control.prototype.isPlaying=function(){return core.status.played};control.prototype.clearStatus=function(){for(var a in core.timeout){clearTimeout(core.timeout[a]);core.timeout[a]=null}for(var a in core.interval){clearInterval(core.interval[a]);core.interval[a]=null}core.status={};core.clearStatusBar();core.deleteAllCanvas();core.status.played=false};control.prototype._initStatistics=function(a){if(!core.isset(core.status.hero.statistics)){core.status.hero.statistics={totalTime:a,currTime:0,hp:0,battle:0,money:0,experience:0,battleDamage:0,poisonDamage:0,extraDamage:0,moveDirectly:0,ignoreSteps:0,}}};control.prototype.clearAutomaticRouteNode=function(a,b){core.clearMap("route",a*32+5-core.status.automaticRoute.offsetX,b*32+5-core.status.automaticRoute.offsetY,27,27)};control.prototype.stopAutomaticRoute=function(){if(!core.status.played){return}core.status.automaticRoute.autoHeroMove=false;core.status.automaticRoute.autoStep=0;core.status.automaticRoute.destStep=0;core.status.automaticRoute.movedStep=0;core.status.automaticRoute.autoStepRoutes=[];core.status.automaticRoute.destX=null;core.status.automaticRoute.destY=null;core.status.automaticRoute.lastDirection=null;core.status.heroStop=true;if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.deleteCanvas("route")}};control.prototype.saveAndStopAutomaticRoute=function(){var a=core.status.automaticRoute;if(a.moveStepBeforeStop.length==0){a.moveStepBeforeStop=a.autoStepRoutes.slice(a.autoStep-1);if(a.moveStepBeforeStop.length>=1){a.moveStepBeforeStop[0].step-=a.movedStep}}this.stopAutomaticRoute()};control.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;if(a.length===0||(a.length===1&&a[0].step===1)){core.status.automaticRoute.moveStepBeforeStop=[]}else{core.setAutoHeroMove(a)}};control.prototype.clearContinueAutomaticRoute=function(a){core.deleteCanvas("route");core.status.automaticRoute.moveStepBeforeStop=[];if(a){a()}};control.prototype.fillPosWithPoint=function(a){core.fillRect("ui",a.x*32+12,a.y*32+12,8,8,"#bfbfbf")};control.prototype.setAutomaticRoute=function(a,b,d){if(!core.status.played||core.status.lockControl){return}if(this._setAutomaticRoute_isMoving(a,b)){return}if(this._setAutomaticRoute_isTurning(a,b,d)){return}if(this._setAutomaticRoute_clickMoveDirectly(a,b,d)){return}var c=core.automaticRoute(a,b);if(c.length==0&&(a!=core.status.hero.loc.x||b!=core.status.hero.loc.y||d.length==0)){return}c=c.concat(d);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;this._setAutomaticRoute_drawRoute(c);this._setAutomaticRoute_setAutoSteps(c);core.setAutoHeroMove()};control.prototype._setAutomaticRoute_isMoving=function(a,b){if(core.status.automaticRoute.autoHeroMove){var c=core.status.automaticRoute.destX,d=core.status.automaticRoute.destY;core.stopAutomaticRoute();if(c==a&&d==b){core.status.automaticRoute.moveDirectly=true;setTimeout(function(){if(core.status.automaticRoute.moveDirectly&&core.status.heroMoving==0){core.control.tryMoveDirectly(a,b)}core.status.automaticRoute.moveDirectly=false},core.values.moveSpeed||100)}return true}return false};control.prototype._setAutomaticRoute_isTurning=function(a,b,c){if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&c.length==0){if(core.timeout.turnHeroTimeout==null){core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250)}else{clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null;core.getNextItem()}return true}if(core.timeout.turnHeroTimeout!=null){return true}return false};control.prototype._setAutomaticRoute_clickMoveDirectly=function(a,b,c){if(core.status.heroStop&&core.status.heroMoving==0){if(c.length<=1&&!core.hasFlag("__noClickMove__")&&core.control.tryMoveDirectly(a,b)){return true}}return false};control.prototype._setAutomaticRoute_drawRoute=function(h){var j=core.bigmap.width*32,k=core.bigmap.height*32,e=0,f=0;h.forEach(function(l){j=Math.min(j,l.x*32);e=Math.max(e,l.x*32);k=Math.min(k,l.y*32);f=Math.max(f,l.y*32)});core.status.automaticRoute.offsetX=j;core.status.automaticRoute.offsetY=k;var a=core.createCanvas("route",j-core.bigmap.offsetX,k-core.bigmap.offsetY,e-j+32,f-k+32,95);a.fillStyle="#bfbfbf";a.strokeStyle="#bfbfbf";a.lineWidth=8;for(var g=0;g<h.length;g++){if(g==h.length-1){a.fillRect(h[g].x*32+10-j,h[g].y*32+10-k,12,12)}else{a.beginPath();var c=h[g].x*32+16-j,d=h[g].y*32+16-k;var b=h[g].direction,i=h[g+1].direction;a.moveTo(c-core.utils.scan[b].x*11,d-core.utils.scan[b].y*11);a.lineTo(c,d);a.lineTo(c+core.utils.scan[i].x*11,d+core.utils.scan[i].y*11);a.stroke()}}};control.prototype._setAutomaticRoute_setAutoSteps=function(b){var c=0,a=null;b.forEach(function(e){var d=e.direction;if(a==null||a==d){c++}else{core.status.automaticRoute.autoStepRoutes.push({direction:a,step:c});c=1}a=d});core.status.automaticRoute.autoStepRoutes.push({direction:a,step:c})};control.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;if(a.length==0){return}core.status.automaticRoute.autoStepRoutes=a;core.status.automaticRoute.autoHeroMove=true;core.status.automaticRoute.autoStep=1;core.status.automaticRoute.destStep=a[0].step;core.moveHero(a[0].direction)};control.prototype.setHeroMoveInterval=function(a){if(core.status.heroMoving>0){return}if(core.status.replay.speed==24){core.moveOneStep(core.nextX(),core.nextY());if(a){a()}return}core.status.heroMoving=1;var b=1;if(core.status.replay.speed>3){b=2}if(core.status.replay.speed>6){b=4}if(core.status.replay.speed>12){b=8}core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving+=b;if(core.status.heroMoving>=8){clearInterval(core.interval.heroMoveInterval);core.status.heroMoving=0;core.moveOneStep(core.nextX(),core.nextY());if(a){a()}}},(core.values.moveSpeed||100)/8*b/core.status.replay.speed)};control.prototype.moveOneStep=function(a,b){return this.controldata.moveOneStep(a,b)};control.prototype.moveAction=function(a){if(core.status.heroMoving>0){return}var c=core.noPass(core.nextX(),core.nextY()),b=core.canMoveHero();if(c||!b){return this._moveAction_noPass(b,a)}this._moveAction_moving(a)};control.prototype._moveAction_noPass=function(b,a){core.status.route.push(core.getHeroLoc("direction"));core.status.automaticRoute.moveStepBeforeStop=[];core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(b){core.events._trigger(core.nextX(),core.nextY())}core.drawHero();if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}if(a){a()}};control.prototype._moveAction_moving=function(a){core.setHeroMoveInterval(function(){var c=core.getHeroLoc("direction");core.control._moveAction_popAutomaticRoute();core.status.route.push(c);var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");var b=core.getBlock(e,f);var d=false;if(b!=null&&b.block.event.trigger=="getItem"&&!core.floors[core.status.floorId].afterGetItem[e+","+f]){d=true;core.events._trigger(e,f)}core.checkBlock();if(!d){core.events._trigger(e,f)}core.updateStatusBar();if(core.getBgNumber()==167){core.insertAction("滑冰事件",null,null,null,true)}if(a){a()}})};control.prototype._moveAction_popAutomaticRoute=function(){var a=core.status.automaticRoute;if(a.autoHeroMove){a.movedStep++;a.lastDirection=core.getHeroLoc("direction");if(a.destStep==a.movedStep){if(a.autoStep==a.autoStepRoutes.length){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}else{a.movedStep=0;a.destStep=a.autoStepRoutes[a.autoStep].step;core.setHeroLoc("direction",a.autoStepRoutes[a.autoStep].direction);core.status.automaticRoute.autoStep++}}}};control.prototype.moveHero=function(b,a){if(core.status.heroMoving!=0){return}if(core.isset(b)){core.setHeroLoc("direction",b)}if(a){return this.moveAction(a)}this._moveHero_moving()};control.prototype._moveHero_moving=function(){core.status.heroStop=false;core.status.automaticRoute.moveDirectly=false;var a=function(){if(!core.status.heroStop){if(core.hasFlag("debug")&&core.status.ctrlDown){if(core.status.heroMoving!=0){return}var b=core.nextX(),c=core.nextY();if(b<0||b>=core.bigmap.width||c<0||c>=core.bigmap.height){return}core.status.heroMoving=-1;core.eventMoveHero([core.getHeroLoc("direction")],core.values.moveSpeed,function(){core.status.heroMoving=0;a()})}else{core.moveAction();setTimeout(a,50)}}};a()};control.prototype.isMoving=function(){return !core.status.heroStop||core.status.heroMoving>0};control.prototype.waitHeroToStop=function(a){var b=core.status.automaticRoute.lastDirection;core.stopAutomaticRoute();core.clearContinueAutomaticRoute();if(a){core.status.replay.animate=true;core.lockControl();core.status.automaticRoute.moveDirectly=false;setTimeout(function(){core.status.replay.animate=false;if(core.isset(b)){core.setHeroLoc("direction",b)}core.drawHero();a()},30)}};control.prototype.turnHero=function(a){if(a){core.setHeroLoc("direction",a);core.drawHero();core.status.route.push("turn:"+a);return}var b={up:"right",right:"down",down:"left",left:"up"};core.setHeroLoc("direction",b[core.getHeroLoc("direction")]);core.drawHero();core.status.route.push("turn")};control.prototype.moveDirectly=function(a,b,c){return this.controldata.moveDirectly(a,b,c)};control.prototype.tryMoveDirectly=function(e,f){if(this.nearHero(e,f)){return false}var a=core.maps.generateMovableArray();var h=[[e,f],[e-1,f,"right"],[e,f-1,"down"],[e,f+1,"up"],[e+1,f,"left"]];var b=core.canMoveDirectlyArray(h);for(var l=0;l<h.length;++l){var c=h[l],j=c[0],k=c[1],g=c[2];if(j<0||j>=core.bigmap.width||k<0||k>=core.bigmap.height){continue}if(g&&!core.inArray(a[j][k],g)){continue}if(b[l]<0){continue}if(core.control.moveDirectly(j,k,b[l])){if(g){core.moveHero(g,function(){})}return true}}return false};control.prototype.drawHero=function(g,d){if(!core.isPlaying()||!core.status.floorId||core.status.gameOver){return}var i=core.getHeroLoc("x"),j=core.getHeroLoc("y"),a=core.getHeroLoc("direction");g=g||"stop";d=d||0;var h=core.utils.scan[a];var b=h.x,c=h.y,e=b*d,f=c*d;core.bigmap.offsetX=core.clamp((i-core.__HALF_SIZE__)*32+e,0,32*core.bigmap.width-core.__PIXELS__);core.bigmap.offsetY=core.clamp((j-core.__HALF_SIZE__)*32+f,0,32*core.bigmap.height-core.__PIXELS__);core.clearAutomaticRouteNode(i+b,j+c);core.clearMap("hero");this._drawHero_getDrawObjs(a,i,j,g,d).forEach(function(k){core.drawImage("hero",k.img,k.heroIcon[k.status]*k.width,k.heroIcon.loc*k.height,k.width,k.height,k.posx+(32-k.width)/2,k.posy+32-k.height,k.width,k.height)});core.control.updateViewport();core.setGameCanvasTranslate("hero",0,0)};control.prototype._drawHero_getDrawObjs=function(a,g,h,f,e){var c=core.material.icons.hero,b=[],d=0;b.push({img:core.material.images.hero,width:core.material.icons.hero.width||32,height:core.material.icons.hero.height,heroIcon:c[a],posx:g*32-core.bigmap.offsetX+core.utils.scan[a].x*e,posy:h*32-core.bigmap.offsetY+core.utils.scan[a].y*e,status:f,index:d++,});(core.status.hero.followers||[]).forEach(function(i){b.push({img:core.material.images.images[i.name],width:core.material.images.images[i.name].width/4,height:core.material.images.images[i.name].height/4,heroIcon:c[i.direction],posx:32*i.x-core.bigmap.offsetX+(i.stop?0:core.utils.scan[i.direction].x*e),posy:32*i.y-core.bigmap.offsetY+(i.stop?0:core.utils.scan[i.direction].y*e),status:i.stop?"stop":f,index:d++})});return b.sort(function(i,j){return i.posy==j.posy?j.index-i.index:i.posy-j.posy})};control.prototype.setGameCanvasTranslate=function(b,d,e){var a=core.dom.gameCanvas[b];d=d*core.domStyle.scale;e=e*core.domStyle.scale;a.style.transform="translate("+d+"px,"+e+"px)";a.style.webkitTransform="translate("+d+"px,"+e+"px)";a.style.OTransform="translate("+d+"px,"+e+"px)";a.style.MozTransform="translate("+d+"px,"+e+"px)";if(main.mode==="editor"&&editor.isMobile){a.style.transform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.webkitTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.OTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)";a.style.MozTransform="translate("+(d/core.__PIXELS__*96)+"vw,"+(e/core.__PIXELS__*96)+"vw)"}};control.prototype.addGameCanvasTranslate=function(f,g){for(var c=0,a;a=core.dom.gameCanvas[c];c++){var b=a.getAttribute("id");if(b=="ui"||b=="data"){continue}var d=f,e=g;if(core.bigmap.canvas.indexOf(b)>=0){d-=core.bigmap.offsetX;e-=core.bigmap.offsetY}core.control.setGameCanvasTranslate(b,d,e)}};control.prototype.updateViewport=function(){core.bigmap.canvas.forEach(function(a){core.control.setGameCanvasTranslate(a,-core.bigmap.offsetX,-core.bigmap.offsetY)});core.relocateCanvas("route",core.status.automaticRoute.offsetX-core.bigmap.offsetX,core.status.automaticRoute.offsetY-core.bigmap.offsetY)};control.prototype.setViewport=function(c,d){core.bigmap.offsetX=core.clamp(c,0,32*core.bigmap.width-core.__PIXELS__);core.bigmap.offsetY=core.clamp(d,0,32*core.bigmap.height-core.__PIXELS__);this.updateViewport();var a=core.clamp((core.getHeroLoc("x")-core.__HALF_SIZE__)*32,0,32*core.bigmap.width-core.__PIXELS__);var b=core.clamp((core.getHeroLoc("y")-core.__HALF_SIZE__)*32,0,32*core.bigmap.height-core.__PIXELS__);core.control.setGameCanvasTranslate("hero",a-core.bigmap.offsetX,b-core.bigmap.offsetY)};control.prototype.moveViewport=function(e,f,b){f=f||core.values.moveSpeed||300;var d=0,c=(e||[]).filter(function(g){return["up","down","left","right"].indexOf(g)>=0});var a=window.setInterval(function(){if(c.length==0){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}else{if(core.control._moveViewport_moving(++d,c)){d=0}}},f/16/core.status.replay.speed);core.animateFrame.asyncId[a]=true};control.prototype._moveViewport_moving=function(d,b){var a=b[0],c=core.utils.scan[a];core.setViewport(core.bigmap.offsetX+2*c.x,core.bigmap.offsetY+2*c.y);if(d==16){b.shift();return true}return false};control.prototype.nextX=function(a){if(a==null){a=1}return core.getHeroLoc("x")+core.utils.scan[core.getHeroLoc("direction")].x*a};control.prototype.nextY=function(a){if(a==null){a=1}return core.getHeroLoc("y")+core.utils.scan[core.getHeroLoc("direction")].y*a};control.prototype.nearHero=function(b,c,a){if(a==null){a=1}return Math.abs(b-core.getHeroLoc("x"))+Math.abs(c-core.getHeroLoc("y"))<=a};control.prototype.gatherFollowers=function(){var b=core.getHeroLoc("x"),c=core.getHeroLoc("y"),a=core.getHeroLoc("direction");(core.status.hero.followers||[]).forEach(function(d){d.x=b;d.y=c;d.stop=true;d.direction=a})};control.prototype.updateFollowers=function(){(core.status.hero.followers||[]).forEach(function(c){if(!c.stop){c.x+=core.utils.scan[c.direction].x;c.y+=core.utils.scan[c.direction].y}});var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");(core.status.hero.followers||[]).forEach(function(f){f.stop=true;var d=a-f.x,e=b-f.y;for(var c in core.utils.scan){if(core.utils.scan[c].x==d&&core.utils.scan[c].y==e){f.stop=false;f.direction=c}}a=f.x;b=f.y})};control.prototype.updateCheckBlock=function(a){return this.controldata.updateCheckBlock(a)};control.prototype.checkBlock=function(){var c=core.getHeroLoc("x"),d=core.getHeroLoc("y"),b=c+","+d;var a=core.status.checkBlock.damage[b];if(a){core.status.hero.hp-=a;core.drawTip("受到"+(core.status.checkBlock.type[b]||"伤害")+a+"点");core.drawAnimate("zone",c,d);this._checkBlock_disableQuickShop();core.status.hero.statistics.extraDamage+=a;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose();return}}this._checkBlock_snipe(core.status.checkBlock.snipe[b]);this._checkBlock_ambush(core.status.checkBlock.ambush[b])};control.prototype._checkBlock_disableQuickShop=function(){if(core.flags.disableShopOnDamage){for(var a in core.status.shops){core.status.shops[a].visited=false}}};control.prototype._checkBlock_snipe=function(b){if(!b||b.length==0){return}var a=[];b.forEach(function(c){a.push({type:"move",loc:[c[0],c[1]],steps:[c[3]],time:500,keep:true,async:true})});a.push({type:"waitAsync"});core.insertAction(a)};control.prototype._checkBlock_ambush=function(b){if(!b||b.length==0){return}var a=[];b.forEach(function(c){a.push({type:"move",loc:[c[0],c[1]],steps:[c[3]],time:500,keep:false,async:true})});a.push({type:"waitAsync"});b.forEach(function(c){a.push({type:"battle",id:c[2]})});core.insertAction(a)};control.prototype.updateDamage=function(b,a){b=b||core.status.floorId;if(!core.isset(b)||core.status.gameOver){return}if(core.status.gameOver){return}var c=true;if(!core.isset(a)){a=core.canvas.damage;core.clearMap("damage");c=false}if(!core.hasItem("book")){return}core.setFont(a,"bold 11px Arial");this._updateDamage_damage(b,a);this._updateDamage_extraDamage(b,a,c)};control.prototype._updateDamage_damage=function(b,a){core.setTextAlign(a,"left");core.status.maps[b].blocks.forEach(function(c){var h=c.x,i=c.y;if(!c.disable&&c.event.cls.indexOf("enemy")==0&&c.event.displayDamage!==false){if(core.flags.displayEnemyDamage){var g=core.enemys.getDamageString(c.event.id,h,i,b);var f=g.damage,d=g.color;core.fillBoldText(a,f,32*h+1,32*(i+1)-1,d)}if(core.flags.displayCritical){var e=core.enemys.nextCriticals(c.event.id,1,h,i,b);e=core.formatBigNumber((e[0]||[])[0],true);if(e=="???"){e="?"}core.fillBoldText(a,e,32*h+1,32*(i+1)-11,"#FFFFFF")}}})};control.prototype._updateDamage_extraDamage=function(c,a,e){core.setTextAlign(a,"center");if(e){this.updateCheckBlock(c)}if(core.flags.displayExtraDamage){var f=core.floors[c].width,d=core.floors[c].height;for(var g=0;g<f;g++){for(var h=0;h<d;h++){var b=core.status.checkBlock.damage[g+","+h]||0;if(b>0){b=core.formatBigNumber(b,true);core.fillBoldText(a,b,32*g+16,32*(h+1)-14,"#FF7F00")}else{if(core.status.checkBlock.ambush[g+","+h]){core.fillBoldText(a,"!",32*g+16,32*(h+1)-14,"#FF7F00")}}}}}};control.prototype.chooseReplayFile=function(){core.readFile(function(b){if(b.name!=core.firstData.name){return alert("存档和游戏不一致！")}if(!b.route){return alert("无效的录像！")}var a=function(){core.startGame(core.flags.startUsingCanvas?"":b.hard||"",b.seed,core.decodeRoute(b.route))};if(b.version&&b.version!=core.firstData.version){core.myconfirm("游戏版本不一致！\n你仍然想播放录像吗？",a);return}a()})};control.prototype.startReplay=function(a){if(!core.isPlaying()){return}core.status.replay.replaying=true;core.status.replay.pausing=true;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.status.route.concat(a);core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("开始播放");this.replay()};control.prototype.triggerReplay=function(){if(core.status.replay.pausing){this.resumeReplay()}else{this.pauseReplay()}};control.prototype.pauseReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}core.status.replay.pausing=true;core.updateStatusBar();core.drawTip("暂停播放")};control.prototype.resumeReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.status.replay.pausing=false;core.updateStatusBar();core.drawTip("恢复播放");core.replay()};control.prototype.stepReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.replay(true)};control.prototype.speedUpReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}var b=[0.2,0.5,1,2,3,6,12,24];for(var a=b.length-2;a>=0;a--){if(b[a]<=core.status.replay.speed){core.status.replay.speed=b[a+1];break}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.speedDownReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}var b=[0.2,0.5,1,2,3,6,12,24];for(var a=1;a<=b.length;a++){if(b[a]>=core.status.replay.speed){core.status.replay.speed=b[a-1];break}}core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.setReplaySpeed=function(a){if(!core.isPlaying()||!core.isReplaying()){return}core.status.replay.speed=a;core.drawTip("x"+core.status.replay.speed+"倍")};control.prototype.stopReplay=function(a){if(!core.isPlaying()){return}if(!core.isReplaying()&&!a){return}core.status.replay.toReplay=[];core.status.replay.totalList=[];core.status.replay.replaying=false;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.steps=0;core.status.replay.save=[];core.updateStatusBar();core.drawTip("停止播放并恢复游戏")};control.prototype.rewindReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}if(core.status.replay.save.length==0){return core.drawTip("无法再回到上一个节点")}var b=core.status.replay.save,a=b.pop();core.loadData(a.data,function(){core.status.replay={replaying:true,pausing:true,animate:false,toReplay:a.replay.toReplay,totalList:a.replay.totalList,speed:a.replay.speed,steps:a.replay.steps,save:b};core.updateStatusBar();core.drawTip("成功回退到上一个节点")})};control.prototype.saveReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="save";var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};control.prototype.bookReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||(core.status.event.id&&core.status.event.id!="viewMaps")){return core.drawTip("请等待当前事件的处理结束")}if(!core.hasItem("book")){return core.drawTip("你没有怪物手册")}if(core.status.event.id=="viewMaps"){core.status.event.selection=core.status.event.data}core.lockControl();core.status.event.id="book";core.useItem("book",true)};control.prototype.viewMapReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="viewMaps";core.ui.drawMaps()};control.prototype.toolboxReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="toolbox";core.ui.drawToolbox()};control.prototype.equipboxReplay=function(){if(!core.isPlaying()||!core.isReplaying()){return}if(!core.status.replay.pausing){return core.drawTip("请先暂停录像")}if(core.isMoving()||core.status.replay.animate||core.status.event.id){return core.drawTip("请等待当前事件的处理结束")}core.lockControl();core.status.event.id="equipbox";core.ui.drawEquipbox()};control.prototype.isReplaying=function(){return(core.status.replay||{}).replaying};control.prototype.replay=function(b){if(!core.isPlaying()||!core.isReplaying()||core.status.replay.animate||core.status.event.id){return}if(core.status.replay.pausing&&!b){return}if(core.status.replay.toReplay.length==0){return this._replay_finished()}this._replay_save();var a=core.status.replay.toReplay.shift();if(this._doReplayAction(a)){return}this._replay_error(a)};control.prototype.registerReplayAction=function(b,a){this.unregisterReplayAction(b);this.replayActions.push({name:b,func:a})};control.prototype.unregisterReplayAction=function(a){this.replayActions=this.replayActions.filter(function(c){return c.name!=a})};control.prototype._doReplayAction=function(a){for(var c in this.replayActions){try{if(core.doFunc(this.replayActions[c].func,this,a)){return true}}catch(b){main.log(b);main.log("ERROR in replayActions["+this.replayActions[c].name+"]：已自动注销该项。");core.unregisterReplayAction(this.replayActions[c].name)}}return false};control.prototype._replay_finished=function(){core.status.replay.replaying=false;core.status.event.selection=0;var a="录像播放完毕，你想退出播放吗？";if(core.status.route.length!=core.status.replay.totalList.length||core.subarray(core.status.route,core.status.replay.totalList)==null){a="录像播放完毕，但记录不一致。\n请检查录像播放时的二次记录问题。\n你想退出播放吗？"}core.ui.drawConfirmBox(a,function(){core.ui.closePanel();core.stopReplay(true)},function(){core.status.replay.replaying=true;core.ui.closePanel();core.pauseReplay()})};control.prototype._replay_save=function(){core.status.replay.steps++;if(core.status.replay.steps%40==1){if(core.status.replay.save.length==30){core.status.replay.save.shift()}core.status.replay.save.push({data:core.saveData(),replay:{totalList:core.clone(core.status.replay.totalList),toReplay:core.clone(core.status.replay.toReplay),speed:core.status.replay.speed,steps:core.status.replay.steps}})}};control.prototype._replay_error=function(a){core.ui.closePanel();core.status.replay.replaying=false;var b=core.status.replay.toReplay.length;var d=core.status.replay.totalList.slice(-b-11,-b-1);var c=core.status.replay.toReplay.slice(0,10);main.log("录像文件出错，当前操作："+a);main.log("之前的10个操作是：\n"+d.toString());main.log("接下来10个操作是：\n"+c.toString());core.ui.drawConfirmBox("录像文件出错，你想回到上个节点吗？",function(){core.ui.closePanel();if(core.status.replay.save.length>0){core.status.replay.replaying=true;core.status.replay.pausing=true;core.rewindReplay()}else{core.drawTip("无法回到上一个节点");core.stopReplay(true)}},function(){core.ui.closePanel();core.stopReplay(true)})};control.prototype.__replay_getTimeout=function(){if(core.status.replay.speed==24){return 0}return 750/Math.max(1,core.status.replay.speed)};control.prototype._replayAction_move=function(a){if(["up","down","left","right"].indexOf(a)<0){return false}core.moveHero(a,function(){setTimeout(core.replay)});return true};control.prototype._replayAction_item=function(a){if(a.indexOf("item:")!=0){return false}var d=a.substring(5);if(!core.canUseItem(d)){return false}if(core.material.items[d].hideInReplay){core.useItem(d,false,core.replay);return true}var f=Object.keys(core.status.hero.items.tools).sort();var b=Object.keys(core.status.hero.items.constants).sort();var c,e=core.__SIZE__-1;if((c=f.indexOf(d))>=0){core.status.event.data={toolsPage:Math.floor(c/e)+1,constantsPage:1};c=c%e}else{if((c=b.indexOf(d))>=0){core.status.event.data={toolsPage:1,constantsPage:Math.floor(c/e)+1};c=c%e+e}}if(c<0){return false}core.ui.drawToolbox(c);setTimeout(function(){core.ui.closePanel();core.useItem(d,false,core.replay)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_equip=function(a){if(a.indexOf("equip:")!=0){return false}var b=a.substring(6);var d=Object.keys(core.status.hero.items.equips).sort();var c=d.indexOf(b),e=core.__SIZE__-1;if(c<0){return false}core.status.route.push(a);core.status.event.data={page:Math.floor(c/e)+1,selectId:null};c=c%e+e;core.ui.drawEquipbox(c);setTimeout(function(){core.ui.closePanel();core.loadEquip(b,core.replay)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_unEquip=function(a){if(a.indexOf("unEquip:")!=0){return false}var b=parseInt(a.substring(8));if(!core.isset(b)){return false}core.ui.drawEquipbox(b);core.status.route.push(a);setTimeout(function(){core.ui.closePanel();core.unloadEquip(b,core.replay)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_fly=function(a){if(a.indexOf("fly:")!=0){return false}var b=a.substring(4);var c=core.floorIds.indexOf(b);if(!core.canUseItem("fly")){return false}core.ui.drawFly(c);setTimeout(function(){if(!core.flyTo(b,core.replay)){core.control._replay_error(a)}},core.control.__replay_getTimeout());return true};control.prototype._replayAction_shop=function(a){if(a.indexOf("shop:")!=0){return false}var g=a.substring(5).split(":");var e=g[0],c=g[1].split("");if(c.length==0){return false}var d=core.status.shops[e];if(!d||!d.visited){return false}if(d.commonEvent){core.openShop(e,false);setTimeout(core.replay);return true}var b=d.choices;core.status.event.selection=parseInt(c.shift());core.events.openShop(e,false);var h=core.__HALF_SIZE__-parseInt(b.length/2)+(core.status.event.ui.offset||0);var f=setInterval(function(){if(!core.actions._clickShop(core.__HALF_SIZE__,h+core.status.event.selection)){clearInterval(f);core.control._replay_error(a);return}if(c.length==0){clearInterval(f);core.actions._clickShop(core.__HALF_SIZE__,h+b.length);core.replay();return}core.status.event.selection=parseInt(c.shift());core.events.openShop(e,false)},core.control.__replay_getTimeout());return true};control.prototype._replayAction_turn=function(a){if(a!="turn"&&a.indexOf("turn:")!=0){return false}if(a=="turn"){core.turnHero()}else{core.turnHero(a.substring(5))}setTimeout(core.replay);return true};control.prototype._replayAction_getNext=function(a){if(a!="getNext"){return false}if(!core.getNextItem()){return false}setTimeout(core.replay);return true};control.prototype._replayAction_moveDirectly=function(a){if(a.indexOf("move:")!=0){return false}while(core.status.replay.toReplay.length>0&&core.status.replay.toReplay[0].indexOf("move:")==0){core.status.route.push(a);a=core.status.replay.toReplay.shift()}var d=a.substring(5).split(":");var e=parseInt(d[0]),f=parseInt(d[1]);var b=core.getHeroLoc("x"),c=core.getHeroLoc("y");if(!core.moveDirectly(e,f)){return false}core.ui.drawArrow("ui",32*b+16-core.bigmap.offsetX,32*c+16-core.bigmap.offsetY,32*e+16-core.bigmap.offsetX,32*f+16-core.bigmap.offsetY,"#FF0000",3);setTimeout(function(){core.clearMap("ui");core.replay()},core.control.__replay_getTimeout());return true};control.prototype._replayAction_key=function(a){if(a.indexOf("key:")!=0){return false}core.actions.keyUp(parseInt(a.substring(4)),false,true);setTimeout(core.replay);return true};control.prototype.autosave=function(a){var b=null;if(a){b=core.status.route.pop();core.status.route.push("turn:"+core.getHeroLoc("direction"))}if(core.status.event.id=="action"){core.setFlag("__events__",core.clone(core.status.event.data))}core.saves.autosave.data=core.saveData();core.saves.autosave.updated=true;core.saves.ids[0]=true;core.removeFlag("__events__");if(a){core.status.route.pop();if(b){core.status.route.push(b)}}};control.prototype.checkAutosave=function(){if(!core.animateFrame||!core.saves||!core.saves.autosave){return}core.setLocalStorage("totalTime",core.animateFrame.totalTime);if(core.saves.autosave.data==null||!core.saves.autosave.updated){return}core.saves.autosave.updated=false;core.setLocalForage("autoSave",core.saves.autosave.data)};control.prototype.doSL=function(a,b){switch(b){case"save":this._doSL_save(a);break;case"load":this._doSL_load(a,this._doSL_load_afterGet);break;case"replayLoad":this._doSL_load(a,this._doSL_replayLoad_afterGet);break;case"replayRemain":this._doSL_load(a,this._doSL_replayRemain_afterGet);break}};control.prototype._doSL_save=function(a){if(a=="autoSave"){return core.drawTip("不能覆盖自动存档！")}if(core.status.event.interval!=null){core.setFlag("__events__",core.status.event.interval)}core.setLocalForage("save"+a,core.saveData(),function(){core.saves.saveIndex=a;core.setLocalStorage("saveIndex",core.saves.saveIndex);if(!core.events.recoverEvents(core.status.event.interval)){core.ui.closePanel()}core.drawTip("存档成功！")},function(b){main.log(b);if(core.platform.useLocalForage){alert("存档失败，错误信息：\n"+b)}else{alert("存档失败，错误信息：\n"+b+"\n建议使用垃圾存档清理工具进行清理！")}});core.removeFlag("__events__");return};control.prototype._doSL_load=function(b,a){if(b=="autoSave"&&core.saves.autosave.data!=null){a(b,core.clone(core.saves.autosave.data))}else{core.getLocalForage(b=="autoSave"?b:"save"+b,null,function(c){if(b=="autoSave"){core.saves.autosave.data=core.clone(c)}a(b,c)},function(c){main.log(c);alert("无效的存档")})}return};control.prototype._doSL_load_afterGet=function(c,b){if(!b){return alert("无效的存档")}var a=function(){core.startGame(b.hard,b.hero.flags.__seed__,core.decodeRoute(b.route))};if(core.flags.checkConsole&&b.hashCode!=null&&b.hashCode!=core.hashCode(b.hero)){core.myconfirm("存档校验失败，请勿修改存档文件！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。",a);return}if(b.version!=core.firstData.version){core.myconfirm("存档版本不匹配！\n你想回放此存档的录像吗？\n可以随时停止录像播放以继续游戏。",a);return}core.ui.closePanel();core.loadData(b,function(){core.drawTip("读档成功");if(c!="autoSave"){core.saves.saveIndex=c;core.setLocalStorage("saveIndex",core.saves.saveIndex)}})};control.prototype._doSL_replayLoad_afterGet=function(b,a){if(!a){return core.drawTip("无效的存档")}if(a.version!=core.firstData.version){return core.drawTip("存档版本不匹配")}if(a.hard!=core.status.hard){core.drawTip("游戏难度不匹配！")}if(a.hashCode!=null&&a.hashCode!=core.utils.hashCode(a.hero)){return alert("存档校验失败，请勿修改存档文件！")}var c=core.subarray(core.status.route,core.decodeRoute(a.route));if(c==null||a.hero.flags.__seed__!=core.getFlag("__seed__")){return core.drawTip("无法从此存档回放录像")}core.loadData(a,function(){core.startReplay(c);core.drawTip("回退到存档节点")})};control.prototype._doSL_replayRemain_afterGet=function(b,a){if(!a){return core.drawTip("无效的存档")}var d=core.decodeRoute(a.route);if(core.status.tempRoute){var c=core.subarray(d,core.status.tempRoute);if(c==null){return alert("无法接续播放录像！\n该存档必须是前一个选择的存档的后续内容。")}delete core.status.tempRoute;core.ui.closePanel();core.startReplay(c);core.drawTip("接续播放录像");return}else{if(a.floorId!=core.status.floorId||a.hero.loc.x!=core.getHeroLoc("x")||a.hero.loc.y!=core.getHeroLoc("y")){return alert("楼层或坐标不一致！")}}core.status.tempRoute=d;core.ui.closePanel();core.drawText("\t[步骤2]请选择第二个存档。\n\r[yellow]该存档必须是前一个存档的后续。\r\n将尝试播放到此存档。",function(){core.status.event.id="replayRemain";core.lockControl();var g=core.saves.saveIndex;var f=parseInt((g-1)/5),e=g-5*f;core.ui.drawSLPanel(10*f+e)})};control.prototype.syncSave=function(b){core.ui.drawWaiting("正在同步，请稍后...");var a=function(c){core.control._syncSave_http(b,c)};if(b=="all"){core.getAllSaves(a)}else{core.getSave(core.saves.saveIndex,a)}};control.prototype._syncSave_http=function(c,b){if(!b){return core.drawText("没有要同步的存档")}var a=new FormData();a.append("type","save");a.append("name",core.firstData.name);a.append("data",JSON.stringify(b));core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);if(e.code<0){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+e.msg)}else{core.drawText((c=="all"?"所有存档":"存档"+core.saves.saveIndex)+"同步成功！\n\n您的存档编号： "+e.code+"\n您的存档密码： "+e.msg+"\n\n请牢记以上两个信息（如截图等），在从服务器\n同步存档时使用。\n\r[yellow]另外请注意，存档同步只会保存一个月的时间。\r")}},function(d){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+d)})};control.prototype.syncLoad=function(){core.myprompt("请输入存档编号",null,function(a){if(!a){return core.ui.drawSyncSave()}core.myprompt("请输入存档密码：",null,function(b){if(!b){return core.ui.drawSyncSave()}core.ui.drawWaiting("正在同步，请稍后...");core.control._syncLoad_http(a,b)})})};control.prototype._syncLoad_http=function(b,c){var a=new FormData();a.append("type","load");a.append("name",core.firstData.name);a.append("id",b);a.append("password",c);core.http("POST","/games/sync.php",a,function(d){var e=JSON.parse(d);if(e.code==0){core.control._syncLoad_write(JSON.parse(e.msg))}else{core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+e.msg)}},function(d){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+d)})};control.prototype._syncLoad_write=function(a){if(a instanceof Array){core.status.event.selection=1;core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var b=1;b<=5*(main.savePages||30);b++){if(b<=a.length){core.setLocalForage("save"+b,a[b-1])}else{if(core.saves.ids[b]){core.removeLocalForage("save"+b)}}}core.ui.closePanel();core.drawText("同步成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{core.setLocalForage("save"+core.saves.saveIndex,a,function(){core.drawText("同步成功！\n单存档已覆盖至存档"+core.saves.saveIndex)})}};control.prototype.saveData=function(){return this.controldata.saveData()};control.prototype.loadData=function(b,a){return this.controldata.loadData(b,a)};control.prototype.getSave=function(b,a){if(b==0){if(core.saves.autosave.data!=null){a(core.clone(core.saves.autosave.data))}else{core.getLocalForage("autoSave",null,function(c){a(c)},function(c){main.log(c);a(null)})}return}core.getLocalForage("save"+b,null,function(c){if(a){a(c)}},function(c){main.log(c);if(a){a(null)}})};control.prototype.getSaves=function(e,a){if(!(e instanceof Array)){return this.getSave(e,a)}var b=e.length,c={};for(var d=0;d<e.length;++d){(function(f){core.getSave(e[f],function(g){c[f]=g;if(Object.keys(c).length==b){a(c)}})})(d)}};control.prototype.getAllSaves=function(a){var b=Object.keys(core.saves.ids).filter(function(d){return d!=0}).sort(function(d,e){return d-e}),c=[];this.getSaves(b,function(d){for(var e=0;e<b.length;++e){if(d[e]!=null){c.push(d[e])}}a(c)})};control.prototype.getSaveIndexes=function(a){var b={};if(core.platform.useLocalForage){localforage.iterate(function(e,c,d){core.control._getSaveIndexes_getIndex(b,c)},function(){a(b)})}else{Object.keys(localStorage).forEach(function(c){core.control._getSaveIndexes_getIndex(b,c)});a(b)}};control.prototype._getSaveIndexes_getIndex=function(b,c){var a=new RegExp("^"+core.firstData.name+"_(save\\d+|autoSave)$").exec(c);if(a){if(a[1]=="autoSave"){b[0]=true}else{b[parseInt(a[1].substring(4))]=true}}};control.prototype.hasSave=function(a){return core.saves.ids[a]||false};control.prototype.removeSave=function(b,a){if(b==0||b=="autoSave"){b="autoSave";core.removeLocalForage(b,function(){core.saves.autosave.data=null;core.saves.autosave.updated=false;if(a){a()}});return}core.removeLocalForage("save"+b,function(){core.saves.favorite=core.saves.favorite.filter(function(c){return core.hasSave(c)});delete core.saves.favoriteName[b];core.control._updateFavoriteSaves();if(a){a()}},function(){core.drawTip("无法删除存档！");if(a){a()}})};control.prototype._loadFavoriteSaves=function(){core.saves.favorite=core.getLocalStorage("favorite",[]);core.saves.favorite=core.saves.favorite.filter(function(a){return core.hasSave(a)});core.saves.favoriteName=core.getLocalStorage("favoriteName",{})};control.prototype._updateFavoriteSaves=function(){core.setLocalStorage("favorite",core.saves.favorite);core.setLocalStorage("favoriteName",core.saves.favoriteName)};control.prototype.setStatus=function(a,b){if(!core.status.hero){return}if(a=="exp"){a="experience"}if(a=="x"||a=="y"||a=="direction"){this.setHeroLoc(a,b)}else{core.status.hero[a]=b}};control.prototype.addStatus=function(a,b){this.setStatus(a,this.getStatus(a)+b)};control.prototype.getStatus=function(a){if(!core.status.hero){return null}if(a=="x"||a=="y"||a=="direction"){return this.getHeroLoc(a)}if(a=="exp"){a="experience"}return core.status.hero[a]};control.prototype.getStatusOrDefault=function(b,a){if(b&&a in b){return Math.floor(b[a])}return Math.floor(this.getStatus(a))};control.prototype.getRealStatus=function(a){return this.getRealStatusOrDefault(null,a)};control.prototype.getRealStatusOrDefault=function(b,a){return Math.floor(this.getStatusOrDefault(b,a)*this.getBuff(a))};control.prototype.setBuff=function(a,b){this.setFlag("__"+a+"_buff__",b)};control.prototype.addBuff=function(a,b){this.setFlag("__"+a+"_buff__",this.getBuff(a)+b)};control.prototype.getBuff=function(a){return core.getFlag("__"+a+"_buff__",1)};control.prototype.setHeroLoc=function(a,c,b){if(!core.status.hero){return}core.status.hero.loc[a]=c;if((a=="x"||a=="y")&&!b){this.gatherFollowers()}};control.prototype.getHeroLoc=function(a){if(!core.status.hero){return}if(a==null){return core.status.hero.loc}return core.status.hero.loc[a]};control.prototype.getStatusName=function(b){var a={name:"名称",lv:"等级",hpmax:"生命上限",hp:"生命",manamax:"魔力上限",mana:"魔力",atk:"攻击",def:"防御",mdef:"魔防",money:"金币",exp:"经验",experience:"经验",steps:"步数"};return a[b]||b};control.prototype.getLvName=function(a){if(!core.status.hero){return null}if(a==null){a=core.status.hero.lv}return((core.firstData.levelUp||[])[a-1]||{}).title||a};control.prototype.setFlag=function(a,b){if(b==null){return this.removeFlag(a)}if(!core.status.hero){return}core.status.hero.flags[a]=b};control.prototype.addFlag=function(a,b){if(!core.status.hero){return}core.setFlag(a,core.getFlag(a,0)+b)};control.prototype.getFlag=function(b,a){if(!core.status.hero){return a}var c=core.status.hero.flags[b];return c!=null?c:a};control.prototype.hasFlag=function(a){return !!core.getFlag(a)};control.prototype.removeFlag=function(a){if(!core.status.hero){return}delete core.status.hero.flags[a]};control.prototype.lockControl=function(){core.status.lockControl=true};control.prototype.unLockControl=function(){core.status.lockControl=false};control.prototype.debug=function(){core.setFlag("debug",true);core.drawText("\t[调试模式开启]此模式下按住Ctrl键（或Ctrl+Shift键）可以穿墙并忽略一切事件。\n此模式下将无法上传成绩。")};control.prototype.getMappedName=function(a){return(main.nameMap||{})[a]||a};control.prototype.setWeather=function(b,a){if(b==null){core.deleteCanvas("weather");core.animateFrame.weather.type=null;core.animateFrame.weather.nodes=[];return}if(b==core.animateFrame.weather.type&&a==null){return}a=core.clamp(parseInt(a)||5,1,10);a*=parseInt(20*core.bigmap.width*core.bigmap.height/(core.__SIZE__*core.__SIZE__));core.createCanvas("weather",0,0,core.__PIXELS__,core.__PIXELS__,80);core.animateFrame.weather.type=b;core.animateFrame.weather.nodes=[];this._setWeather_createNodes(b,a)};control.prototype._setWeather_createNodes=function(d,c){switch(d){case"rain":for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32,y:Math.random()*core.bigmap.height*32,l:Math.random()*2.5,xs:-4+Math.random()*4+2,ys:Math.random()*10+10})}break;case"snow":for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32,y:Math.random()*core.bigmap.height*32,r:Math.random()*5+1,d:Math.random()*Math.min(c,200),})}break;case"fog":if(core.animateFrame.weather.fog){for(var b=0;b<c/10;b++){core.animateFrame.weather.nodes.push({x:Math.random()*core.bigmap.width*32-208,y:Math.random()*core.bigmap.height*32-208,xs:Math.random()*4-2,ys:Math.random()*4-2})}}break}};control.prototype.setCurtain=function(b,c,a){if(c==null){c=750}if(c<=0){c=0}if(!core.status.curtainColor){core.status.curtainColor=[0,0,0,0]}if(!b){b=[0,0,0,0]}if(b[3]==null){b[3]=1}b[3]=core.clamp(b[3],0,1);if(c==0){core.clearMap("curtain");core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(b));core.status.curtainColor=b;if(a){a()}return}this._setCurtain_animate(core.status.curtainColor,b,c,a)};control.prototype._setCurtain_animate=function(d,c,g,b){g/=Math.max(core.status.replay.speed,1);var e=10,f=parseInt(g/e);var a=setInterval(function(){d=[(d[0]*(f-1)+c[0])/f,(d[1]*(f-1)+c[1])/f,(d[2]*(f-1)+c[2])/f,(d[3]*(f-1)+c[3])/f,];core.clearMap("curtain");core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(d));f--;if(f<=0){delete core.animateFrame.asyncId[a];clearInterval(a);core.status.curtainColor=c;if(core.isset(b)){b()}}},e);core.animateFrame.asyncId[a]=true};control.prototype.screenFlash=function(b,d,e,a){e=e||1;d=d/3;var c=core.clone(core.status.curtainColor);core.setCurtain(b,d,function(){core.setCurtain(c,d*2,function(){if(e>1){core.screenFlash(b,d*3,e-1,a)}else{if(a){a()}}})})};control.prototype.playBgm=function(a,c){a=core.getMappedName(a);if(main.mode!="play"||!core.material.bgms[a]){return}if(!core.musicStatus.bgmStatus){try{core.musicStatus.playingBgm=a;core.musicStatus.lastBgm=a;core.material.bgms[a].pause()}catch(b){main.log(b)}return}this.setMusicBtn();try{this._playBgm_play(a,c)}catch(b){console.log("无法播放BGM "+a);main.log(b);core.musicStatus.playingBgm=null}};control.prototype._playBgm_play=function(a,b){if(core.musicStatus.playingBgm==a&&!core.material.bgms[core.musicStatus.playingBgm].paused){return}if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].pause()}core.loader.loadBgm(a);core.material.bgms[a].volume=core.musicStatus.volume;core.material.bgms[a].currentTime=b||0;core.material.bgms[a].play();core.musicStatus.playingBgm=a;core.musicStatus.lastBgm=a};control.prototype.pauseBgm=function(){if(main.mode!="play"){return}try{if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].pause();core.musicStatus.playingBgm=null}}catch(a){console.log("无法暂停BGM");main.log(a)}this.setMusicBtn()};control.prototype.resumeBgm=function(){if(main.mode!="play"){return}try{core.playBgm(core.musicStatus.playingBgm||core.musicStatus.lastBgm||main.startBgm)}catch(a){console.log("无法恢复BGM");main.log(a)}this.setMusicBtn()};control.prototype.setMusicBtn=function(){if(core.musicStatus.bgmStatus){core.dom.musicBtn.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAABWVBMVEX///9iYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmL///8AAAC5ubn+/v6xsbEtLS0MDAxmZmZoaGhvb2/c3Nzd3d38/Pz9/f0oKCgpKSl0dHR1dXW6urrb29v7+/v09PTv7+/39/cgICACAgImJibh4eGFhYWGhoaHh4eOjo5paWm7u7vDw8PMzMwyMjI7OztAQEDe3t5FRUVMTEzj4+Pl5eXm5ubp6enr6+tcXFzi4uL19fVeXl74+PgjIyNkZGQGBgaSkpKYmJiampqenp4DAwMwMDBnZ2cICAivr68eHh63t7cLCwsSEhLw8PBhYWEUFBQVFRXNzc3Pz8/Z2dna2toaGhqkpKSlpaWpqamrq6tFOUNAAAAAc3RSTlMAAwQFBhUWGxwkJSYyO0dISVBRUmpvj5CSk5SVoaOlpqiysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyA0IuUgAAAVdJREFUeF5NkVVbw0AQRTcQrLR4IIEGcidJoaUuQHF3d3d3+P/CkuxCzss8nG++mbnDBJXhNt2CpbeFK1kQpSEKidlc8S9qdATRa6UIdQMoxEpDA0Ov3wUAPfW+qLWACydNv9zMrzkJwPK6FB3oHyOfXfuNxvoBQ+GmBYinhHB77TmiVBxoYUw1AYcEq332AS8OYKosAuTT0nza9uU2USYPRJgGxEiSOFywJ3mNARozgBJJzkfLvfu8JgGDWcC9FEsjWzR+y80gYDEAA8QZ3N6kmP1Fs3fEASB7pob7Hh+Wz5L0ci17Or05J7bH6B6dZv05XWK3rG+myV05Ert592Qo55sPuoIr7hEZHHtieIPWy0RU9DLwc3Mnck/vi8/E8XNrDWQtEVnL/ySKMrv0jPwPp870fprcyYifmiEmqGpHkI5q9ofSFIUk2qiwIGpEMyxYhhZRRcMPz89RJ2s9W8wAAAAASUVORK5CYII="}else{core.dom.musicBtn.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAABYlBMVEX///9iYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmL////8/PwAAABmZmZoaGihoaGioqKxsbG5ubnb29vc3Nzd3d3h4eHi4uL9/f3+/v4tLS1nZ2d0dHSUlJSenp66uroMDAz7+/spKSkoKCgUFBRpaWkVFRVvb291dXU7OzuVlZWYmJhkZGQgICAjIyOkpKQCAgK3t7cGBgbv7++pqamrq6seHh4mJiZhYWGamprp6enr6+saGhpeXl7j4+Pl5eXm5uZKSkrw8PD09PT19fW7u7vDw8PMzMwICAgwMDAyMjILCwtAQECGhoaHh4eBgYGFhYUSEhJXV1dZWVlcXFyOjo6SkpLNzc339/fPz8/Z2dna2tqTk5OlpaWxOPeTAAAAdnRSTlMAAwQFBhUWGxwkJSYyO0dISVBRUmpvj5CSk5SVoaOlpqiysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKyNuo+uwAAAWJJREFUeF5NkmV34zAQReUm7WbTuJBNunY3bvXGDjNTkZkZlpn5/9eR5FPfbzr3jGb0RkwRiMQMDm7EIgHmRxtLwMOaHHoQjwz4MUKeCM8AWMrmd7u7f/aXAMyOShHiQD1n04DtN5e5FMBFlSauIsm585dKi4CpuSYKJIv1tBDVmvOSqJgEoowFLSBHaQh10XHWiCgHWEGmAw2blPrvOK/KRJUGoLM4kCVSKrWz7HwgoiwQZyaQJ0+9PvxV23BNATAZB25IqX9b3+jTW9fcApwB6NLgUD5NY3mPXnwmFwBezff1ztzRFzTp94FXMy36HDuCa2RafdnnmZqtL818Gl9/qNnEeyrUk2aTPiKj3qMyWBVi/YSuWq5qiwxkbtX3vYWzdz/l8M0k8ERlvViiB1Ygslb7SbVtJezncj+Cx5bYaeGuonZqhZlieAp+no74/s5EAh6JcY35Cepxk4ObcT3IJPe/1lKsDpFCFQAAAABJRU5ErkJggg=="}};control.prototype.triggerBgm=function(){if(main.mode!="play"){return}core.musicStatus.bgmStatus=!core.musicStatus.bgmStatus;if(core.musicStatus.bgmStatus){this.resumeBgm()}else{this.pauseBgm()}core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus)};control.prototype.playSound=function(c){c=core.getMappedName(c);if(main.mode!="play"||!core.musicStatus.soundStatus||!core.material.sounds[c]){return}try{if(core.musicStatus.audioContext!=null){var d=core.musicStatus.audioContext.createBufferSource();d.buffer=core.material.sounds[c];d.connect(core.musicStatus.gainNode);var b=setTimeout(null);d.onended=function(){delete core.musicStatus.playingSounds[b]};if(d.start){d.start(0)}else{if(d.noteOn){d.noteOn(0)}}core.musicStatus.playingSounds[b]=d}else{core.material.sounds[c].volume=core.musicStatus.volume;core.material.sounds[c].play()}}catch(a){console.log("无法播放SE "+c);main.log(a)}};control.prototype.stopSound=function(){for(var b in core.musicStatus.playingSounds){var c=core.musicStatus.playingSounds[b];try{if(c.stop){c.stop()}else{if(c.noteOff){c.noteOff()}}}catch(a){main.log(a)}}core.musicStatus.playingSounds={}};control.prototype.checkBgm=function(){core.playBgm(core.musicStatus.playingBgm||main.startBgm)};control.prototype.clearStatusBar=function(){Object.keys(core.statusBar).forEach(function(a){if(core.statusBar[a].innerHTML!=null){core.statusBar[a].innerHTML="&nbsp;"}});core.statusBar.image.book.style.opacity=0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.style.opacity=0.3}};control.prototype.updateStatusBar=function(){if(!core.isPlaying()){return}this.controldata.updateStatusBar();this._updateStatusBar_setToolboxIcon()};control.prototype._updateStatusBar_setToolboxIcon=function(){if(core.isReplaying()){core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.src=core.statusBar.icons.stop.src;core.statusBar.image.fly.style.opacity=1;core.statusBar.image.toolbox.src=core.statusBar.icons.rewind.src;core.statusBar.image.keyboard.src=core.statusBar.icons.book.src;core.statusBar.image.shop.src=core.statusBar.icons.floor.src;core.statusBar.image.save.src=core.statusBar.icons.speedDown.src;core.statusBar.image.load.src=core.statusBar.icons.speedUp.src;core.statusBar.image.settings.src=core.statusBar.icons.save.src}else{core.statusBar.image.book.src=core.statusBar.icons.book.src;core.statusBar.image.book.style.opacity=core.hasItem("book")?1:0.3;if(!core.flags.equipboxButton){core.statusBar.image.fly.src=core.statusBar.icons.fly.src;core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:0.3}else{core.statusBar.image.fly.src=core.statusBar.icons.equipbox.src;core.statusBar.image.fly.style.opacity=1}core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src;core.statusBar.image.keyboard.src=core.statusBar.icons.keyboard.src;core.statusBar.image.shop.src=core.statusBar.icons.shop.src;core.statusBar.image.save.src=core.statusBar.icons.save.src;core.statusBar.image.load.src=core.statusBar.icons.load.src;core.statusBar.image.settings.src=core.statusBar.icons.settings.src}};control.prototype.showStatusBar=function(){if(main.mode=="editor"){return}if(core.domStyle.showStatusBar){return}var b=core.dom.status;core.domStyle.showStatusBar=true;core.removeFlag("hideStatusBar");for(var a=0;a<b.length;++a){b[a].style.opacity=1}this.setToolbarButton(false);core.dom.tools.hard.style.display="block"};control.prototype.hideStatusBar=function(b){if(main.mode=="editor"){return}if(!core.domStyle.showStatusBar){this.showStatusBar()}var c=core.dom.status,d=core.dom.tools;core.domStyle.showStatusBar=false;core.setFlag("hideStatusBar",true);core.setFlag("showToolbox",b||null);for(var a=0;a<c.length;++a){c[a].style.opacity=0}if(!core.domStyle.isVertical||!b){for(var a=0;a<d.length;++a){d[a].style.display="none"}}};control.prototype.updateHeroIcon=function(f){f=f||"hero.png";if(core.statusBar.icons.name==f){return}core.statusBar.icons.name=f;var d=core.material.images.hero;var i=core.material.icons.hero.width||32;var c=core.material.icons.hero.height||48;var g=Math.max(i/c,1),j=32*g,e=16-j/2;var a=document.createElement("canvas");var b=a.getContext("2d");a.width=32;a.height=32;b.drawImage(d,0,0,i,c,e,0,j,32);core.statusBar.image.name.src=a.toDataURL("image/png")};control.prototype.updateGlobalAttribute=function(d){if(d==null){d=Object.keys(core.status.globalAttribute)}if(d instanceof Array){d.forEach(function(f){core.control.updateGlobalAttribute(f)});return}var a=core.status.globalAttribute||core.initStatus.globalAttribute;if(a==null){return}switch(d){case"statusLeftBackground":if(!core.domStyle.isVertical){core.dom.statusBar.style.background=a[d]}break;case"statusTopBackground":if(core.domStyle.isVertical){core.dom.statusBar.style.background=a[d]}break;case"toolsBackground":if(core.domStyle.isVertical){core.dom.toolBar.style.background=a[d]}break;case"borderColor":var b="3px "+a[d]+" solid";core.dom.statusBar.style.borderTop=b;core.dom.statusBar.style.borderLeft=b;core.dom.statusBar.style.borderRight=core.domStyle.isVertical?b:"";core.dom.statusBar.style.borderBottom=core.domStyle.isVertical?"":b;core.dom.gameDraw.style.border=b;core.dom.toolBar.style.borderLeft=b;core.dom.toolBar.style.borderRight=core.domStyle.isVertical?b:"";core.dom.toolBar.style.borderBottom=core.domStyle.isVertical?b:"";break;case"statusBarColor":var e=core.dom.statusTexts;for(var c=0;c<e.length;c++){e[c].style.color=a[d]}break;case"hardLabelColor":core.dom.hard.style.color=a[d];break;case"floorChangingBackground":core.dom.floorMsgGroup.style.background=a[d];break;case"floorChangingTextColor":core.dom.floorMsgGroup.style.color=a[d];break}};control.prototype.setToolbarButton=function(b){if(!core.domStyle.showStatusBar){if(!core.domStyle.isVertical){for(var a=0;a<core.dom.tools.length;++a){core.dom.tools[a].style.display="none"}return}if(!core.hasFlag("showToolbox")){return}else{core.dom.tools.hard.style.display="block"}}if(b==null){b=core.domStyle.toolbarBtn}if(!core.domStyle.isVertical){b=false}core.domStyle.toolbarBtn=b;if(b){["book","fly","toolbox","keyboard","shop","save","load","settings"].forEach(function(c){core.statusBar.image[c].style.display="none"});["btn1","btn2","btn3","btn4","btn5","btn6","btn7","btn8"].forEach(function(c){core.statusBar.image[c].style.display="block"})}else{["btn1","btn2","btn3","btn4","btn5","btn6","btn7","btn8"].forEach(function(c){core.statusBar.image[c].style.display="none"});["book","fly","toolbox","save","load","settings"].forEach(function(c){core.statusBar.image[c].style.display="block"});core.statusBar.image.keyboard.style.display=core.statusBar.image.shop.style.display=core.domStyle.isVertical?"block":"none"}};control.prototype._shouldDisplayStatus=function(c){if(c==null){var f=[],e=core.dom.status;for(var b=0;b<e.length;++b){var a=core.dom.status[b],d=a.id;if(d.indexOf("Col")!=d.length-3){continue}var c=d.substring(0,d.length-3);if(!this._shouldDisplayStatus(c)){continue}f.push(c)}return f}switch(c){case"floor":return core.flags.enableFloor;case"name":return core.flags.enableName;case"lv":return core.flags.enableLv;case"hpmax":return core.flags.enableHPMax;case"mana":return core.flags.enableMana;case"mdef":return core.flags.enableMDef;case"money":return core.flags.enableMoney;case"experience":return core.flags.enableExperience&&!core.flags.levelUpLeftMode;case"up":return core.flags.enableLevelUp;case"skill":return core.flags.enableSkill;case"key":return core.flags.enableKeys;case"pzf":return core.flags.enablePZF;case"debuff":return core.flags.enableDebuff;default:return true}};control.prototype.registerResize=function(b,a){this.unregisterResize(b);this.resizes.push({name:b,func:a})};control.prototype.unregisterResize=function(a){this.resizes=this.resizes.filter(function(c){return c.name!=a})};control.prototype._doResize=function(c){for(var b in this.resizes){try{if(core.doFunc(this.resizes[b].func,this,c)){return true}}catch(a){main.log(a);main.log("ERROR in resizes["+this.resizes[b].name+"]：已自动注销该项。");this.unregisterResize(this.resizes[b].name)}}return false};control.prototype.resize=function(){if(main.mode=="editor"){return}var d=main.dom.body.clientWidth,c=main.dom.body.clientHeight;var b=core.__PIXELS__+6,a=Math.round(core.__PIXELS__*0.31)+3;if(d>=b+a||(d>c&&c<b)){core.domStyle.isVertical=false;core.domStyle.scale=Math.min(1,c/b)}else{core.domStyle.isVertical=true;core.domStyle.scale=Math.min(1,d/b)}var k=this._shouldDisplayStatus(),f=k.length;var i=core.flags.statusCanvas,j=core.flags.statusCanvasRowsOnMobile||3;var e=i?j:Math.ceil(f/3);if(e>4){if(i){alert("自绘状态栏的在竖屏下的行数应不超过4！")}else{alert("当前状态栏数目("+f+")大于12，请调整到不超过12以避免手机端出现显示问题。")}}var g=core.status.globalAttribute||core.initStatus.globalAttribute;var h={clientWidth:d,clientHeight:c,CANVAS_WIDTH:b,BAR_WIDTH:a,outerSize:b*core.domStyle.scale,globalAttribute:g,border:"3px "+g.borderColor+" solid",statusDisplayArr:k,count:f,col:e,statusBarHeightInVertical:core.domStyle.isVertical?(32*e+6)*core.domStyle.scale+6:0,toolbarHeightInVertical:core.domStyle.isVertical?44*core.domStyle.scale+6:0,is15x15:core.__SIZE__==15};this._doResize(h);this.setToolbarButton();core.updateStatusBar()};control.prototype._resize_gameGroup=function(c){var b=core.dom.gameGroup;var e,d;if(core.domStyle.isVertical){e=c.outerSize;d=c.outerSize+c.statusBarHeightInVertical+c.toolbarHeightInVertical}else{e=(c.CANVAS_WIDTH+c.BAR_WIDTH)*core.domStyle.scale;d=c.outerSize}b.style.width=e+"px";b.style.height=d+"px";b.style.left=(c.clientWidth-e)/2+"px";b.style.top=(c.clientHeight-d)/2+"px";var a=core.dom.floorMsgGroup;a.style.width=c.outerSize-6+"px";a.style.height=d-6+"px";a.style.background=c.globalAttribute.floorChangingBackground;a.style.color=c.globalAttribute.floorChangingTextColor;if(core.domStyle.isVertical||core.domStyle.scale<1){core.dom.musicBtn.style.right=core.dom.musicBtn.style.bottom="3px"}else{core.dom.musicBtn.style.right=(c.clientWidth-e)/2+"px";core.dom.musicBtn.style.bottom=(c.clientHeight-d)/2-27+"px"}};control.prototype._resize_canvas=function(f){var d=(f.outerSize-6)+"px";for(var c=0;c<core.dom.gameCanvas.length;++c){core.dom.gameCanvas[c].style.width=core.dom.gameCanvas[c].style.height=d}core.dom.gif.style.width=core.dom.gif.style.height=d;core.dom.gif2.style.width=core.dom.gif2.style.height=d;core.dom.gameDraw.style.width=core.dom.gameDraw.style.height=d;core.dom.gameDraw.style.top=f.statusBarHeightInVertical+"px";core.dom.gameDraw.style.right=0;core.dom.gameDraw.style.border=f.border;core.bigmap.canvas.forEach(function(g){core.canvas[g].canvas.style.width=core.bigmap.width*32*core.domStyle.scale+"px";core.canvas[g].canvas.style.height=core.bigmap.height*32*core.domStyle.scale+"px"});for(var e in core.dymCanvas){var b=core.dymCanvas[e],a=b.canvas;a.style.width=a.width*core.domStyle.scale+"px";a.style.height=a.height*core.domStyle.scale+"px";a.style.left=parseFloat(a.getAttribute("_left"))*core.domStyle.scale+"px";a.style.top=parseFloat(a.getAttribute("_top"))*core.domStyle.scale+"px"}main.dom.next.style.width=main.dom.next.style.height=5*core.domStyle.scale+"px";main.dom.next.style.borderBottomWidth=main.dom.next.style.borderRightWidth=4*core.domStyle.scale+"px"};control.prototype._resize_statusBar=function(a){var b=core.dom.statusBar;if(core.domStyle.isVertical){b.style.width=a.outerSize+"px";b.style.height=a.statusBarHeightInVertical+"px";b.style.background=a.globalAttribute.statusTopBackground;b.style.fontSize=16*core.domStyle.scale+"px"}else{b.style.width=a.BAR_WIDTH*core.domStyle.scale+"px";b.style.height=a.outerSize+"px";b.style.background=a.globalAttribute.statusLeftBackground;b.style.fontSize=16*Math.min(1,(core.__HALF_SIZE__+3)/a.count)*core.domStyle.scale+"px"}b.style.display="block";b.style.borderTop=b.style.borderLeft=a.border;b.style.borderRight=core.domStyle.isVertical?a.border:"";b.style.borderBottom=core.domStyle.isVertical?"":a.border;if(core.domStyle.isVertical){core.dom.statusCanvas.style.width=a.outerSize-6+"px";core.dom.statusCanvas.width=core.__PIXELS__;core.dom.statusCanvas.style.height=a.statusBarHeightInVertical-3+"px";core.dom.statusCanvas.height=a.col*32+9}else{core.dom.statusCanvas.style.width=a.BAR_WIDTH*core.domStyle.scale-3+"px";core.dom.statusCanvas.width=a.BAR_WIDTH-3;core.dom.statusCanvas.style.height=a.outerSize-6+"px";core.dom.statusCanvas.height=core.__PIXELS__}core.dom.statusCanvas.style.display=core.flags.statusCanvas?"block":"none"};control.prototype._resize_status=function(c){var d=(core.domStyle.isVertical?1:(core.__HALF_SIZE__+3)/c.count)*32*core.domStyle.scale*0.8;for(var a=0;a<core.dom.status.length;++a){var b=core.dom.status[a].id,e=core.dom.status[a].style;if(b.endsWith("Col")){b=b.substring(0,b.length-3)}e.display=core.flags.statusCanvas||c.statusDisplayArr.indexOf(b)<0?"none":"block";e.margin=3*core.domStyle.scale+"px";e.height=d+"px";e.maxWidth=c.BAR_WIDTH*core.domStyle.scale*(core.domStyle.isVertical?0.95:1)+"px";if(c.is15x15&&!core.domStyle.isVertical){e.marginLeft=11*core.domStyle.scale+"px"}}for(var a=0;a<core.dom.statusLabels.length;++a){core.dom.statusLabels[a].style.lineHeight=d+"px";core.dom.statusLabels[a].style.marginLeft=6*core.domStyle.scale+"px"}for(var a=0;a<core.dom.statusTexts.length;++a){core.dom.statusTexts[a].style.color=c.globalAttribute.statusBarColor}};control.prototype._resize_toolBar=function(a){var b=core.dom.toolBar;if(core.domStyle.isVertical){b.style.width=a.outerSize+"px";b.style.top=a.statusBarHeightInVertical+a.outerSize+"px";b.style.height=a.toolbarHeightInVertical+"px";b.style.background=a.globalAttribute.toolsBackground}else{b.style.width=a.BAR_WIDTH*core.domStyle.scale+"px";b.style.top=0.718*a.outerSize+"px";b.style.height=0.281*a.outerSize+"px";b.style.background="transparent"}b.style.display="block";b.style.borderLeft=a.border;b.style.borderRight=b.style.borderBottom=core.domStyle.isVertical?a.border:"";b.style.fontSize=16*core.domStyle.scale+"px"};control.prototype._resize_tools=function(b){var d=32*core.domStyle.scale*(core.domStyle.isVertical&&!b.is15x15?0.95:1);var e;if(core.domStyle.isVertical){e=(core.__HALF_SIZE__-3)*3*core.domStyle.scale}else{e=(b.BAR_WIDTH*core.domStyle.scale-9-d*3)/4}for(var a=0;a<core.dom.tools.length;++a){var c=core.dom.tools[a].style;c.height=d+"px";c.marginLeft=e+"px";c.marginTop=6*core.domStyle.scale+"px"}core.dom.hard.style.lineHeight=d+"px";core.dom.hard.style.color=b.globalAttribute.hardLabelColor;if(core.domStyle.isVertical){core.dom.hard.style.width=b.outerSize-9*e-8.5*d-12+"px"}else{core.dom.hard.style.width=b.BAR_WIDTH*core.domStyle.scale-9-2*e+"px";if(!b.is15x15){core.dom.hard.style.marginTop=0}}};"use strict";function utils(){this._init();this.scan={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}}}utils.prototype._init=function(){if(typeof Object.assign!="function"){Object.assign=function(d,f){if(d==null){throw new TypeError("Cannot convert undefined or null to object")}var e=Object(d);for(var a=1;a<arguments.length;a++){var c=arguments[a];if(c!=null){for(var b in c){if(Object.prototype.hasOwnProperty.call(c,b)){e[b]=c[b]}}}}return e}}if(typeof String.prototype.endsWith!="function"){String.prototype.endsWith=function(a,b){if(b===undefined||b>this.length){b=this.length}return this.substring(b-a.length,b)===a}}};utils.prototype.replaceText=function(b,a,c){return b.replace(/\${(.*?)}/g,function(e,d){return core.calValue(d,null,a,c)})};utils.prototype.calValue=function(value,prefix,need,times){if(!core.isset(value)){return null}if(typeof value==="string"){value=value.replace(/status:([a-zA-Z0-9_]+)/g,"core.getStatus('$1')");value=value.replace(/item:([a-zA-Z0-9_]+)/g,"core.itemCount('$1')");value=value.replace(/flag:([a-zA-Z0-9_\u4E00-\u9FCC]+)/g,"core.getFlag('$1', 0)");value=value.replace(/switch:([a-zA-Z0-9_]+)/g,"core.getFlag('"+(prefix||":f@x@y")+"@$1', 0)");value=value.replace(/global:([a-zA-Z0-9_\u4E00-\u9FCC]+)/g,"core.getGlobal('$1', 0)");return eval(value)}if(value instanceof Function){return value()}return value};utils.prototype.unshift=function(c,d){if(!(c instanceof Array)||d==null){return}if(d instanceof Array){core.clone(d).reverse().forEach(function(a){c.unshift(a)})}else{c.unshift(d)}return c};utils.prototype.push=function(c,d){if(!(c instanceof Array)||d==null){return}if(d instanceof Array){core.clone(d).forEach(function(a){c.push(a)})}else{c.push(d)}return c};utils.prototype.decompress=function(c){try{var b=lzw_decode(c);if(b){return JSON.parse(b)}}catch(a){}try{var b=LZString.decompress(c);if(b){return JSON.parse(b)}}catch(a){}try{return JSON.parse(c)}catch(a){main.log(a)}return null};utils.prototype.setLocalStorage=function(c,f){try{if(f==null){this.removeLocalStorage(c);return}var d=JSON.stringify(f).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)});var a=lzw_encode(d);localStorage.setItem("__tmp__",a);if(lzw_decode(localStorage.getItem("__tmp__"))==d){localStorage.setItem(core.firstData.name+"_"+c,a)}else{localStorage.setItem(core.firstData.name+"_"+c,d)}localStorage.removeItem("__tmp__");if(c=="autoSave"){core.saves.ids[0]=true}else{if(/^save\d+$/.test(c)){core.saves.ids[parseInt(c.substring(4))]=true}}return true}catch(b){main.log(b);return false}};utils.prototype.getLocalStorage=function(b,a){var c=this.decompress(localStorage.getItem(core.firstData.name+"_"+b));return c==null?a:c};utils.prototype.removeLocalStorage=function(a){localStorage.removeItem(core.firstData.name+"_"+a);if(a=="autoSave"){delete core.saves.ids[0]}else{if(/^save\d+$/.test(a)){delete core.saves.ids[parseInt(a.substring(4))]}}};utils.prototype.setLocalForage=function(c,e,d,b){if(!core.platform.useLocalForage){if(this.setLocalStorage(c,e)){if(d){d()}}else{if(b){b()}}return}if(e==null){this.removeLocalForage(c);return}var a=lzw_encode(JSON.stringify(e).replace(/[\u007F-\uFFFF]/g,function(f){return"\\u"+("0000"+f.charCodeAt(0).toString(16)).substr(-4)}));localforage.setItem(core.firstData.name+"_"+c,a,function(f){if(f){if(b){b(f)}}else{if(c=="autoSave"){core.saves.ids[0]=true}else{if(/^save\d+$/.test(c)){core.saves.ids[parseInt(c.substring(4))]=true}}if(d){d()}}})};utils.prototype.getLocalForage=function(c,a,d,b){if(!core.platform.useLocalForage){var e=this.getLocalStorage(c,a);if(d){d(e)}return}localforage.getItem(core.firstData.name+"_"+c,function(f,h){if(f){if(b){b(f)}}else{if(!d){return}if(h!=null){var g=core.utils.decompress(h);d(g==null?a:g);return}d(a)}})};utils.prototype.removeLocalForage=function(b,c,a){if(!core.platform.useLocalForage){this.removeLocalStorage(b);if(c){c()}return}localforage.removeItem(core.firstData.name+"_"+b,function(d){if(d){if(a){a(d)}}else{if(b=="autoSave"){delete core.saves.ids[0]}else{if(/^save\d+$/.test(b)){delete core.saves.ids[parseInt(b.substring(4))]}}if(c){c()}}})};utils.prototype.setGlobal=function(a,b){if(core.isReplaying()){return}core.setLocalStorage(a,b)};utils.prototype.getGlobal=function(c,b){var d;if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("input2:")==0){d=JSON.parse(core.decodeBase64(a.substring(7)))}else{core.control._replay_error(a);return core.getLocalStorage(c,b)}}else{d=core.getLocalStorage(c,b)}core.status.route.push("input2:"+core.encodeBase64(JSON.stringify(d)));return d};utils.prototype.clone=function(b,c,e){if(!core.isset(b)){return null}if(b instanceof Date){var a=new Date();a.setTime(b.getTime());return a}if(b instanceof Array){var a=[];for(var d in b){if(!c||c(d,b[d])){a[d]=core.clone(b[d],e?c:null,e)}}return a}if(b instanceof Function){return b}if(b instanceof Object){var a={};for(var d in b){if(b.hasOwnProperty(d)&&(!c||c(d,b[d]))){a[d]=core.clone(b[d],e?c:null,e)}}return a}return b};utils.prototype.splitImage=function(g,n,e){if(typeof g=="string"){g=core.getMappedName(g);g=core.material.images.images[g]}if(!g){return[]}n=n||32;e=e||n;var b=document.createElement("canvas");var c=b.getContext("2d");var a=[];for(var l=0;l<g.height;l+=e){for(var f=0;f<g.width;f+=n){var m=Math.min(n,g.width-f),d=Math.min(e,g.height-l);b.width=m;b.height=d;c.drawImage(g,f,l,m,d,0,0,m,d);var k=new Image();k.src=b.toDataURL("image/png");a.push(k)}}return a};utils.prototype.formatDate=function(a){if(!a){a=new Date()}return""+a.getFullYear()+"-"+core.setTwoDigits(a.getMonth()+1)+"-"+core.setTwoDigits(a.getDate())+" "+core.setTwoDigits(a.getHours())+":"+core.setTwoDigits(a.getMinutes())+":"+core.setTwoDigits(a.getSeconds())};utils.prototype.formatDate2=function(a){if(!a){a=new Date()}return""+a.getFullYear()+core.setTwoDigits(a.getMonth()+1)+core.setTwoDigits(a.getDate())+core.setTwoDigits(a.getHours())+core.setTwoDigits(a.getMinutes())+core.setTwoDigits(a.getSeconds())};utils.prototype.formatTime=function(a){return core.setTwoDigits(parseInt(a/3600000))+":"+core.setTwoDigits(parseInt(a/60000)%60)+":"+core.setTwoDigits(parseInt(a/1000)%60)};utils.prototype.setTwoDigits=function(a){return parseInt(a)<10?"0"+a:a};utils.prototype.formatBigNumber=function(h,f){h=Math.floor(parseFloat(h));if(!core.isset(h)){return"???"}var b=h<0?"-":"";h=Math.abs(h);if(h<=99999||(!f&&h<=999999)){return b+h}var a=[{val:1e+20,c:"g"},{val:1e+16,c:"j"},{val:1000000000000,c:"z"},{val:100000000,c:"e"},{val:10000,c:"w"},];for(var d=0;d<a.length;d++){var e=a[d];if(f){if(h>=e.val){var g=h/e.val;return b+g.toFixed(Math.max(0,Math.floor(3-Math.log10(g+1))))+e.c}}else{if(h>=10*e.val){var g=h/e.val;return b+g.toFixed(Math.max(0,Math.floor(4-Math.log10(g+1))))+e.c}}}return b+h};utils.prototype.arrayToRGB=function(a){var d=this.clamp(parseInt(a[0]),0,255),c=this.clamp(parseInt(a[1]),0,255),b=this.clamp(parseInt(a[2]),0,255);return"#"+((1<<24)+(d<<16)+(c<<8)+b).toString(16).slice(1)};utils.prototype.arrayToRGBA=function(a){if(a[3]==null){a[3]=1}var e=this.clamp(parseInt(a[0]),0,255),d=this.clamp(parseInt(a[1]),0,255),c=this.clamp(parseInt(a[2]),0,255),b=this.clamp(parseFloat(a[3]),0,1);return"rgba("+e+","+d+","+c+","+b+")"};utils.prototype.encodeRoute=function(d){var a="",c="",b=0;d.forEach(function(e){if(e=="up"||e=="down"||e=="left"||e=="right"){if(e!=c&&b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}c=e;b++}else{if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}a+=core.utils._encodeRoute_encodeOne(e)}});if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}}return LZString.compressToBase64(a)};utils.prototype._encodeRoute_id2number=function(a){var b=core.maps.getNumberById(a);return b==0?a:b};utils.prototype._encodeRoute_encodeOne=function(a){if(a.indexOf("item:")==0){return"I"+this._encodeRoute_id2number(a.substring(5))+":"}else{if(a.indexOf("unEquip:")==0){return"u"+a.substring(8)}else{if(a.indexOf("equip:")==0){return"e"+this._encodeRoute_id2number(a.substring(6))+":"}else{if(a.indexOf("fly:")==0){return"F"+a.substring(4)+":"}else{if(a.indexOf("choices:")==0){return"C"+a.substring(8)}else{if(a.indexOf("shop:")==0){return"S"+a.substring(5)}else{if(a=="turn"){return"T"}else{if(a.indexOf("turn:")==0){return"t"+a.substring(5).substring(0,1).toUpperCase()+":"}else{if(a=="getNext"){return"G"}else{if(a.indexOf("input:")==0){return"P"+a.substring(6)}else{if(a.indexOf("input2:")==0){return"Q"+a.substring(7)+":"}else{if(a=="no"){return"N"}else{if(a.indexOf("move:")==0){return"M"+a.substring(5)}else{if(a.indexOf("key:")==0){return"K"+a.substring(4)}else{if(a.indexOf("random:")==0){return"X"+a.substring(7)}}}}}}}}}}}}}}}return"("+a+")"};utils.prototype.decodeRoute=function(c){if(!c){return c}try{var d=LZString.decompressFromBase64(c);if(d!=null&&/^[-_a-zA-Z0-9+\/=:()]*$/.test(d)){if(d!=""||c.length<8){c=d}}}catch(b){}var a={route:c,index:0,ans:[]};while(a.index<a.route.length){this._decodeRoute_decodeOne(a,a.route.charAt(a.index++))}return a.ans};utils.prototype._decodeRoute_getNumber=function(a,b){var c="";while(a.index<a.route.length&&!isNaN(a.route.charAt(a.index))){c+=a.route.charAt(a.index++)}if(c.length==0){c="1"}return b?c:parseInt(c)};utils.prototype._decodeRoute_getString=function(a){var b="";while(a.index<a.route.length&&a.route.charAt(a.index)!=":"){b+=a.route.charAt(a.index++)}a.index++;return b};utils.prototype._decodeRoute_number2id=function(b){if(/^\d+$/.test(b)){var a=core.maps.blocksInfo[b];if(a){return a.id}}return b};utils.prototype._decodeRoute_decodeOne=function(b,a){if(a=="("){var e=b.route.indexOf(")",b.index);if(e>=0){b.ans.push(b.route.substring(b.index,e));b.index=e+1;return}}var g=(a=="I"||a=="e"||a=="F"||a=="S"||a=="Q"||a=="t")?this._decodeRoute_getString(b):this._decodeRoute_getNumber(b);var f={U:"up",D:"down",L:"left",R:"right"};switch(a){case"U":case"D":case"L":case"R":for(var d=0;d<g;d++){b.ans.push(f[a])}break;case"I":b.ans.push("item:"+this._decodeRoute_number2id(g));break;case"u":b.ans.push("unEquip:"+g);break;case"e":b.ans.push("equip:"+this._decodeRoute_number2id(g));break;case"F":b.ans.push("fly:"+g);break;case"C":b.ans.push("choices:"+g);break;case"S":b.ans.push("shop:"+g+":"+this._decodeRoute_getNumber(b,true));break;case"T":b.ans.push("turn");break;case"t":b.ans.push("turn:"+f[g]);break;case"G":b.ans.push("getNext");break;case"P":b.ans.push("input:"+g);break;case"Q":b.ans.push("input2:"+g);break;case"N":b.ans.push("no");break;case"M":++b.index;b.ans.push("move:"+g+":"+this._decodeRoute_getNumber(b));break;case"K":b.ans.push("key:"+g);break;case"X":b.ans.push("random:"+g);break}};utils.prototype.isset=function(a){return a!=null&&!(typeof a=="number"&&isNaN(a))};utils.prototype.subarray=function(c,d){if(!(c instanceof Array)||!(d instanceof Array)||c.length<d.length){return null}var e=core.clone(c),f=core.clone(d);while(f.length>0){if(e.shift()!=f.shift()){return null}}return e};utils.prototype.inArray=function(a,b){return(a instanceof Array)&&a.indexOf(b)>=0};utils.prototype.clamp=function(g,c,d){var f=Math.min(c,d),e=Math.max(c,d);return Math.min(Math.max(g||0,f),e)};utils.prototype.getCookie=function(b){var a=document.cookie.match(new RegExp("(^| )"+b+"=([^;]+)"));return a?a[2]:null};utils.prototype.setStatusBarInnerHTML=function(d,f,a){if(!core.statusBar[d]){return}if(typeof f=="number"){f=this.formatBigNumber(f)}var b=/^[-a-zA-Z0-9`~!@#$%^&*()_=+\[{\]}\\|;:'",<.>\/?]*$/.test(f);var e="font-style: "+(b?"italic":"normal")+"; ";var c=this.strlen(f)||1;e+="font-size: "+Math.min(1,7/c)+"em; ";if(a){e+=a}core.statusBar[d].innerHTML="<span class='_status' style='"+e+"'>"+f+"</span>"};utils.prototype.strlen=function(d){var a=0;for(var b=0,c=d.length;b<c;b++){a+=d.charCodeAt(b)<256?1:2}return a};utils.prototype.reverseDirection=function(a){a=a||core.getHeroLoc("direction");return{left:"right",right:"left",down:"up",up:"down"}[a]||a};utils.prototype.matchWildcard=function(a,b){return new RegExp("^"+a.split(/\*+/).map(function(c){return c.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}).join(".*")+"$").test(b)};utils.prototype.encodeBase64=function(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(b,c){return String.fromCharCode(parseInt(c,16))}))};utils.prototype.decodeBase64=function(a){return decodeURIComponent(atob(a).split("").map(function(b){return"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)}).join(""))};utils.prototype.convertBase=function(f,b,h){var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ~`!@#$%^&*()_-+={}[]\\|:;<>,.?/";if(b==h){return f}var d=f.length,a="";var g=[];for(var c=0;c<d;c++){g[c]=e.indexOf(f.charAt(c))}g[d]=0;while(d>0){for(var c=d;c>=1;c--){g[c-1]+=g[c]%h*b;g[c]=parseInt(g[c]/h)}a+=e.charAt(g[0]%h);g[0]=parseInt(g[0]/h);while(d>0&&g[d-1]==0){d--}}return a};utils.prototype.rand=function(b){var c=core.getFlag("__rand__");c=this.__next_rand(c);core.setFlag("__rand__",c);var a=c/2147483647;if(b&&b>0){return Math.floor(a*b)}return a};utils.prototype.rand2=function(b){b=b||2147483648;var c;if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("random:")==0){c=parseInt(a.substring(7))}else{core.control._replay_error(a);return 0}}else{c=Math.floor(Math.random()*b)}core.status.route.push("random:"+c);return c};utils.prototype.__init_seed=function(){var a=new Date().getTime()%34834795+3534;a=this.__next_rand(a);a=this.__next_rand(a);a=this.__next_rand(a);core.setFlag("__seed__",a);core.setFlag("__rand__",a)};utils.prototype.__next_rand=function(a){a=(a%127773)*16807-~~(a/127773)*2836;a+=a<0?2147483647:0;return a};utils.prototype.readFile=function(c,a,b){core.platform.successCallback=c;core.platform.errorCallback=a;if(window.jsinterface){window.jsinterface.readFile();return}if(!core.platform.isOnline){alert("离线状态下不支持文件读取！");if(a){a()}return}if(core.platform.fileReader==null){alert("当前浏览器不支持FileReader！");if(a){a()}return}if(core.platform.fileInput==null){core.platform.fileInput=document.createElement("input");core.platform.fileInput.style.opacity=0;core.platform.fileInput.type="file";core.platform.fileInput.onchange=function(){var d=core.platform.fileInput.files;if(d.length==0){if(core.platform.errorCallback){core.platform.errorCallback()}return}if(!b){core.platform.fileReader.readAsText(core.platform.fileInput.files[0])}else{core.platform.fileReader.readAsDataURL(core.platform.fileInput.files[0])}core.platform.fileInput.value=""}}core.platform.fileInput.click()};utils.prototype.readFileContent=function(a){var c=null;if(a.slice(0,4)==="data"){if(core.platform.successCallback){core.platform.successCallback(a)}return}try{c=JSON.parse(a);if(c){if(core.platform.successCallback){core.platform.successCallback(c)}return}}catch(b){main.log(b);alert(b)}if(core.platform.errorCallback){core.platform.errorCallback()}};utils.prototype.download=function(d,b){if(window.jsinterface){window.jsinterface.download(d,b);return}if(!core.platform.isOnline){alert("离线状态下不支持下载操作！");return}if(core.platform.isIOS){if(core.copy(b)){alert("iOS平台下不支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("iOS平台下不支持下载操作！")}return}if(!core.platform.isPC){if(!core.platform.isChrome||core.platform.isQQ||core.platform.isWeChat){if(core.copy(b)){alert("移动端只有Chrome浏览器支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("该平台或浏览器暂不支持下载操作！")}return}}if(core.platform.isSafari){alert("你当前使用的是Safari浏览器，不支持直接下载文件。\n即将打开一个新窗口为应下载内容，请自行全选复制然后创建空白文件并粘贴。");var a=new Blob([b],{type:"text/plain;charset=utf-8"});var e=window.URL.createObjectURL(a);var f=window.open(e,"_blank");window.URL.revokeObjectURL(e);return}var a=new Blob([b],{type:"text/plain;charset=utf-8"});if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(a,d)}else{var e=window.URL.createObjectURL(a);var c=window.document.createElement("a");c.href=e;c.download=d;document.body.appendChild(c);c.click();document.body.removeChild(c);window.URL.revokeObjectURL(e)}};utils.prototype.copy=function(a){if(window.jsinterface){window.jsinterface.copy(a);return true}if(!core.platform.supportCopy){return false}var d=document.createElement("textarea");d.style.position="fixed";d.style.top=0;d.style.left=0;d.style.width="2em";d.style.height="2em";d.style.padding=0;d.style.border="none";d.style.outline="none";d.style.boxShadow="none";d.style.background="transparent";d.value=a;document.body.appendChild(d);d.focus();d.setSelectionRange(0,d.value.length);var c=false;try{c=document.execCommand("copy")}catch(b){c=false}document.body.removeChild(d);return c};utils.prototype.myconfirm=function(a,c,b){main.dom.inputDiv.style.display="block";main.dom.inputMessage.innerHTML=a.replace(/\n/g,"<br/>");main.dom.inputBox.style.display="none";main.dom.inputYes.blur();main.dom.inputNo.blur();core.status.holdingKeys=[];core.platform.successCallback=c;core.platform.errorCallback=b};utils.prototype.myprompt=function(b,c,a){main.dom.inputDiv.style.display="block";main.dom.inputMessage.innerHTML=b.replace(/\n/g,"<br/>");main.dom.inputBox.style.display="block";main.dom.inputBox.value=c==null?"":c;main.dom.inputYes.blur();main.dom.inputNo.blur();setTimeout(function(){main.dom.inputBox.focus()});core.status.holdingKeys=[];core.platform.successCallback=core.platform.errorCallback=a};utils.prototype.showWithAnimate=function(b,e,a){b.style.display="block";if(!e&&main.mode!="play"){b.style.opacity=1;if(a){a()}return}b.style.opacity=0;var c=0;var d=window.setInterval(function(){c+=0.03;b.style.opacity=c;if(c>1){clearInterval(d);if(a){a()}}},e)};utils.prototype.hideWithAnimate=function(c,e,a){if(!e||main.mode!="play"){c.style.display="none";if(a){a()}return}c.style.opacity=1;var d=1;var b=window.setInterval(function(){d-=0.03;c.style.opacity=d;if(d<0){c.style.display="none";clearInterval(b);if(a){a()}}},e)};utils.prototype._encodeCanvas=function(c){var g=[];var j=c.canvas.width,d=c.canvas.height;c.mozImageSmoothingEnabled=false;c.webkitImageSmoothingEnabled=false;c.msImageSmoothingEnabled=false;c.imageSmoothingEnabled=false;var f=c.getImageData(0,0,j,d);for(var e=0;e<f.data.length;e+=4){g.push(Math.sign(f.data[e+3]))}var h=0,b=0,a=[];for(var e=0;e<g.length;e++){if(g[e]!=h){a.push(b);h=g[e];b=0}b++}a.push(b);return a};utils.prototype._decodeCanvas=function(a,j,c){var h=core.bigmap.tempCanvas;h.canvas.width=j;h.canvas.height=c;h.clearRect(0,0,j,c);if(!a){return null}var b=0,g=[];a.forEach(function(l){for(var k=0;k<l;k++){g.push(b)}b=1-b});var e=h.getImageData(0,0,j,c);for(var d=0;d<e.data.length;d+=4){var f=d/4;if(g[f]){e.data[d]=255;e.data[d+3]=255}}h.putImageData(e,0,0)};utils.prototype.consoleOpened=function(){if(!core.flags.checkConsole){return false}if(window.Firebug&&window.Firebug.chrome&&window.Firebug.chrome.isInitialized){return true}if(!core.platform.isPC){return false}var a=160;var b=Math.min(window.outerWidth/window.innerWidth,window.outerHeight/window.innerHeight);return window.outerWidth-b*window.innerWidth>a||window.outerHeight-b*window.innerHeight>a};utils.prototype.hashCode=function(d){if(typeof d=="string"){var b=0,c,a;if(d.length===0){return b}for(c=0;c<d.length;c++){a=d.charCodeAt(c);b=((b<<5)-b)+a;b|=0}return b}return this.hashCode(JSON.stringify(d).split("").sort().join(""))};utils.prototype.same=function(c,d){if(c==null&&d==null){return true}if(c==null||d==null){return false}if(c===d){return true}if(c instanceof Array&&d instanceof Array){if(c.length!=d.length){return false}for(var e=0;e<c.length;e++){if(!this.same(c[e],d[e])){return false}}return true}if(c instanceof Object&&d instanceof Object){for(var e in c){if(!this.same(c[e],d[e])){return false}}for(var e in d){if(!this.same(c[e],d[e])){return false}}return true}return false};utils.prototype._export=function(b){if(!b){b=[core.status.floorId]}else{if(b=="all"){b=core.clone(core.floorIds)}else{if(typeof b=="string"){b=[b]}}}var e={};var a=b.length+"\n"+core.__SIZE__+" "+core.__SIZE__+"\n\n";b.forEach(function(h){var g=core.maps._getMapArrayFromBlocks(core.status.maps[h].blocks,core.__SIZE__,core.__SIZE__);a+=g.map(function(i){i.forEach(function(k){var j=core.maps.initBlock(null,null,k);if(j.event.cls.indexOf("enemy")==0){e[k]=j.event.id}});return i.join("\t")}).join("\n")+"\n\n"});a+=["redJewel","blueJewel","greenJewel","redPotion","bluePotion","yellowPotion","greenPotion","sword1","shield1"].map(function(g){return core.values[g]||0}).join(" ")+"\n\n";a+=Object.keys(e).length+"\n";for(var f in e){var c=e[f],d=core.material.enemys[c];a+=f+" "+d.hp+" "+d.atk+" "+d.def+" "+d.money+" "+d.special+"\n"}a+="\n0 0 0 0 0 0\n\n";a+=core.status.hero.hp+" "+core.status.hero.atk+" "+core.status.hero.def+" "+core.status.hero.mdef+" "+core.status.hero.money+" "+core.itemCount("yellowKey")+" "+core.itemCount("blueKey")+" "+core.itemCount("redKey")+" 0 "+core.status.hero.loc.x+" "+core.status.hero.loc.y+"\n";console.log(a)};utils.prototype.http=function(f,g,b,e,a,c,d){var h=new XMLHttpRequest();h.open(f,g,true);if(c){h.overrideMimeType(c)}if(d){h.responseType=d}h.onload=function(i){if(h.status==200){if(e){e(h.response)}}else{if(a){a("HTTP "+h.status)}}};h.onabort=function(){if(a){a("Abort")}};h.ontimeout=function(){if(a){a("Timeout")}};h.onerror=function(){if(a){a("Error on Connection")}};if(b){h.send(b)}else{h.send()}};function lzw_encode(h){var d={};var c=(h+"").split("");var f=[];var b;var g=c[0];var a=256;for(var e=1;e<c.length;e++){b=c[e];if(d[g+b]!=null){g+=b}else{f.push(g.length>1?d[g]:g.charCodeAt(0));d[g+b]=a;a++;g=b}}f.push(g.length>1?d[g]:g.charCodeAt(0));for(var e=0;e<f.length;e++){f[e]=String.fromCharCode(f[e])}return f.join("")}function lzw_decode(k){var e={};var d=(k+"").split("");var b=d[0];var g=b;var h=[b];var a=256;var j;for(var f=1;f<d.length;f++){var c=d[f].charCodeAt(0);if(c<256){j=d[f]}else{j=e[c]?e[c]:(g+b)}h.push(j);b=j.charAt(0);e[a]=g+b;a++;g=j}return h.join("")};"use strict";function items(){this._init()}items.prototype._init=function(){this.items=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.items;this.itemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.itemEffect;this.itemEffectTip=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.itemEffectTip;this.useItemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.useItemEffect;this.canUseItemEffect=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.canUseItemEffect;if(!items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.equipCondition){items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.equipCondition={}}this.equipCondition=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a.equipCondition};items.prototype.getItems=function(){return core.clone(this.items)};items.prototype._resetItems=function(){if(main.mode!="play"){return}if(core.flags.bigKeyIsBox){core.material.items.bigKey.cls="items";core.material.items.bigKey.name="钥匙盒"}if(core.flags.pickaxeFourDirections){core.material.items.pickaxe.text="可以破坏勇士四周的墙"}if(core.flags.bombFourDirections){core.material.items.bomb.text="可以炸掉勇士四周的怪物"}if(core.flags.snowFourDirections){core.material.items.snow.text="可以将四周的熔岩变成平地"}if(core.flags.equipment){core.material.items.sword1.cls="equips";core.material.items.sword2.cls="equips";core.material.items.sword3.cls="equips";core.material.items.sword4.cls="equips";core.material.items.sword5.cls="equips";core.material.items.shield1.cls="equips";core.material.items.shield2.cls="equips";core.material.items.shield3.cls="equips";core.material.items.shield4.cls="equips";core.material.items.shield5.cls="equips"}};items.prototype.getItemEffect=function(itemId,itemNum){var itemCls=core.material.items[itemId].cls;if(itemCls==="items"){var ratio=parseInt(core.status.thisMap.item_ratio)||1;var curr_hp=core.status.hero.hp;if(itemId in this.itemEffect){try{eval(this.itemEffect[itemId])}catch(e){main.log(e)}}core.status.hero.statistics.hp+=core.status.hero.hp-curr_hp}else{core.addItem(itemId,itemNum)}};items.prototype.getItemEffectTip=function(itemId){var itemCls=core.material.items[itemId].cls;if(itemCls==="items"){var ratio=parseInt(core.status.thisMap.item_ratio)||1;if(itemId in this.itemEffectTip){try{return eval(this.itemEffectTip[itemId])||""}catch(e){main.log(e);return""}}}return""};items.prototype.useItem=function(b,c,a){if(!this.canUseItem(b)){if(a){a()}return}this._useItemEffect(b);this._afterUseItem(b);if(!c){core.status.route.push("item:"+b)}if(a){a()}};items.prototype._useItemEffect=function(itemId){if(itemId in this.useItemEffect){try{var ratio=parseInt(core.status.thisMap.item_ratio)||1;eval(this.useItemEffect[itemId])}catch(e){main.log(e)}}};items.prototype._afterUseItem=function(b){var a=core.material.items[b].cls;if(a=="tools"){core.status.hero.items[a][b]--}if(core.status.hero.items[a][b]<=0){delete core.status.hero.items[a][b]}if(!core.status.event.id){core.status.event.data=null;core.status.event.ui=null}core.updateStatusBar()};items.prototype.canUseItem=function(itemId){if(!core.hasItem(itemId)){return false}var able=false;if(itemId in this.canUseItemEffect){try{able=eval(this.canUseItemEffect[itemId])}catch(e){main.log(e)}}if(!able){core.status.event.data=null;core.status.event.ui=null}return able};items.prototype.itemCount=function(b){if(!core.material.items[b]||!core.isPlaying()){return 0}var a=core.material.items[b].cls;if(a=="items"){return 0}return core.status.hero.items[a][b]||0};items.prototype.hasItem=function(a){return this.itemCount(a)>0};items.prototype.hasEquip=function(b){if(!(core.material.items[b]||{}).equip||!core.isPlaying()){return null}for(var a in core.status.hero.equipment){if(core.status.hero.equipment[a]==b){return true}}return false};items.prototype.getEquip=function(a){return core.status.hero.equipment[a]||null};items.prototype.setItem=function(b,c){c=c||0;var a=core.material.items[b].cls;if(a=="items"){return}core.status.hero.items[a][b]=c;if(core.status.hero.items[a][b]<=0){if(a!="keys"){delete core.status.hero.items[a][b]}else{core.status.hero.items[a][b]=0}}core.updateStatusBar()};items.prototype.addItem=function(c,d){if(d==null){d=1}var b=core.material.items[c];var a=b.cls;if(a=="items"){return}if(core.status.hero.items[a][c]==null){core.status.hero.items[a][c]=0}core.status.hero.items[a][c]+=d;if(core.status.hero.items[a][c]<=0){if(a!="keys"){delete core.status.hero.items[a][c]}else{core.status.hero.items[a][c]=0}}if(a=="constants"&&core.status.hero.items[a][c]>1){core.status.hero.items[a][c]=1}core.updateStatusBar()};items.prototype.removeItem=function(b,c){if(c==null){c=1}if(!core.hasItem(b)){return false}var a=core.material.items[b].cls;core.status.hero.items[a][b]-=c;if(core.status.hero.items[a][b]<=0){if(a!="keys"){delete core.status.hero.items[a][b]}else{core.status.hero.items[a][b]=0}}core.updateStatusBar();return true};items.prototype.getEquipTypeByName=function(b){var c=core.status.globalAttribute.equipName;for(var a=0;a<c.length;++a){if(c[a]===b&&!core.status.hero.equipment[a]){return a}}return -1};items.prototype.getEquipTypeById=function(a){var b=core.material.items[a].equip.type;if(typeof b=="string"){b=this.getEquipTypeByName(b)}return b};items.prototype.canEquip=function(equipId,hint){var equip=core.material.items[equipId]||{};if(!equip.equip){if(hint){core.drawTip("不合法的装备！")}return false}if(!core.hasItem(equipId)&&!core.hasEquip(equipId)){if(hint){core.drawTip("你当前没有"+equip.name+"，无法换装")}return false}var condition=this.equipCondition[equipId];if(condition){try{if(!eval(condition)){if(hint){core.drawTip("当前不可换上"+equip.name)}return false}}catch(e){console.log(e);return false}}return true};items.prototype.loadEquip=function(b,a){if(!this.canEquip(b,true)){if(a){a()}return}var c=core.material.items[b]||{};var d=this.getEquipTypeById(b);if(d<0){core.drawTip("当前没有"+c.equip.type+"的空位！");if(a){a()}return}this._realLoadEquip(d,b,core.status.hero.equipment[d],a)};items.prototype.unloadEquip=function(b,a){var c=core.status.hero.equipment[b];if(!c){if(a){a()}return}this._realLoadEquip(b,null,c,a)};items.prototype.compareEquipment=function(c,b){var f={};var d=core.material.items[c],g=core.material.items[b];for(var e in core.status.hero){if(typeof core.status.hero[e]=="number"){var a=0;if(d){a+=(d.equip||{})[e]||0}if(g){a-=(g.equip||{})[e]||0}if(a!=0){f[e]=a}}}return f};items.prototype._loadEquipEffect=function(a,e,b){var d=core.compareEquipment(a,e);if(b){for(var c in d){core.addBuff(c,d[c]/100)}}else{for(var c in d){core.status.hero[c]+=d[c]}}};items.prototype._realLoadEquip=function(e,c,g,a){var b=core.material.items[c]||{},f=core.material.items[g]||{};b.equip=b.equip||{};f.equip=f.equip||{};var d=b.equip.percentage,h=f.equip.percentage;if(c&&g&&(d||false)!=(h||false)){this.unloadEquip(e);this.loadEquip(c);if(a){a()}return}this._realLoadEquip_playSound();this._loadEquipEffect(c,g,d==null?h:d);if(c){core.removeItem(c)}if(g){core.addItem(g)}core.status.hero.equipment[e]=c||null;if(c){core.drawTip("已装备上"+b.name,c)}else{if(g){core.drawTip("已卸下"+f.name,g)}}if(a){a()}};items.prototype._realLoadEquip_playSound=function(){if(core.hasFlag("__quickLoadEquip__")){return}core.stopSound();core.playSound("equip.mp3")};items.prototype.quickSaveEquip=function(a){var b=core.getFlag("saveEquips",[]);b[a]=core.clone(core.status.hero.equipment);core.setFlag("saveEquips",b);core.drawTip("已保存"+a+"号套装")};items.prototype.quickLoadEquip=function(d){var a=core.getFlag("saveEquips",[])[d];if(!a){core.drawTip(d+"号套装不存在");return}var b=core.status.globalAttribute.equipName.length;for(var c=0;c<b;c++){var h=a[c];if(h&&!this.canEquip(h,true)){return}}core.setFlag("__quickLoadEquip__",true);var g=[];for(var c=0;c<b;c++){var e=core.status.hero.equipment[c];var f=a[c];if(e!=f){g.push(f||null);if(e){this.unloadEquip(c);core.status.route.push("unEquip:"+c)}}}for(var c in g){var f=g[c];if(f){this.loadEquip(f);core.status.route.push("equip:"+f)}}core.removeFlag("__quickLoadEquip__");this._realLoadEquip_playSound();core.drawTip("成功换上"+d+"号套装")};"use strict";function icons(){this._init()}icons.prototype._init=function(){this.icons=icons_4665ee12_3a1f_44a4_bea3_0fccba634dc1;this.tilesetStartOffset=10000};icons.prototype.getIcons=function(){return core.clone(this.icons)};icons.prototype.getClsFromId=function(b){for(var a in core.material.icons){if(a!="hero"&&b in core.material.icons[a]){return a}}return null};icons.prototype._getAnimateFrames=function(a,b){if(a=="enemys"||a=="npcs"){return 2}if(a=="animates"||a=="enemy48"){return 4}if(a=="npc48"){return b?4:1}return 1};icons.prototype.getTilesetOffset=function(c){if(typeof c=="string"){if(!/^X\d+$/.test(c)){return null}c=parseInt(c.substring(1))}else{if(typeof c!="number"){return null}}core.tilesets=core.tilesets||[];var f=this.tilesetStartOffset;for(var b in core.tilesets){var e=core.tilesets[b];var d=core.material.images.tilesets[e];var g=Math.floor(d.width/32),a=Math.floor(d.height/32);if(c>=f&&c<f+g*a){var h=(c-f)%g,j=parseInt((c-f)/g);return{image:e,x:h,y:j}}f+=this.tilesetStartOffset}return null};"use strict";function maps(){this._init()}maps.prototype._init=function(){this.blocksInfo=maps_90f36752_8815_4be8_b32b_d7fad1d0542e};maps.prototype._setFloorSize=function(a){if(!a){core.floorIds.forEach(function(b){core.maps._setFloorSize(b)});return}core.floors[a].width=core.floors[a].width||core.__SIZE__;core.floors[a].height=core.floors[a].height||core.__SIZE__};maps.prototype.loadFloor=function(c,d){var b=core.floors[c];if(!d){d=b.map}if(d instanceof Array){d={map:d}}var a={};var f=["firstArrive","eachArrive","parallelDo","map","bgmap","fgmap","events","changeFloor","afterBattle","afterGetItem","afterOpenDoor","cannotMove"];for(var e in b){if(f.indexOf(e)==-1&&b[e]!=null){a[e]=core.clone(b[e])}}for(var e in d){if(f.indexOf(e)==-1&&d[e]!=null){a[e]=core.clone(d[e])}}d=this.decompressMap(d.map,c);a.blocks=this._mapIntoBlocks(d,b,c);return a};maps.prototype._mapIntoBlocks=function(g,c,d){var b=[];var k=core.floors[d].width;var h=core.floors[d].height;for(var e=0;e<h;e++){for(var f=0;f<k;f++){var a=this.initBlock(f,e,(g[e]||[])[f],true,c);if(a.id!=0||a.event.trigger){b.push(a)}}}return b};maps.prototype.getNumberById=function(a){core.status.id2number=core.status.id2number||{};if(core.status.id2number[a]!=null){return core.status.id2number[a]}return core.status.id2number[a]=this._getNumberById(a)};maps.prototype._getNumberById=function(a){for(var b in this.blocksInfo){if((this.blocksInfo[b]||{}).id==a){return parseInt(b)||0}}if(/^X\d+$/.test(a)){if(core.icons.getTilesetOffset(a)){return parseInt(a.substring(1))}}if(a=="none"){return 0}if(a=="airwall"){return 17}return 0};maps.prototype.initBlock=function(g,h,f,a,e){var d=null;f=""+(f||0);if(f.endsWith(":f")){d=true}if(f.endsWith(":t")){d=false}f=parseInt(f);var b={x:g,y:h,id:f};if(d!=null){b.disable=d}if(f==17){b.event={cls:"terrains",id:"airwall",noPass:true}}else{if(f in this.blocksInfo){b.event=JSON.parse(JSON.stringify(this.blocksInfo[f]))}else{if(core.icons.getTilesetOffset(f)){b.event={cls:"tileset",id:"X"+f,noPass:true}}else{b.event={cls:"terrains",id:"none",noPass:false}}}}if(typeof b.event.noPass==="string"){b.event.noPass=JSON.parse(b.event.noPass)}if(a){this._addInfo(b)}if(e){this._addEvent(b,g,h,(e.events||{})[g+","+h]);var c=(e.changeFloor||{})[g+","+h];if(c){this._addEvent(b,g,h,{trigger:"changeFloor",data:c})}}if(main.mode=="editor"){delete b.disable}return b};maps.prototype._addInfo=function(a){if(a.event.cls.indexOf("enemy")==0&&!a.event.trigger){a.event.trigger="battle"}if(a.event.cls=="items"&&!a.event.trigger){a.event.trigger="getItem"}if(a.event.noPass==null){if(a.event.cls!="items"){a.event.noPass=true}}if(a.event.animate==null){a.event.animate=core.icons._getAnimateFrames(a.event.cls,false)}a.event.height=32;if(a.event.cls=="enemy48"||a.event.cls=="npc48"){a.event.height=48}};maps.prototype._addEvent=function(a,d,e,b){if(!b){return}if(typeof b=="string"){b={data:[b]}}else{if(b instanceof Array){b={data:b}}}b.data=b.data||[];if(a.disable==null&&b.enable!=null){a.disable=!b.enable}if(b.animate===false){a.event.animate=1}for(var c in b){if(c!="enable"&&c!="animate"&&b[c]!=null){a.event[c]=core.clone(b[c])}}if(!a.event.trigger){a.event.trigger="action"}};maps.prototype._initMaps=function(){var b=core.floorIds;var d={};for(var c=0;c<b.length;c++){var a=b[c];d[a]=this.loadFloor(a)}return d};maps.prototype._initFloorMap=function(b){var c=core.clone(core.floors[b].map);var e=core.floors[b].width;var d=core.floors[b].height;for(var f=0;f<d;f++){if(c[f]==null){c[f]=[]}for(var g=0;g<e;g++){if(c[f][g]==null){c[f][g]=0}var a=core.floors[b].events[g+","+f];if(a&&a.enable===false&&main.mode=="play"){c[f][g]+=":f"}}}return c};maps.prototype.compressMap=function(c,a){var b=this._initFloorMap(a);if(core.utils.same(c,b)){return null}var e=core.floors[a].width;var d=core.floors[a].height;for(var f=0;f<d;f++){if(core.utils.same(c[f],b[f])){c[f]=0}else{for(var g=0;g<e;g++){if(c[f][g]===b[f][g]){c[f][g]=-1}}}}return c};maps.prototype.decompressMap=function(c,a){var b=this._initFloorMap(a);if(!c){return b}var e=core.floors[a].width;var d=core.floors[a].height;for(var f=0;f<d;f++){if(c[f]===0){c[f]=b[f]}else{for(var g=0;g<e;g++){if(c[f][g]===-1){c[f][g]=b[f][g]}}}}return c};maps.prototype.saveMap=function(c){var g=core.status.maps;if(!c){var e={};for(var d in g){var h=this.saveMap(d);if(Object.keys(h).length>0){e[d]=h}}return e}var e=g[c],b=core.floors[c];var a=this._getMapArrayFromBlocks(e.blocks,b.width,b.height,true);if(main.mode=="editor"){return a}var i=this._compressFloorData(e,b);var f=this.compressMap(a,c);if(f!=null){i.map=f}return i};maps.prototype._compressFloorData=function(c,a){var e={};for(var d in c){if(d!="blocks"){var b=a[d];if(!core.utils.same(c[d],b)){e[d]=core.clone(c[d])}}}return e};maps.prototype.loadMap=function(a,b){if(!b){var c={};core.floorIds.forEach(function(d){c[d]=core.maps.loadFloor(d,a[d])});return c}return this.loadFloor(b,a[b])};maps.prototype.resizeMap=function(c){c=c||core.status.floorId;if(!c){return}core.bigmap.width=core.floors[c].width;core.bigmap.height=core.floors[c].height;var b=core.bigmap.width*32;var a=core.bigmap.height*32;core.bigmap.canvas.forEach(function(d){core.canvas[d].canvas.setAttribute("width",b);core.canvas[d].canvas.setAttribute("height",a);core.canvas[d].canvas.style.width=b*core.domStyle.scale+"px";core.canvas[d].canvas.style.height=a*core.domStyle.scale+"px";if(main.mode==="editor"&&editor.isMobile){core.canvas[d].canvas.style.width=core.bigmap.width*32/core.__PIXELS__*96+"vw";core.canvas[d].canvas.style.height=core.bigmap.height*32/core.__PIXELS__*96+"vw"}})};maps.prototype.getMapArray=function(a,b){a=a||core.status.floorId;return this._getMapArrayFromBlocks(core.status.maps[a].blocks,core.floors[a].width,core.floors[a].height,b)};maps.prototype._getMapArrayFromBlocks=function(b,g,e,f){if(typeof b=="string"){var d=b;b=core.status.maps[d].blocks;g=core.floors[d].width;e=core.floors[d].height}var c=[];var a=[];for(var i=0;i<g;i++){a.push(0)}for(var h=0;h<e;h++){c.push(core.clone(a))}b.forEach(function(j){var k=j.x,l=j.y;if(j.disable){if(f){c[l][k]=j.id+":f"}}else{c[l][k]=j.id;if(f&&j.disable===false){c[l][k]=j.id+":t"}}});return c};maps.prototype.getMapBlocksObj=function(a,c){a=a||core.status.floorId;var b={};core.status.maps[a].blocks.forEach(function(d){if(!d.disable||c){b[d.x+","+d.y]=d}});return b};maps.prototype._getBgFgMapArray=function(e,c,f){c=c||core.status.floorId;if(!c){return[]}var h=core.floors[c].width;var d=core.floors[c].height;if(!f&&core.status[e+"maps"][c]){return core.status[e+"maps"][c]}var a=core.clone(core.floors[c][e+"map"]||[]);if(main.mode=="editor"&&!(uievent&&uievent.isOpen)){a=core.clone(editor[e+"map"])||a}for(var i=0;i<h;i++){for(var j=0;j<d;j++){a[j]=a[j]||[];var b="__"+e+"Map__"+c+"_"+i+"_"+j;var g="__"+e+"Value__"+c+"_"+i+"_"+j;if(core.hasFlag(b)){a[j][i]=0}else{a[j][i]=core.getFlag(g,a[j][i]||0)}if(main.mode=="editor"){a[j][i]=a[j][i].idnum||a[j][i]||0}}}if(core.status[e+"maps"]){core.status[e+"maps"][c]=core.clone(a)}return a};maps.prototype.getBgMapArray=function(a,b){return this._getBgFgMapArray("bg",a,b)};maps.prototype.getFgMapArray=function(a,b){return this._getBgFgMapArray("fg",a,b)};maps.prototype._getBgFgNumber=function(b,d,e,a,c){if(d==null){d=core.getHeroLoc("x")}if(e==null){e=core.getHeroLoc("y")}return this._getBgFgMapArray(b,a,c)[e][d]};maps.prototype.getBgNumber=function(c,d,a,b){return this._getBgFgNumber("bg",c,d,a,b)};maps.prototype.getFgNumber=function(c,d,a,b){return this._getBgFgNumber("fg",c,d,a,b)};maps.prototype.generateMovableArray=function(f,j,k,c){f=f||core.status.floorId;if(!f){return null}var i=core.floors[f].width,h=core.floors[f].height;var b=this.getBgMapArray(f),e=this.getFgMapArray(f),d=this.getMapArray(f);var g=function(m,n,l){if(l!=null){return core.maps._canMoveHero_checkPoint(m,n,l,f,{bgArray:b,fgArray:e,eventArray:d})}return["left","down","up","right"].filter(function(o){return core.maps._canMoveHero_checkPoint(m,n,o,f,{bgArray:b,fgArray:e,eventArray:d})})};if(j!=null&&k!=null){return g(j,k,c)}var a=[];for(var j=0;j<i;j++){a[j]=[];for(var k=0;k<h;k++){a[j][k]=g(j,k)}}return a};maps.prototype.canMoveHero=function(c,d,a,b){if(c==null){c=core.getHeroLoc("x")}if(d==null){d=core.getHeroLoc("y")}a=a||core.getHeroLoc("direction");return this.generateMovableArray(b,c,d,a)};maps.prototype._canMoveHero_checkPoint=function(f,g,a,c,b){if(core.inArray((core.floors[c].cannotMove||{})[f+","+g],a)){return false}var d=f+core.utils.scan[a].x,e=g+core.utils.scan[a].y;if(d<0||e<0||d>=core.floors[c].width||e>=core.floors[c].height){return false}if(this._canMoveHero_checkCannotInOut([b.bgArray[g][f],b.fgArray[g][f],b.eventArray[g][f]],"cannotOut",a)){return false}if(this._canMoveHero_checkCannotInOut([b.bgArray[e][d],b.fgArray[e][d],b.eventArray[e][d]],"cannotIn",a)){return false}if(c==core.status.floorId&&core.status.hero.hp<=(core.status.checkBlock.damage[d+","+e]||0)&&!core.flags.canGoDeadZone&&b.eventArray[e][d]==0){return false}return true};maps.prototype._canMoveHero_checkCannotInOut=function(c,b,a){if(c instanceof Array){for(var d in c){if(this._canMoveHero_checkCannotInOut(c[d],b,a)){return true}}return false}return core.inArray((this.initBlock(0,0,c).event||{})[b],a)};maps.prototype.canMoveDirectly=function(a,b){return this.canMoveDirectlyArray([[a,b]])[0]};maps.prototype.canMoveDirectlyArray=function(e){var a=[],f=e.length;var b=core.getHeroLoc("x"),c=core.getHeroLoc("y");if(!this._canMoveDirectly_checkGlobal()){for(var d=0;d<f;++d){a.push(-1)}return a}for(var d=0;d<f;++d){if(e[d][0]==b&&e[d][1]==c){a.push(0);f--}else{if(e[d][0]<0||e[d][0]>=core.bigmap.width||e[d][1]<0||e[d][1]>=core.bigmap.height){a.push(-1);f--}else{a.push(null)}}}if(f==0){return a}if(!this._canMoveDirectly_checkStartPoint(b,c)){for(var d in a){if(a[d]==null){a[d]=-1}}return a}return this._canMoveDirectly_bfs(b,c,e,f,a)};maps.prototype._canMoveDirectly_checkGlobal=function(){if(!core.flags.enableMoveDirectly){return false}if(core.status.thisMap.cannotMoveDirectly){return false}if(core.hasFlag("cannotMoveDirectly")){return false}if(core.hasFlag("poison")){return false}return true};maps.prototype._canMoveDirectly_checkStartPoint=function(b,c){if(core.status.checkBlock.damage[b+","+c]){return false}var a=core.getBlock(b,c);if(a!=null){return a.block.event.trigger=="changeFloor"}return true};maps.prototype._canMoveDirectly_bfs=function(o,p,g,k,a){var d=this.generateMovableArray();var c=this.getMapBlocksObj(core.status.floorId);var b=this.getBgMapArray();var q=[],n=[];q[o+","+p]=0;n.push(o+","+p);while(n.length>0){var j=n.shift().split(","),r=parseInt(j[0]),s=parseInt(j[1]);for(var e in core.utils.scan){if(!core.inArray(d[r][s],e)){continue}var l=r+core.utils.scan[e].x,m=s+core.utils.scan[e].y,h=l+","+m;if(q[h]){continue}if(b[m][l]==167){continue}if(!this._canMoveDirectly_checkNextPoint(c,l,m)){continue}q[h]=q[j]+1;for(var f in a){if(g[f][0]==l&&g[f][1]==m&&a[f]==null){a[f]=q[h];k--;if(k==0){return a}}}n.push(h)}}for(var f in a){if(a[f]==null){a[f]=-1}}return a};maps.prototype._canMoveDirectly_checkNextPoint=function(a,c,d){var b=c+","+d;if(a[b]){return false}if(core.status.checkBlock.damage[c+","+d]){return false}if(core.status.checkBlock.ambush[c+","+d]){return false}return true};maps.prototype.automaticRoute=function(b,c){var h=core.getHeroLoc("x"),i=core.getHeroLoc("y");if(b==h&&c==i){return[]}var g=this._automaticRoute_bfs(h,i,b,c);if(g[b+","+c]==null){return[]}var a=[],e=b,f=c;while(e!=h||f!=i){var d=g[e+","+f];a.push({direction:d,x:e,y:f});e-=core.utils.scan[d].x;f-=core.utils.scan[d].y}a.reverse();return a};maps.prototype._automaticRoute_bfs=function(m,n,d,e){var l={},a=this.generateMovableArray();var k=new PriorityQueue({comparator:function(o,p){return o.depth-p.depth}});l[m+","+n]="";k.queue({depth:0,x:m,y:n});while(k.length!=0){var b=k.dequeue(),c=b.depth,g=b.x,h=b.y;for(var f in core.utils.scan){if(!core.inArray(a[g][h],f)){continue}var i=g+core.utils.scan[f].x;var j=h+core.utils.scan[f].y;if(i<0||i>=core.bigmap.width||j<0||j>=core.bigmap.height||l[i+","+j]!=null){continue}if(i==d&&j==e){l[i+","+j]=f;break}if(core.noPass(i,j)){continue}l[i+","+j]=f;k.queue({depth:c+this._automaticRoute_deepAdd(i,j),x:i,y:j})}if(l[d+","+e]!=null){break}}return l};maps.prototype._automaticRoute_deepAdd=function(d,e){var b=1;var a=core.getBlock(d,e);if(a!=null){var c=a.block.event.id;if(c=="light"){b+=100}if(c.endsWith("Net")){b+=100}if(!core.flags.potionWhileRouting&&c.endsWith("Potion")){b+=100}}b+=(core.status.checkBlock.damage[d+","+e]||0)*100;if(core.status.checkBlock.ambush[d+","+e]){b+=1000}return b};maps.prototype.drawBlock=function(b,a){if(b.event.id=="none"){return}var d=a!=null;if(!d){a=0}var e=b.x,f=b.y;if(d&&b.event.animate>1&&(32*e<core.bigmap.offsetX-64||32*e>core.bigmap.offsetX+core.__PIXELS__+32||32*f<core.bigmap.offsetY-64||32*f>core.bigmap.offsetY+core.__PIXELS__+32+16)){return}var c=this.getBlockInfo(b);if(c==null){return}if(c.cls!="tileset"){c.posX=a%b.event.animate}if(!b.name){this._drawBlockInfo(c,b.x,b.y)}else{this._drawBlockInfo_bgfg(c,b.name,b.x,b.y)}};maps.prototype._drawBlockInfo=function(a,f,g){var c=a.image,d=a.posX,e=a.posY,b=a.height;core.clearMap("event",f*32,g*32,32,32);core.drawImage("event",c,d*32,e*b+b-32,32,32,f*32,g*32,32,32);if(b>32){core.clearMap("event2",f*32,g*32+32-b,32,b-32);core.drawImage("event2",c,d*32,e*b,32,b-32,f*32,g*32+32-b,32,b-32)}};maps.prototype._drawBlockInfo_bgfg=function(a,d,g,h){var c=a.image,e=a.posX,f=a.posY,b=a.height;core.clearMap(d,g*32,h*32+32-b,32,b);if(d=="bg"){if(b>32){core.clearMap("bg",g*32,h*32-32,32,32);core.drawImage("bg",core.material.groundCanvas.canvas,g*32,h*32-32)}core.drawImage("bg",core.material.groundCanvas.canvas,g*32,h*32)}core.drawImage(d,c,e*32,f*b,32,b,g*32,h*32+32-b,32,b)};maps.prototype.generateGroundPattern=function(a){var b=((core.status.maps||core.floors)[a||core.status.floorId]||{}).defaultGround||"ground";core.material.groundCanvas.clearRect(0,0,32,32);core.material.groundCanvas.drawImage(core.material.images.terrains,0,32*core.material.icons.terrains[b],32,32,0,0,32,32);core.material.groundPattern=core.material.groundCanvas.createPattern(core.material.groundCanvas.canvas,"repeat")};maps.prototype.drawMap=function(b,a){b=b||core.status.floorId;if(!b){if(a){a()}return}core.clearMap("all");this.generateGroundPattern(b);core.status.floorId=b;core.status.thisMap=core.status.maps[b];this._drawMap_drawAll();if(core.status.curtainColor){core.fillRect("curtain",0,0,core.__PIXELS__,core.__PIXELS__,core.arrayToRGBA(core.status.curtainColor))}core.drawHero();core.updateStatusBar();if(a){a()}};maps.prototype._drawMap_drawAll=function(a){a=a||core.status.floorId;this.drawBg(a);this.drawEvents(a);this.drawFg(a)};maps.prototype._drawMap_drawBlockInfo=function(d,b,c,a,f){if(c==null){return}if(c.cls=="autotile"){this._drawAutotile(d,a,b,32,0,0);if(f){this.addGlobalAnimate(b)}return}if(!f){var e=c.height;core.drawImage(d,c.image,32*c.posX,e*c.posY,32,e,32*b.x,32*b.y+32-e,32,e);return}this.drawBlock(b);this.addGlobalAnimate(b)};maps.prototype.drawBg=function(b,a){b=b||core.status.floorId;var c=a==null;if(c){a=core.canvas.bg;core.clearMap(a);core.status.floorAnimateObjs=this._getFloorImages(b)}core.maps._drawBg_drawBackground(b,a);core.maps._drawFloorImages(b,a,"bg");core.maps._drawBgFgMap(b,a,"bg",c)};maps.prototype._drawBg_drawBackground=function(b,a){var g=core.floors[b].width,d=core.floors[b].height;var c=(core.status.maps||core.floors)[b].defaultGround||"ground";var h=core.material.icons.terrains[c];if(h!=null){for(var e=0;e<g;e++){for(var f=0;f<d;f++){a.drawImage(core.material.images.terrains,0,h*32,32,32,e*32,f*32,32,32)}}}};maps.prototype.drawEvents=function(d,b,c){d=d||core.status.floorId;if(!b){b=core.status.maps[d].blocks}var a=this._getMapArrayFromBlocks(b,core.floors[d].width,core.floors[d].height);var e=c==null;if(e){c=core.canvas.event}b.filter(function(f){return f.event&&!f.disable}).forEach(function(f){core.maps._drawMap_drawBlockInfo(c,f,core.maps.getBlockInfo(f),a,e)});if(e){core.status.autotileAnimateObjs.map=core.clone(a)}};maps.prototype.drawFg=function(b,a){b=b||core.status.floorId;var c=a==null;if(c){a=core.canvas.fg;core.status.floorAnimateObjs=this._getFloorImages(b)}this._drawFloorImages(b,a,"fg");this._drawBgFgMap(b,a,"fg",c)};maps.prototype._drawBgFgMap=function(h,f,j,k){h=h||core.status.floorId;if(!h){return}var l=core.floors[h].width;var i=core.floors[h].height;if(!core.status[j+"maps"]){core.status[j+"maps"]={}}var b=this._getBgFgMapArray(j,h,true);var g=null;if(main.mode=="editor"&&j=="fg"&&k){g=this.getMapArray(h)}for(var m=0;m<l;m++){for(var n=0;n<i;n++){var c=this.initBlock(m,n,b[n][m],true);c.name=j;var d=this.getBlockInfo(c);if(!d){continue}var e=false,a;if(g!=null&&g[n][m]!=0){e=true;a=f.globalAlpha;f.globalAlpha=0.6}this._drawMap_drawBlockInfo(f,c,d,b,k);if(e){f.globalAlpha=a}}}if(k){core.status.autotileAnimateObjs[j+"map"]=core.clone(b)}};maps.prototype._drawFloorImages=function(c,a,e,d,b){c=c||core.status.floorId;if(!d){d=this._getFloorImages(c)}var f=b!=null;d.forEach(function(m){if(typeof m=="string"){m=[0,0,m]}var g=parseInt(m[0]),h=parseInt(m[1]),k=m[2],i=core.clamp(parseInt(m[4]),1,8);k=core.getMappedName(k);var j=core.material.images.images[k];if(f&&i==1){return}if(core.isset(g)&&core.isset(h)&&j&&!core.hasFlag("__floorImg__"+c+"_"+g+"_"+h)){var n=parseInt(j.width/i),l=(b||0)%i*n;if(/.*\.gif/i.test(k)&&main.mode=="play"){if(f){return}this._drawFloorImages_gif(j,g,h);return}core.maps._drawFloorImage(a,e,m[3],j,l,n,g,h,f)}})};maps.prototype._getFloorImages=function(a){a=a||core.status.floorId;var b=[];if((core.status.maps||core.floors)[a].images){b=(core.status.maps||core.floors)[a].images;if(typeof b=="string"){b=[[0,0,b]]}}return b};maps.prototype._drawFloorImages_gif=function(d,a,b){core.dom.gif.innerHTML="";var c=new Image();c.src=d.src;c.style.position="absolute";c.style.left=(a*core.domStyle.scale)+"px";c.style.top=(b*core.domStyle.scale)+"px";c.style.width=d.width*core.domStyle.scale+"px";c.style.height=d.height*core.domStyle.scale+"px";core.dom.gif.appendChild(c);return};maps.prototype._drawFloorImage=function(b,g,j,f,h,k,c,d,i){var e=f.height;var a=function(){if(i){core.clearMap(b,c,d,k,e)}core.drawImage(b,f,h,0,k,e,c,d,k,e)};if(!j){if(g!="bg"){return}return a()}if(j==1){if(g!="fg"){return}return a()}if(j==2){if(g=="bg"){if(i){core.clearMap(b,c,d+e-32,k,32)}core.drawImage("bg",f,h,e-32,k,32,c,d+e-32,k,32)}else{if(g=="fg"){if(i){core.clearMap(b,c,d,k,e-32)}core.drawImage("fg",f,h,0,k,e-32,c,d,k,e-32)}}return}};maps.prototype._drawAutotile=function(b,j,a,l,h,n,m){var g=[[10,9,4,3],[10,9,4,13],[10,9,18,3],[10,9,16,15],[10,43,4,3],[10,31,4,25],[10,7,2,3],[10,31,16,5],[48,9,4,3],[8,9,4,1],[36,9,30,3],[36,9,6,15],[46,45,4,3],[46,11,4,25],[12,45,30,3],[34,33,28,27]];var o=a.x,p=a.y;var k=this._drawAutotile_getAutotileIndexs(o,p,j,g);if(k[0]==13){if(k[1]==16){k[1]=14}if(k[2]==31){k[2]=19}}if(k[1]==18){if(k[0]==15){k[0]=17}if(k[3]==36){k[3]=24}}if(k[2]==43){if(k[0]==25){k[0]=37}if(k[3]==46){k[3]=44}}if(k[3]==48){if(k[1]==30){k[1]=42}if(k[2]==45){k[2]=47}}for(var e=0;e<4;e++){var f=k[e];var c=o*l+l/2*(e%2),d=p*l+l/2*(~~(e/2));this._drawAutotile_drawBlockByIndex(b,c+h,d+n,core.material.images.autotile[a.event.id],f,l,m)}};maps.prototype._drawAutotile_drawBlockByIndex=function(b,c,d,a,e,f,g){var h=16*((e-1)%6),i=16*(~~((e-1)/6));g=g||0;g%=parseInt(a.width/96);b.drawImage(a,h+96*g,i,16,16,c,d,f/2,f/2)};maps.prototype._drawAutotile_getAutotileAroundId=function(a,c,d,b){if(c<0||d<0||c>=b[0].length||d>=b.length){return 1}else{return core.material.autotileEdges[a].indexOf(b[d][c])>=0}};maps.prototype._drawAutotile_checkAround=function(o,p,g){var d=g[p][o];var n=[];for(var e=0;e<4;e++){var c=0;var l=e%2,m=~~(e/2);for(var f=0;f<4;f++){var h=f%2,k=~~(f/2);var a=this._drawAutotile_getAutotileAroundId(d,o+l+h-1,p+m+k-1,g);c+=a*(Math.pow(2,3-f))}n.push(c)}return n};maps.prototype._drawAutotile_getAutotileIndexs=function(g,h,e,d){var c=[];var f=this._drawAutotile_checkAround(g,h,e);for(var b=0;b<4;b++){var a=d[f[b]];c.push(a[3-b])}return c};maps.prototype._drawAutotileAnimate=function(b,a){var d=b.x,e=b.y;if(32*d<core.bigmap.offsetX-64||32*d>core.bigmap.offsetX+core.__PIXELS__+32||32*e<core.bigmap.offsetY-64||32*e>core.bigmap.offsetY+core.__PIXELS__+32+16){return}var c=b.name?core.canvas[b.name]:core.canvas.event;c.clearRect(32*d,32*e,32,32);if(b.name){if(b.name=="bg"){core.drawImage("bg",core.material.groundCanvas.canvas,32*d,32*e)}this._drawAutotile(c,core.status.autotileAnimateObjs[b.name+"map"],b,32,0,0,a)}else{this._drawAutotile(c,core.status.autotileAnimateObjs.map,b,32,0,0,a)}};maps.prototype._makeAutotileEdges=function(){var a=Object.keys(core.material.images.autotile);core.material.autotileEdges={};var b=document.createElement("canvas"),c=b.getContext("2d");b.width=b.height=32;c.mozImageSmoothingEnabled=false;c.webkitImageSmoothingEnabled=false;c.msImageSmoothingEnabled=false;c.imageSmoothingEnabled=false;a.forEach(function(f){var e=core.maps.getNumberById(f);core.material.autotileEdges[e]=[e];c.clearRect(0,0,32,32);c.drawImage(core.material.images.autotile[f],0,0,32,32,0,0,32,32);var d=b.toDataURL("image/png");a.forEach(function(h){if(f==h){return}var g=core.maps.getNumberById(h);c.clearRect(0,0,32,32);c.drawImage(core.material.images.autotile[h],32,0,32,32,0,0,32,32);if(d==b.toDataURL("image/png")){core.material.autotileEdges[e].push(g)}})})};maps.prototype.drawThumbnail=function(b,a,c,d){b=b||core.status.floorId;if(!b){return}this._drawThumbnail_drawTempCanvas(b,a,c);this._drawThumbnail_drawToTarget(b,d)};maps.prototype._drawThumbnail_drawTempCanvas=function(c,a,f){a=a||core.status.maps[c].blocks;f=f||{};var j=core.floors[c].width;var e=core.floors[c].height;var g=core.bigmap.tempCanvas;var i=j*32,h=e*32;g.canvas.width=i;g.canvas.height=h;g.clearRect(0,0,i,h);var d=core.status.hero!=null,b=null;if(f.flags){if(!d){core.status.hero={}}b=core.status.hero.flags;core.status.hero.flags=f.flags}this._drawThumbnail_realDrawTempCanvas(c,a,f,g);if(!d){delete core.status.hero}else{if(b!=null){core.status.hero.flags=b}}};maps.prototype._drawThumbnail_realDrawTempCanvas=function(b,a,e,f){this.drawBg(b,f);this.drawEvents(b,a,f);if(e.heroLoc){e.heroIcon=e.heroIcon||core.getFlag("heroIcon","hero.png");e.heroIcon=core.getMappedName(e.heroIcon);var d=core.material.icons.hero[e.heroLoc.direction];var c=core.material.images.images[e.heroIcon].height/4;f.drawImage(core.material.images.images[e.heroIcon],d.stop*32,d.loc*c,32,c,32*e.heroLoc.x,32*e.heroLoc.y+32-c,32,c)}this.drawFg(b,f);if(e.damage){core.control.updateDamage(b,f)}};maps.prototype._drawThumbnail_drawToTarget=function(d,o){if(o==null){return}if(typeof o=="string"||o.canvas){o={ctx:o}}var c=core.getContextByName(o.ctx);if(c==null){return}var q=o.x||0,r=o.y||0,k=o.size||core.__PIXELS__;var p=core.floors[d].width,e=core.floors[d].height;var a=o.centerX,b=o.centerY;if(a==null){a=Math.floor(p/2)}if(b==null){b=Math.floor(e/2)}var l=core.bigmap.tempCanvas,n=32*p,m=32*e;core.clearMap(c,q,r,k,k);if(o.all){if(n<=m){var h=k,i=h*n/m;var j=(k-i)/2;core.fillRect(c,q,r,j,h,"#000000");core.fillRect(c,q+k-j,r,j,h);c.drawImage(l.canvas,0,0,n,m,q+j,r,i,h)}else{var i=k,h=i*m/n;var j=(k-h)/2;core.fillRect(c,q,r,i,j,"#000000");core.fillRect(c,q,r+k-j,i,j);c.drawImage(l.canvas,0,0,n,m,q,r+j,i,h)}}else{var f=core.clamp(a-core.__HALF_SIZE__,0,p-core.__SIZE__),g=core.clamp(b-core.__HALF_SIZE__,0,e-core.__SIZE__);c.drawImage(l.canvas,f*32,g*32,core.__PIXELS__,core.__PIXELS__,q,r,k,k)}};maps.prototype.noPass=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return a.block.event.noPass};maps.prototype.npcExists=function(c,d,b){var a=this.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls.indexOf("npc")==0};maps.prototype.terrainExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(c?a.block.event.id==c:true)};maps.prototype.stairExists=function(d,e,b){var a=this.getBlockId(d,e,b);if(a==null){return false}var c=["upFloor","downFloor"];if(core.flags.flyRecordPosition){c=c.concat(["leftPortal","rightPortal","upPortal","downPortal"])}return c.indexOf(a)>=0};maps.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return this.stairExists(a,b)||this.stairExists(a-1,b)||this.stairExists(a,b-1)||this.stairExists(a+1,b)||this.stairExists(a,b+1)};maps.prototype.enemyExists=function(d,e,c,b){var a=this.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls.indexOf("enemy")==0&&(c?a.block.event.id==c:true)};maps.prototype.getBlock=function(e,f,b,d){b=b||core.status.floorId;if(!b){return null}var a=core.status.maps[b].blocks;for(var c=0;c<a.length;c++){if(a[c].x==e&&a[c].y==f){if(!d&&a[c].disable){return null}return{index:c,block:a[c]}}}return null};maps.prototype.getBlockId=function(d,e,b,c){var a=core.getBlock(d,e,b,c);return a==null?null:a.block.event.id};maps.prototype.getBlockCls=function(d,e,b,c){var a=core.getBlock(d,e,b,c);return a==null?null:a.block.event.cls};maps.prototype.getBlockInfo=function(b){if(!b){return null}if(typeof b=="string"){b=this.getNumberById(b)}if(typeof b=="number"){if(b==0){return null}b=this.initBlock(0,0,b,true)}var i=b.id,f=b.event.id,c=b.event.cls,h=b.event.name,g=null,k=0,l=0,a=b.event.animate,e=b.event.height||32,d={};if(f=="none"){return null}else{if(f=="airwall"){if(!core.material.images.airwall){return null}g=core.material.images.airwall;h="空气墙"}else{if(c=="tileset"){var j=core.icons.getTilesetOffset(f);if(j==null){return null}k=j.x;l=j.y;g=core.material.images.tilesets[j.image]}else{if(c=="autotile"){g=core.material.images.autotile[f]}else{g=core.material.images[c];l=core.material.icons[c][f];d=b.event.faceIds||{};if(core.material.enemys[f]){h=core.material.enemys[f].name}}}}}return{number:i,id:f,cls:c,name:h,image:g,posX:k,posY:l,height:e,faceIds:d,animate:a}};maps.prototype.searchBlock=function(d,b,f){if(typeof d=="number"){d=this.initBlock(0,0,d).event.id}b=b||core.status.floorId;var e=[];if(b instanceof Array){b.forEach(function(g){e=e.concat(core.searchBlock(d,g,f))});return e}for(var c=0;c<core.status.maps[b].blocks.length;++c){var a=core.status.maps[b].blocks[c];if((f||!a.disable)&&core.matchWildcard(d,a.event.id)){e.push({floorId:b,index:c,block:a,x:a.x,y:a.y})}}return e};maps.prototype.showBlock=function(c,d,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(c,d,b,true);if(a==null){return}a=a.block;if(a.disable){a.disable=false;if(b==core.status.floorId){core.drawBlock(a);core.addGlobalAnimate(a)}core.updateStatusBar()}};maps.prototype.hideBlock=function(d,e,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(d,e,b,true);if(a==null){return}if(b==core.status.floorId){core.removeGlobalAnimate(d,e);core.clearMap("event",d*32,e*32,32,32);var c=a.block.event.height||32;if(c>32){core.clearMap("event2",d*32,e*32+32-c,32,c-32)}}a.block.disable=true;core.updateStatusBar()};maps.prototype.removeBlock=function(e,f,b){b=b||core.status.floorId;if(!b){return}var a=core.getBlock(e,f,b,true);if(a==null){return}var d=a.index;if(b==core.status.floorId){core.removeGlobalAnimate(e,f);core.clearMap("event",e*32,f*32,32,32);var c=a.block.event.height||32;if(c>32){core.clearMap("event2",e*32,f*32+32-c,32,c-32)}}core.removeBlockById(d,b);core.updateStatusBar()};maps.prototype.removeBlockById=function(d,c){c=c||core.status.floorId;if(!c){return}var b=core.status.maps[c].blocks,a=b[d];if(this.canRemoveBlock(a,c)){b.splice(d,1)}else{a.disable=true}};maps.prototype.removeBlockByIds=function(a,b){a=a||core.status.floorId;if(!a){return}b.sort(function(c,d){return d-c}).forEach(function(c){core.removeBlockById(c,a)})};maps.prototype.canRemoveBlock=function(a,b){var c=a.x,d=a.y;if(core.floors[b].events[c+","+d]||core.floors[b].changeFloor[c+","+d]){return false}if(a.event&&a.event.cls.indexOf("enemy")==0&&core.hasSpecial(a.event.id,23)){return false}return true};maps.prototype.showBgFgMap=function(d,c,b,a){this._triggerBgFgMap("show",d,c,b,a)};maps.prototype.hideBgFgMap=function(d,c,b,a){this._triggerBgFgMap("hide",d,c,b,a)};maps.prototype._triggerBgFgMap=function(e,d,c,b,a){if(e!="show"){e="hide"}if(d!="fg"){d="bg"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(!b){return}if(c.length==0){return}c.forEach(function(g){var h=g[0],i=g[1];var f="__"+d+"Map__"+b+"_"+h+"_"+i;if(e=="hide"){core.setFlag(f,true)}else{core.removeFlag(f)}});core.status[d+"maps"][b]=null;if(b==core.status.floorId){core.drawMap(b,a)}else{if(a){a()}}};maps.prototype.showFloorImage=function(c,b,a){this._triggerFloorImage("show",c,b,a)};maps.prototype.hideFloorImage=function(c,b,a){this._triggerFloorImage("hide",c,b,a)};maps.prototype._triggerFloorImage=function(d,c,b,a){if(d!="show"){d="hide"}if(typeof c[0]=="number"&&typeof c[1]=="number"){c=[c]}b=b||core.status.floorId;if(!b){return}if(c.length==0){return}c.forEach(function(f){var g=f[0],h=f[1];var e="__floorImg__"+b+"_"+g+"_"+h;if(d=="hide"){core.setFlag(e,true)}else{core.removeFlag(e)}});if(b==core.status.floorId){core.drawMap(b,a)}else{if(a){a()}}};maps.prototype.setBlock=function(d,f,g,b){b=b||core.status.floorId;if(!b||d==null||f==null||g==null){return}if(f<0||f>=core.floors[b].width||g<0||g>=core.floors[b].height){return}if(typeof d=="string"){if(/^\d+$/.test(d)){d=parseInt(d)}else{d=core.getNumberById(d)}}var a=this.initBlock(f,g,d,true,core.floors[b]);if(a.id==0&&!a.event.trigger){core.removeBlock(f,g,b);return}var e=core.getBlock(f,g,b,true);if(b==core.status.floorId){core.removeGlobalAnimate(f,g);core.clearMap("event",f*32,g*32,32,32);if(e!=null){var c=(e.block.event||{}).height||32;if(c>32){core.clearMap("event2",f*32,g*32+32-c,32,c-32)}}}if(e==null){core.status.maps[b].blocks.push(a)}else{e.block.id=d;e.block.event=a.event;a=e.block}if(b==core.status.floorId&&!a.disable){core.drawBlock(a);core.addGlobalAnimate(a);core.updateStatusBar()}};maps.prototype.replaceBlock=function(b,d,a){a=a||core.status.floorId;if(a instanceof Array){a.forEach(function(e){core.replaceBlock(b,d,e)});return}var c=this.initBlock(0,0,d,true);core.status.maps[a].blocks.forEach(function(e){if(e.id==b){e.id=d;for(var f in c.event){e.event[f]=core.clone(c.event[f])}}})};maps.prototype.setBgFgBlock=function(b,c,e,f,a){a=a||core.status.floorId;if(!a||c==null||e==null||f==null){return}if(e<0||e>=core.floors[a].width||f<0||f>=core.floors[a].height){return}if(b!="bg"&&b!="fg"){return}if(typeof c=="string"){if(/^\d+$/.test(c)){c=parseInt(c)}else{c=core.getNumberById(c)}}var d="__"+b+"Value__"+a+"_"+e+"_"+f;core.setFlag(d,c);core.status[b+"maps"][a]=null;if(a==core.status.floorId){core.drawMap(a)}};maps.prototype.resetMap=function(a){a=a||core.status.floorId;if(!a){return}if(typeof a=="string"){a=[a]}var b=false;a.forEach(function(c){core.status.maps[c]=core.maps.loadFloor(c);if(c==core.status.floorId){b=true}});if(b){this.drawMap()}core.drawTip("地图重置成功")};maps.prototype._initDetachedBlock=function(a,k,l,i){var j=null,b="__body_"+k+"_"+l,f=null;if(a.height>32){j="__head_"+k+"_"+l;core.createCanvas(j,0,0,32,a.height-32,55)}core.createCanvas(b,0,0,32,32,35);var e=null,g=null;if(a.cls.indexOf("enemy")==0&&core.hasItem("book")&&i){var h=core.enemys.getDamageString(a.id,k,l);e=h.damage;g=h.color}if(e!=null){f="__damage_"+k+"_"+l;var d=core.createCanvas(f,0,0,32,32,65);d.textAlign="left";d.font="bold 11px Arial";core.fillBoldText(d,e,1,31,g);if(core.flags.displayCritical){var c=core.enemys.nextCriticals(a.id);if(c.length>0){c=c[0]}c=core.formatBigNumber(c[0],true);if(c=="???"){c="?"}core.fillBoldText(d,c,1,21,"#FFFFFF")}}return{headCanvas:j,bodyCanvas:b,damageCanvas:f}};maps.prototype._moveDetachedBlock=function(a,h,i,j,c){var f=a.height,k=a.posX,l=a.posY,g=a.image;var e=c.headCanvas,b=c.bodyCanvas,d=c.damageCanvas;if(e){core.dymCanvas[e].clearRect(0,0,32,f);core.dymCanvas[e].drawImage(g,k*32,l*f,32,f-32,0,0,32,f-32);core.relocateCanvas(e,h-core.bigmap.offsetX,i+32-f-core.bigmap.offsetY);core.setOpacity(e,j)}if(b){core.dymCanvas[b].clearRect(0,0,32,32);core.dymCanvas[b].drawImage(g,k*32,l*f+f-32,32,32,0,0,32,32);core.relocateCanvas(b,h-core.bigmap.offsetX,i-core.bigmap.offsetY);core.setOpacity(b,j)}if(d){core.relocateCanvas(d,h-core.bigmap.offsetX,i-core.bigmap.offsetY);core.setOpacity(d,j)}};maps.prototype._deleteDetachedBlock=function(a){core.deleteCanvas(a.headCanvas);core.deleteCanvas(a.bodyCanvas);core.deleteCanvas(a.damageCanvas)};maps.prototype._getAndRemoveBlock=function(c,d){var a=core.getBlock(c,d);if(a==null){return null}a=a.block;var b=this.getBlockInfo(a);if(b==null){return}core.removeBlock(c,d);return[a,b]};maps.prototype.moveBlock=function(k,l,i,j,f,d){j=j||500;var b=this._getAndRemoveBlock(k,l);if(b==null){if(d){d()}return}var a=b[0],c=b[1];var h=(i||[]).filter(function(m){return["up","down","left","right","forward","backward"].indexOf(m)>=0});var e=this._initDetachedBlock(c,k,l,a.event.animate!==false);this._moveDetachedBlock(c,32*k,32*l,1,e);var g={x:k,y:l,px:32*k,py:32*l,opacity:1,keep:f,lastDirection:null,offset:1,moveSteps:h,step:0,per_time:j/16/core.status.replay.speed};this._moveBlock_doMove(c,e,g,d)};maps.prototype._moveBlock_doMove=function(d,f,g,e){var c=core.icons._getAnimateFrames(d.cls,true),b=0;var a=window.setInterval(function(){if(d.cls!="tileset"){b+=g.per_time;if(b>core.values.animateSpeed){b=0;d.posX=(d.posX+1)%c}}if(g.moveSteps.length!=0){core.maps._moveBlock_moving(d,f,g)}else{core.maps._moveJumpBlock_finished(d,f,g,a,e)}},g.per_time);core.animateFrame.asyncId[a]=true};maps.prototype._moveBlock_updateDirection=function(a,f){f.offset=1;var e=f.moveSteps[0];if(f.lastDirection==null){for(var c in a.faceIds){if(a.faceIds[c]==a.id){f.lastDirection=c;break}}}if(e=="forward"||e=="backward"){if(f.lastDirection==null){f.moveSteps.shift();return false}if(e=="backward"){f.offset=-1}e=f.lastDirection}f.lastDirection=f.moveSteps[0]=e;f.x+=core.utils.scan[e].x*f.offset;f.y+=core.utils.scan[e].y*f.offset;var b=a.faceIds[e];if(b){var g=core.material.icons[a.cls][b];if(g!=null){a.posY=g}}return true};maps.prototype._moveBlock_moving=function(a,b,d){if(d.step==0){if(!this._moveBlock_updateDirection(a,d)){return}}var c=d.moveSteps[0];d.step++;d.px+=core.utils.scan[c].x*2*d.offset;d.py+=core.utils.scan[c].y*2*d.offset;this._moveDetachedBlock(a,d.px,d.py,d.opacity,b);if(d.step==16){d.step=0;d.moveSteps.shift()}};maps.prototype.jumpBlock=function(j,k,f,g,l,i,d){l=l||500;var b=this._getAndRemoveBlock(j,k);if(b==null){if(d){d()}return}var a=b[0],c=b[1];var e=this._initDetachedBlock(c,j,k,a.event.animate!==false);this._moveDetachedBlock(c,32*j,32*k,1,e);core.playSound("jump.mp3");var h=this.__generateJumpInfo(j,k,f,g,l);h.keep=i;this._jumpBlock_doJump(c,e,h,d)};maps.prototype.__generateJumpInfo=function(h,i,d,e,j){var b=d-h,c=e-i,a=Math.round(Math.sqrt(b*b+c*c));var g=6+a,f=g*2;j/=Math.max(core.status.replay.speed,1);return{x:h,y:i,ex:d,ey:e,px:32*h,py:32*i,opacity:1,jump_peak:g,jump_count:f,step:0,per_time:j/f}};maps.prototype._jumpBlock_doJump=function(b,d,e,c){var a=window.setInterval(function(){if(e.jump_count>0){core.maps._jumpBlock_jumping(b,d,e)}else{core.maps._moveJumpBlock_finished(b,d,e,a,c)}},e.per_time);core.animateFrame.asyncId[a]=true};maps.prototype.__updateJumpInfo=function(b){b.jump_count--;b.x=(b.x*b.jump_count+b.ex)/(b.jump_count+1);b.y=(b.y*b.jump_count+b.ey)/(b.jump_count+1);b.px=32*b.x;var a=Math.abs(b.jump_count-b.jump_peak);b.py=32*b.y-(b.jump_peak*b.jump_peak-a*a)/2};maps.prototype._jumpBlock_jumping=function(a,b,c){this.__updateJumpInfo(c);core.maps._moveDetachedBlock(a,c.px,c.py,c.opacity,b)};maps.prototype._moveJumpBlock_finished=function(b,d,e,a,c){if(e.keep){e.opacity=0}else{e.opacity-=0.06}if(e.opacity<=0){delete core.animateFrame.asyncId[a];clearInterval(a);this._deleteDetachedBlock(d);if(e.keep){core.setBlock(b.number,e.x,e.y);core.showBlock(e.x,e.y)}if(c){c()}}else{this._moveDetachedBlock(b,e.px,e.py,e.opacity,d)}};maps.prototype.animateBlock=function(d,f,e,a){var b=f=="hide";if(typeof d[0]=="number"&&typeof d[1]=="number"){d=[d]}var c=this._animateBlock_getList(d);if(c.length==0){if(a){a()}return}this._animateBlock_drawList(c,b?1:0);e/=Math.max(core.status.replay.speed,1);this._animateBlock_doAnimate(d,c,b,10/e,a)};maps.prototype._animateBlock_doAnimate=function(f,e,d,c,b){var g=d?1:0;var a=setInterval(function(){g+=d?-c:c;core.maps._animateBlock_drawList(e,g);if(g>=1||g<=0){delete core.animateFrame.asyncId[a];clearInterval(a);e.forEach(function(h){if(h.blockInfo){core.maps._deleteDetachedBlock(h.canvases)}});f.forEach(function(h){if(d){core.removeBlock(h[0],h[1])}else{core.showBlock(h[0],h[1])}});if(b){b()}}},10);core.animateFrame.asyncId[a]=true};maps.prototype._animateBlock_getList=function(b){var a=[];b.forEach(function(f){var c=core.getBlock(f[0],f[1],null,true);if(c==null){return}c=c.block;var d=core.maps.getBlockInfo(c);if(d==null){a.push({x:f[0],y:f[1]});return}var e=core.maps._initDetachedBlock(d,f[0],f[1],c.event.displayDamage!==false);a.push({x:f[0],y:f[1],blockInfo:d,canvases:e})});return a};maps.prototype._animateBlock_drawList=function(a,b){a.forEach(function(c){if(c.blockInfo){core.maps._moveDetachedBlock(c.blockInfo,c.x*32,c.y*32,b,c.canvases)}})};maps.prototype.addGlobalAnimate=function(a){if(!a.event||a.event.animate==null){return}if(a.event.cls=="autotile"){var b=a.event.id,c=core.material.images.autotile[b];if(!c||c.width==96){return}core.status.autotileAnimateObjs.blocks.push(a)}else{if(!a.event.animate||a.event.animate==1){return}core.status.globalAnimateObjs.push(a)}};maps.prototype.removeGlobalAnimate=function(b,c,a){if(b==null||c==null){core.status.globalAnimateStatus=0;core.status.globalAnimateObjs=[];core.status.autotileAnimateObjs={blocks:[],map:null,bgmap:null,fgmap:null};core.status.floorAnimateObjs=[];return}core.status.globalAnimateObjs=core.status.globalAnimateObjs.filter(function(d){return d.x!=b||d.y!=c||d.name!=a});if(core.status.autotileAnimateObjs.blocks){core.status.autotileAnimateObjs.blocks=core.status.autotileAnimateObjs.blocks.filter(function(d){return d.x!=b||d.y!=c||d.name!=a});core.status.autotileAnimateObjs.map[c][b]=0}};maps.prototype.drawBoxAnimate=function(){core.status.boxAnimateObjs.forEach(function(a){core.clearMap("ui",a.bgx,a.bgy,a.bgWidth,a.bgHeight);core.fillRect("ui",a.bgx,a.bgy,a.bgWidth,a.bgHeight,core.material.groundPattern);core.drawImage("ui",a.image,core.status.globalAnimateStatus%a.animate*32,a.pos,32,a.height,a.x,a.y,32,a.height)})};maps.prototype.drawAnimate=function(f,g,h,b){f=core.getMappedName(f);if(core.isReplaying()){if(b){b()}return -1}if(!core.material.animates[f]||g==null||h==null){if(b){b()}return -1}var a=core.material.animates[f],c=32*g+16,d=32*h+16;core.playSound(a.se);var e=setTimeout(null);core.status.animateObjs.push({id:e,animate:a,centerX:c,centerY:d,index:0,callback:b});return e};maps.prototype._drawAnimateFrame=function(a,b,c,e){var d=a.frames[e];var f=a.ratio;d.forEach(function(l){var i=a.images[l.index];if(!i){return}var k=i.width*f*l.zoom/100;var j=i.height*f*l.zoom/100;core.setAlpha("animate",l.opacity/255);var g=b+l.x,h=c+l.y;if(!l.mirror&&!l.angle){core.drawImage("animate",i,g-k/2-core.bigmap.offsetX,h-j/2-core.bigmap.offsetY,k,j)}else{core.saveCanvas("animate");core.canvas.animate.translate(g,h);if(l.angle){core.canvas.animate.rotate(-l.angle*Math.PI/180)}if(l.mirror){core.canvas.animate.scale(-1,1)}core.drawImage("animate",i,-k/2-core.bigmap.offsetX,-j/2-core.bigmap.offsetY,k,j);core.loadCanvas("animate")}core.setAlpha("animate",1)})};maps.prototype.stopAnimate=function(c,a){for(var b=0;b<core.status.animateObjs.length;b++){var d=core.status.animateObjs[b];if(d.id==c){if(a){(function(e){setTimeout(function(){if(e){e()}})})(d.callback)}}}core.status.animateObjs=core.status.animateObjs.filter(function(e){return e.id!=c});if(core.status.animateObjs.length==0){core.clearMap("animate")}};"use strict";function enemys(){this._init()}enemys.prototype._init=function(){this.enemys=enemys_fcae963b_31c9_42b4_b48c_bb48d09f3f80;this.enemydata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.enemys;if(main.mode=="play"){this.enemydata.hasSpecial=function(c,d){return core.enemys.hasSpecial(c,d)};for(var a in this.enemys){this.enemys[a].id=a}}};enemys.prototype.getEnemys=function(){return core.clone(this.enemys)};enemys.prototype.hasSpecial=function(a,b){if(a==null){return false}if(a instanceof Array){return a.indexOf(b)>=0}if(typeof a=="number"){return a===b}if(typeof a=="string"){return this.hasSpecial(core.material.enemys[a],b)}if(a.special!=null){return this.hasSpecial(a.special,b)}return false};enemys.prototype.getSpecials=function(){return this.enemydata.getSpecials()};enemys.prototype.getSpecialText=function(a){if(typeof a=="string"){a=core.material.enemys[a]}if(!a){return[]}var c=a.special;var e=[];var d=this.getSpecials();if(d){for(var b=0;b<d.length;b++){if(this.hasSpecial(c,d[b][0])){e.push(this._calSpecialContent(a,d[b][1]))}}}return e};enemys.prototype.getSpecialHint=function(a,d){var e=this.getSpecials();if(d==null){if(e==null){return[]}var b=[];for(var c=0;c<e.length;c++){if(this.hasSpecial(a,e[c][0])){b.push(this._calSpecialContent(a,e[c][1])+"："+this._calSpecialContent(a,e[c][2]))}}return b}if(e==null){return""}for(var c=0;c<e.length;c++){if(d==e[c][0]){return this._calSpecialContent(a,e[c][1])+"："+this._calSpecialContent(a,e[c][2])}}return""};enemys.prototype._calSpecialContent=function(b,a){if(typeof a=="string"){return a}if(typeof b=="string"){b=core.material.enemys[b]}if(a instanceof Function){return a(b)}return""};enemys.prototype.canBattle=function(b,d,e,c){if(typeof b=="string"){b=core.material.enemys[b]}var a=this.getDamage(b,d,e,c);return a!=null&&a<core.status.hero.hp};enemys.prototype.getDamage=function(b,d,e,c){if(typeof b=="string"){b=core.material.enemys[b]}var a=this._calDamage(b,null,d,e,c);if(a==null){return null}return a+this.getExtraDamage(b,d,e,c)};enemys.prototype.getExtraDamage=function(a,d,e,c){if(typeof a=="string"){a=core.material.enemys[a]}var b=0;if(this.hasSpecial(a.special,17)){b+=core.getFlag("hatred",0)}if(this.hasSpecial(a.special,22)){b+=a.damage||0}return b};enemys.prototype.getDamageString=function(c,e,f,d){if(typeof c=="string"){c=core.material.enemys[c]}var b=this.getDamage(c,e,f,d);var a="#000000";if(b==null){b="???";a="#FF0000"}else{if(b<=0){a="#00FF00"}else{if(b<core.status.hero.hp/3){a="#FFFFFF"}else{if(b<core.status.hero.hp*2/3){a="#FFFF00"}else{if(b<core.status.hero.hp){a="#FF7F00"}else{a="#FF0000"}}}}b=core.formatBigNumber(b,true);if(core.enemys.hasSpecial(c,19)){b+="+"}if(core.enemys.hasSpecial(c,21)){b+="-"}if(core.enemys.hasSpecial(c,11)){b+="^"}}return{damage:b,color:a}};enemys.prototype.nextCriticals=function(a,e,f,g,b){if(typeof a=="string"){a=core.material.enemys[a]}e=e||1;if(this.hasSpecial(a.special,10)){return[]}var c=this.getDamageInfo(a,null,f,g,b);if(c==null||this.hasSpecial(a.special,3)){c=this.getEnemyInfo(a,null,f,g,b);if(core.status.hero.atk<=c.def){return[[c.def+1-core.status.hero.atk,"?"]]}return[]}if(typeof c=="number"||(c.damage<=0&&!core.flags.enableNegativeDamage)){return[[0,0]]}if(core.flags.useLoop){var d=1;if(core.status.hero.atk<=d){return this._nextCriticals_useLoop(a,c,e,f,g,b)}else{return this._nextCriticals_useBinarySearch(a,c,e,f,g,b)}}else{return this._nextCriticals_useTurn(a,c,e,f,g,b)}};enemys.prototype._nextCriticals_useLoop=function(b,e,j,l,m,c){var h=e.mon_hp,d=core.status.hero.atk,g=e.mon_def,k=e.damage;var f=[];for(var a=d+1;a<=h+g;a++){var i=this.getDamageInfo(b,{atk:a},l,m,c);if(i==null||(typeof i=="number")){break}if(k>i.damage){k=i.damage;f.push([a-d,e.damage-i.damage]);if(i.damage<=0&&!core.flags.enableNegativeDamage){break}if(f.length>=j){break}}}if(f.length==0){f.push([0,0])}return f};enemys.prototype._nextCriticals_useBinarySearch=function(c,f,k,m,n,d){var i=f.mon_hp,e=core.status.hero.atk,h=f.mon_def,l=f.damage;var g=[];var a=function(o,q){var t=Math.floor(o),p=Math.floor(q);if(t>p){return null}while(t<p){var r=Math.floor((t+p)/2);var s=core.enemys.getDamageInfo(c,{atk:r},m,n,d);if(s==null||(typeof s=="number")){return null}if(l>s.damage){p=r}else{t=r+1}}var s=core.enemys.getDamageInfo(c,{atk:t},m,n,d);return s==null||(typeof s=="number")||s.damage>=l?null:[t,s.damage]};var b=e;while(true){var j=a(b+1,i+h,l);if(j==null){break}b=j[0];l=j[1];g.push([b-e,f.damage-l]);if(l<=0&&!core.flags.enableNegativeDamage){break}if(g.length>=k){break}}if(g.length==0){g.push([0,0])}return g};enemys.prototype._nextCriticals_useTurn=function(a,d,j,n,o,b){var g=d.mon_hp,c=core.status.hero.atk,f=d.mon_def,m=d.turn;if(m>=1000000){return this._nextCriticals_useBinarySearch(a,d,j,n,o,b)}var e=[],k=null;for(var l=m-1;l>=1;l--){var h=Math.ceil(g/l)+f;h=Math.ceil(h/core.getBuff("atk"));if(h<=c){break}if(h!=k){var i=this.getDamageInfo(a,{atk:h},n,o,b);if(i==null||(typeof i=="number")){break}e.push([h-c,Math.floor(d.damage-i.damage)]);if(i.damage<=0&&!core.flags.enableNegativeDamage){break}k=h}if(e.length>=j){break}}if(e.length==0){e.push([0,0])}return e};enemys.prototype.getDefDamage=function(a,c,f,g,b){if(typeof a=="string"){a=core.material.enemys[a]}c=c||1;var e=this._calDamage(a,null,f,g,b);var d=this._calDamage(a,{def:core.status.hero.def+c},f,g,b);if(e==null||d==null){return"???"}return e-d};enemys.prototype.getEnemyInfo=function(a,c,d,e,b){if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getEnemyInfo(a,c,d,e,b)};enemys.prototype.getDamageInfo=function(a,c,d,e,b){if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getDamageInfo(a,c,d,e,b)};enemys.prototype._calDamage=function(a,c,e,f,b){if(typeof a=="string"){a=core.material.enemys[a]}var d=this.getDamageInfo(a,c,e,f,b);if(d==null){return null}if(typeof d=="number"){return d}return d.damage};enemys.prototype.updateEnemys=function(){return this.enemydata.updateEnemys()};enemys.prototype.getCurrentEnemys=function(d){d=d||core.status.floorId;var c=[],f={};var e=core.status.maps[d].blocks;for(var a=0;a<e.length;a++){if(!e[a].disable&&e[a].event.cls.indexOf("enemy")==0){this._getCurrentEnemys_addEnemy(e[a].event.id,c,f,d)}}return this._getCurrentEnemys_sort(c)};enemys.prototype._getCurrentEnemys_getEnemy=function(b){var a=core.material.enemys[b];if(!a){return null}return core.material.enemys[a.displayIdInBook]||a};enemys.prototype._getCurrentEnemys_addEnemy=function(d,g,j,h){var c=this._getCurrentEnemys_getEnemy(d);if(c==null||j[c.id]){return}var f=this.getEnemyInfo(c,null,null,null,h);var i=core.enemys.getSpecialText(c);if(i.length>=3){i="多属性..."}else{i=i.join("  ")}var a=this.nextCriticals(c,1,null,null,h);if(a.length>0){a=a[0]}var b=core.clone(c);for(var k in f){b[k]=f[k]}b.specialText=i;b.damage=this.getDamage(c,null,null,h);b.critical=a[0];b.criticalDamage=a[1];b.defDamage=this.getDefDamage(c,1,null,null,h);g.push(b);j[c.id]=true};enemys.prototype._getCurrentEnemys_sort=function(a){return a.sort(function(c,d){if(c.damage==d.damage){return c.money-d.money}if(c.damage==null){return 1}if(d.damage==null){return -1}return c.damage-d.damage})};enemys.prototype.hasEnemyLeft=function(a,b){if(b==null){b=core.status.floorId}if(b instanceof Array){for(var c=0;c<b.length;++c){if(core.hasEnemyLeft(a,b[c])){return true}}return false}return core.getCurrentEnemys(b).filter(function(d){return a==null||d.id==a}).length>0};"use strict";function events(){this._init()}events.prototype._init=function(){this.eventdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.events;this.commonEvent=events_c12a15a8_c380_4b28_8144_256cba95f760.commonEvent;this.systemEvents={};this.actions={}};events.prototype.resetGame=function(c,b,a,d,e){this.eventdata.resetGame(c,b,a,d,e)};events.prototype.startGame=function(b,d,c,a){main.dom.levelChooseButtons.style.display="none";main.dom.startButtonGroup.style.display="none";b=b||"";if(main.mode!="play"){return}if(core.flags.startUsingCanvas||c!=null){core.dom.startPanel.style.display="none";this._startGame_start(b,d,c,a)}else{core.hideStartAnimate(function(){core.events._startGame_start(b,d,c,a)})}};events.prototype._startGame_start=function(b,e,d,a){console.log("开始游戏");core.resetGame(core.firstData.hero,b,null,core.clone(core.initStatus.maps));var c=core.clone(core.getHeroLoc());core.setHeroLoc("x",-1);core.setHeroLoc("y",-1);if(e!=null){core.setFlag("__seed__",e);core.setFlag("__rand__",e)}else{core.utils.__init_seed()}this.setInitData();core.clearStatusBar();var f=[];if(core.flags.startUsingCanvas){core.hideStatusBar();core.dom.musicBtn.style.display="block";core.push(f,core.firstData.startCanvas)}core.push(f,core.firstData.startText);this.insertAction(f,null,null,function(){core.events._startGame_afterStart(c,a)});if(d!=null){core.startReplay(d)}};events.prototype._startGame_afterStart=function(b,a){core.ui.closePanel();this._startGame_statusBar();core.dom.musicBtn.style.display="none";core.changeFloor(core.firstData.floorId,null,b,null,function(){core.insertAction([]);if(a){a()}});this._startGame_upload()};events.prototype._startGame_statusBar=function(){if(core.flags.startUsingCanvas){core.hideStatusBar()}else{core.showStatusBar()}};events.prototype._startGame_upload=function(){var a=new FormData();a.append("type","people");a.append("name",core.firstData.name);a.append("version",core.firstData.version);a.append("platform",core.platform.string);a.append("hard",core.encodeBase64(core.status.hard));a.append("hardCode",core.getFlag("hard",0));a.append("base64",1);core.utils.http("POST","/games/upload.php",a)};events.prototype.setInitData=function(){return this.eventdata.setInitData()};events.prototype.win=function(b,a){core.status.gameOver=true;return this.eventdata.win(b,a)};events.prototype.lose=function(a){core.status.gameOver=true;return this.eventdata.lose(a)};events.prototype.gameOver=function(a,b,c){core.clearMap("all");core.deleteAllCanvas();core.dom.gif2.innerHTML="";core.setWeather();core.ui.closePanel();if(main.isCompetition&&a!=null){if(a==""){a="恭喜通关"}a+="[比赛]"}var d=null;if(b){d="录像回放完毕！"}else{if(core.hasFlag("debug")){d="\t[系统提示]调试模式下无法上传成绩"}else{if(core.hasFlag("__consoleOpened__")){d="\t[系统提示]本存档开启过控制台，无法上传成绩"}}}if(d!=null){core.drawText(d,core.restart)}else{this._gameOver_confirmUpload(a,c)}};events.prototype._gameOver_confirmUpload=function(a,b){core.ui.closePanel();if(a==null){this._gameOver_confirmDownload(a);return}core.ui.drawConfirmBox("你想记录你的ID和成绩吗？",function(){if(main.isCompetition){core.events._gameOver_doUpload("",a,b)}else{core.myprompt("请输入你的ID：",core.getCookie("id")||"",function(c){core.events._gameOver_doUpload(c,a,b)})}},function(){if(main.isCompetition){core.events._gameOver_confirmDownload(a)}else{core.events._gameOver_doUpload(null,a,b)}})};events.prototype._gameOver_doUpload=function(e,a,d){var c=core.status.hero.hp;if(e==null){c=1}core.ui.closePanel();var b=new FormData();b.append("type","score");b.append("name",core.firstData.name);b.append("version",core.firstData.version);b.append("platform",core.platform.string);b.append("hard",core.encodeBase64(core.status.hard));b.append("username",core.encodeBase64(e||""));b.append("ending",core.encodeBase64(a));b.append("lv",core.status.hero.lv);b.append("hp",Math.min(c,Math.pow(2,63)));b.append("atk",core.status.hero.atk);b.append("def",core.status.hero.def);b.append("mdef",core.status.hero.mdef);b.append("money",core.status.hero.money);b.append("experience",core.status.hero.experience);b.append("steps",core.status.hero.steps);b.append("norank",d?1:0);b.append("seed",core.getFlag("__seed__"));b.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));b.append("route",core.encodeRoute(core.status.route));b.append("base64",1);if(main.isCompetition){core.http("POST","/games/competition/upload.php",b)}else{core.http("POST","/games/upload.php",b)}core.events._gameOver_confirmDownload(a)};events.prototype._gameOver_confirmDownload=function(a){core.ui.closePanel();core.ui.drawConfirmBox("你想下载录像吗？",function(){var b={name:core.firstData.name,version:core.firstData.version,hard:core.status.hard,seed:core.getFlag("__seed__"),route:core.encodeRoute(core.status.route)};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",JSON.stringify(b));core.events._gameOver_askRate(a)},function(){core.events._gameOver_askRate(a)})};events.prototype._gameOver_askRate=function(a){if(a==null){core.restart();return}core.ui.closePanel();core.ui.drawConfirmBox("恭喜通关本塔，你想进行评分吗？",function(){if(core.platform.isPC){window.open("/score.php?name="+core.firstData.name+"&num=10","_blank");core.restart()}else{window.location.href="/score.php?name="+core.firstData.name+"&num=10"}},function(){core.restart()})};events.prototype.restart=function(){core.showStartAnimate();core.playBgm(main.startBgm)};events.prototype.confirmRestart=function(){core.status.event.selection=1;core.ui.drawConfirmBox("你确定要返回标题页面吗？",function(){core.ui.closePanel();core.restart()},function(){core.ui.closePanel()})};events.prototype.registerSystemEvent=function(b,a){this.systemEvents[b]=a};events.prototype.unregisterSystemEvent=function(a){delete this.systemEvents[a]};events.prototype.doSystemEvent=function(d,b,a){if(this.systemEvents[d]){try{return core.doFunc(this.systemEvents[d],this,b,a)}catch(c){main.log(c);main.log("ERROR in systemEvents["+d+"]")}}if(this["_sys_"+d]){return this["_sys_"+d](b,a)}main.log("未知的系统事件: "+d+"！");if(a){a()}};events.prototype._trigger=function(d,e){if(core.status.gameOver){return}if(core.status.event.id=="action"){core.insertAction({type:"trigger",loc:[d,e]},d,e,null,true);return}if(core.status.event.id){return}var a=core.getBlock(d,e);if(a==null){return}a=a.block;if(a.event.trigger){var b=a.event.noPass,c=a.event.trigger;if(b){core.clearAutomaticRouteNode(d,e)}if(c=="changeFloor"&&!b&&this._trigger_ignoreChangeFloor(a)){return}core.status.automaticRoute.moveDirectly=false;this.doSystemEvent(c,a)}};events.prototype._trigger_ignoreChangeFloor=function(b){var a=core.flags.ignoreChangeFloor;if(b.event.data&&b.event.data.ignoreChangeFloor!=null){a=b.event.data.ignoreChangeFloor}if(a){if(core.isReplaying()){if(core.status.replay.toReplay[0]=="no"){core.status.replay.toReplay.shift();core.status.route.push("no");return true}}else{if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");return true}}}return false};events.prototype._sys_battle=function(b,a){this.battle(b.event.id,b.x,b.y,false,a)};events.prototype.battle=function(c,d,e,b,a){core.saveAndStopAutomaticRoute();c=c||core.getBlockId(d,e);if(!c){return core.clearContinueAutomaticRoute(a)}if(!core.enemys.canBattle(c,d,e)&&!b&&!core.status.event.id){core.drawTip("你打不过此怪物！");return core.clearContinueAutomaticRoute(a)}if(!core.status.event.id){core.autosave(true)}if(!this.beforeBattle(c,d,e)){return core.clearContinueAutomaticRoute(a)}this.afterBattle(c,d,e,a)};events.prototype.beforeBattle=function(a,b,c){return this.eventdata.beforeBattle(a,b,c)};events.prototype.afterBattle=function(b,c,d,a){return this.eventdata.afterBattle(b,c,d,a)};events.prototype._sys_openDoor=function(b,a){this.openDoor(b.x,b.y,true,function(){core.replay();if(a){a()}})};events.prototype.openDoor=function(e,f,d,a){var b=core.getBlockId(e,f);core.saveAndStopAutomaticRoute();if(!this._openDoor_check(b,e,f,d)){var c=core.status.lockControl;core.waitHeroToStop(function(){if(!c){core.unLockControl()}if(a){a()}});return}core.playSound("door.mp3");this._openDoor_animate(b,e,f,a)};events.prototype._openDoor_check=function(a,d,e,c){if(!core.terrainExists(d,e,a)||!(a.endsWith("Door")||a.endsWith("Wall"))||core.material.icons.animates[a]==null){core.clearContinueAutomaticRoute();return false}if(a=="steelDoor"&&core.flags.steelDoorWithoutKey){c=false}if(c&&a.endsWith("Door")){var b=a.replace("Door","Key");if(!core.hasItem(b)){if(b!="specialKey"){core.drawTip("你没有"+((core.material.items[b]||{}).name||"钥匙"))}else{core.drawTip("无法开启此门")}core.clearContinueAutomaticRoute();return false}if(!core.status.event.id){core.autosave(true)}core.removeItem(b)}return true};events.prototype._openDoor_animate=function(d,h,i,b){var c=core.material.icons.animates[d];var f=d.endsWith("Door")?30:70;var e=core.status.lockControl;core.lockControl();core.status.replay.animate=true;core.removeBlock(h,i);core.drawImage("event",core.material.images.animates,0,32*c,32,32,32*h,32*i,32,32);var g=0;var a=window.setInterval(function(){core.clearMap("event",32*h,32*i,32,32);g++;if(g==4){clearInterval(a);delete core.animateFrame.asyncId[a];if(!e){core.unLockControl()}core.status.replay.animate=false;core.events.afterOpenDoor(d,h,i,b);return}core.drawImage("event",core.material.images.animates,32*g,32*c,32,32,32*h,32*i,32,32)},core.status.replay.speed==24?1:f/Math.max(core.status.replay.speed,1));core.animateFrame.asyncId[a]=true};events.prototype.afterOpenDoor=function(b,c,d,a){return this.eventdata.afterOpenDoor(b,c,d,a)};events.prototype._sys_getItem=function(b,a){this.getItem(b.event.id,1,b.x,b.y,a)};events.prototype.getItem=function(d,h,j,k,a){if(h==null){h=1}h=h||1;var f=core.material.items[d].cls;core.items.getItemEffect(d,h);core.removeBlock(j,k);var i="获得 "+core.material.items[d].name;if(h>1){i+="x"+h}if(f==="items"){i+=core.items.getItemEffectTip(d)}core.drawTip(i,d);if(!core.hasFlag("__itemHint__")){core.setFlag("__itemHint__",[])}var g=core.getFlag("__itemHint__");if(core.flags.itemFirstText&&g.indexOf(d)<0&&f!="items"){var c=core.material.items[d].text||"该道具暂无描述";try{c=core.replaceText(c)}catch(b){}core.insertAction("\t["+core.material.items[d].name+","+d+"]"+c+"\n"+(f=="keys"||d=="greenKey"||d=="steelKey"?"（钥匙类道具，遇到对应的门时自动打开）":f=="tools"?"（消耗类道具，请按T在道具栏使用）":f=="constants"?"（永久类道具，请按T在道具栏使用）":f=="equips"?"（装备类道具，请按Q在装备栏进行装备）":""));g.push(d)}core.updateStatusBar();this.afterGetItem(d,j,k,a)};events.prototype.afterGetItem=function(b,c,d,a){this.eventdata.afterGetItem(b,c,d,a)};events.prototype.getNextItem=function(d){if(core.isMoving()||!core.canMoveHero()||!core.flags.enableGentleClick){return false}var b=core.nextX(),c=core.nextY();var a=core.getBlock(b,c);if(a==null){return false}if(a.block.event.trigger=="getItem"){if(!d){core.status.route.push("getNext")}this.getItem(a.block.event.id,1,b,c);return true}return false};events.prototype._sys_changeFloor=function(b,a){b=b.event.data;var c={};if(b.loc){c={x:b.loc[0],y:b.loc[1]}}if(b.direction){c.direction=b.direction}if(core.status.event.id!="action"){core.status.event.id=null}core.changeFloor(b.floorId,b.stair,c,b.time,function(){core.replay();if(a){a()}})};events.prototype.changeFloor=function(b,f,d,g,a,c){var e=this._changeFloor_getInfo(b,f,d,g);if(e==null){if(a){a()}return}e.fromLoad=c;b=e.floorId;e.locked=core.status.lockControl;core.dom.floorNameLabel.innerHTML=core.status.maps[b].title;core.lockControl();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=true;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval="tmp";this._changeFloor_beforeChange(e,a)};events.prototype._changeFloor_getInfo=function(a,d,b,e){a=a||core.status.floorId;if(a==":before"){var c=core.floorIds.indexOf(core.status.floorId);if(c>0){a=core.floorIds[c-1]}else{a=core.status.floorId}}else{if(a==":next"){var c=core.floorIds.indexOf(core.status.floorId);if(c<core.floorIds.length-1){a=core.floorIds[c+1]}else{a=core.status.floorId}}}if(!core.status.maps[a]){main.log("不存在的楼层："+a);return null}if(main.mode!="play"||core.isReplaying()){e=0}if(e==null){e=core.values.floorChangeTime}if(e==null){e=800}if(e<100){e=0}e/=20;return{floorId:a,time:e,heroLoc:core.clone(this._changeFloor_getHeroLoc(a,d,b))}};events.prototype._changeFloor_getHeroLoc=function(b,e,c){if(!c){c=core.clone(core.status.hero.loc)}if(e){if(e==":now"){c=core.clone(core.status.hero.loc)}else{if(e==":symmetry"){c.x=core.bigmap.width-1-core.getHeroLoc("x");c.y=core.bigmap.height-1-core.getHeroLoc("y")}else{if(e==":symmetry_x"){c.x=core.bigmap.width-1-core.getHeroLoc("x")}else{if(e==":symmetry_y"){c.y=core.bigmap.height-1-core.getHeroLoc("y")}else{if(core.status.maps[b][e]){c.x=core.status.maps[b][e][0];c.y=core.status.maps[b][e][1]}else{var a=core.status.maps[b].blocks;for(var d in a){if(!a[d].disable&&a[d].event.id===e){c.x=a[d].x;c.y=a[d].y;break}}}}}}}}["x","y","direction"].forEach(function(f){if(c[f]==null){c[f]=core.getHeroLoc(f)}});return c};events.prototype._changeFloor_beforeChange=function(b,a){if(core.status.floorId){core.playSound(b.fromLoad?"load.mp3":"floor.mp3")}window.setTimeout(function(){if(b.time==0){core.events._changeFloor_changing(b,a)}else{core.showWithAnimate(core.dom.floorMsgGroup,b.time/2,function(){core.events._changeFloor_changing(b,a)})}},25)};events.prototype._changeFloor_changing=function(b,a){this.changingFloor(b.floorId,b.heroLoc,b.fromLoad);if(b.time==0){this._changeFloor_afterChange(b,a)}else{core.hideWithAnimate(core.dom.floorMsgGroup,b.time/4,function(){core.events._changeFloor_afterChange(b,a)})}};events.prototype._changeFloor_afterChange=function(b,a){if(!b.locked){core.unLockControl()}core.status.replay.animate=false;core.events.afterChangeFloor(b.floorId,b.fromLoad);if(a){a()}};events.prototype.changingFloor=function(a,c,b){this.eventdata.changingFloor(a,c,b)};events.prototype.afterChangeFloor=function(a,b){if(main.mode!="play"){return}return this.eventdata.afterChangeFloor(a,b)};events.prototype.hasVisitedFloor=function(a){return core.getFlag("__visited__")[a]||false};events.prototype.visitFloor=function(a){core.getFlag("__visited__")[a]=true};events.prototype._sys_passNet=function(b,a){this.passNet(b);if(a){a()}};events.prototype.passNet=function(a){if(core.hasItem("shoes")){return}if(a.event.id=="poisonNet"){core.insertAction({type:"insert",name:"毒衰咒处理",args:[0]})}else{if(a.event.id=="weakNet"){core.insertAction({type:"insert",name:"毒衰咒处理",args:[1]})}else{if(a.event.id=="curseNet"){core.insertAction({type:"insert",name:"毒衰咒处理",args:[2]})}}}core.updateStatusBar()};events.prototype._sys_pushBox=function(b,a){this.pushBox(b);if(a){a()}};events.prototype.pushBox=function(a){if(a.event.id!="box"&&a.event.id!="boxed"){return}var b=core.getHeroLoc("direction"),d=a.x+core.utils.scan[b].x,e=a.y+core.utils.scan[b].y;if(!core.canMoveHero()||!core.canMoveHero(a.x,a.y,b)){return}var c=core.getBlockId(d,e);if(c!=null&&c!="flower"){return}core.setBlock(c==null?169:170,d,e);if(a.event.id=="box"){core.removeBlock(a.x,a.y)}else{core.setBlock(168,a.x,a.y)}core.updateStatusBar();this._pushBox_moveHero(b)};events.prototype._pushBox_moveHero=function(a){core.status.replay.animate=true;core.lockControl();setTimeout(function(){core.moveHero(a,function(){core.status.replay.animate=false;core.status.route.pop();core.events.afterPushBox();if(core.status.event.id==null){core.unLockControl();core.replay()}})})};events.prototype.afterPushBox=function(){return this.eventdata.afterPushBox()};events.prototype._sys_changeLight=function(b,a){core.events.changeLight(b.event.id,b.x,b.y);if(a){a()}};events.prototype.changeLight=function(a,b,c){if(a!=null&&a!="light"){return}core.setBlock(core.getNumberById("darkLight"),b,c);return this.eventdata.afterChangeLight(b,c)};events.prototype._sys_ski=function(b,a){core.insertAction(["V2.6后，请将滑冰放在背景层！"],b.x,b.y,a)};events.prototype._sys_action=function(b,a){var d=core.clone(b.event.data),e=b.x,f=b.y;if(e==core.nextX()&&f==core.nextY()){var c=core.reverseDirection();var g=b.event.id,i=(b.event.faceIds||{})[c];if(i&&g!=i){var h=core.getNumberById(i);if(h>0){core.setBlock(h,e,f)}}}this.insertAction(d,e,f,a)};events.prototype._sys_custom=function(b,a){core.insertAction(["请使用\r[yellow]core.registerSystemEvent('custom', func)\r来处理自己添加的系统触发器！"],b.x,b.y,a)};events.prototype.registerEvent=function(b,a){this.actions[b]=a};events.prototype.unregisterEvent=function(a){delete this.actions[a]};events.prototype.doEvent=function(a,f,g,c){var d=a.type;if(this.actions[d]){try{return core.doFunc(this.actions[d],this,a,f,g,c)}catch(b){main.log(b);main.log("ERROR in actions["+d+"]")}}if(this["_action_"+d]){return this["_action_"+d](a,f,g,c)}core.insertAction("未知的自定义事件: "+d+"！");core.doAction()};events.prototype.setEvents=function(c,d,e,a){var b=core.status.event.data||{};if(c){b.list=[{todo:core.clone(c),total:core.clone(c),condition:"false"}]}if(d!=null){b.x=d}if(e!=null){b.y=e}if(a){b.callback=a}core.status.event.id="action";core.status.event.data=b};events.prototype.startEvents=function(b,c,d,a){if(!b){return}if(!(b instanceof Array)){b=[b]}this.setEvents(b,c,d,a);core.waitHeroToStop(function(){core.lockControl();core.doAction()})};events.prototype.doAction=function(c){if(!c){core.clearUI();clearInterval(core.status.event.interval);core.status.event.interval=null}if(this._doAction_finishEvents()){return}var e=core.status.event.data.x,f=core.status.event.data.y;var d=[core.status.floorId||":f",e!=null?e:"x",f!=null?f:"y"].join("@");var a=core.status.event.data.list[0];if(this._popEvents(a,d)){return}var b=a.todo.shift();core.status.event.data.current=b;if(typeof b=="string"){b={type:"text",text:b}}core.status.event.data.type=b.type;this.doEvent(b,e,f,d);return};events.prototype._doAction_finishEvents=function(){if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel();if(a){a()}core.replay();return true}return false};events.prototype._popEvents=function(a,b){if(a.todo.length==0){if(core.calValue(a.condition,b)){a.todo=core.clone(a.total)}else{core.status.event.data.list.shift()}core.doAction();return true}return false};events.prototype.insertAction=function(a,e,f,c,b){if(core.hasFlag("__statistics__")){return}if(core.status.gameOver){return}var d=this.getCommonEvent(a);if(d instanceof Array){a=[{type:"dowhile",condition:"false",data:d}]}if(!a){return}if(core.status.event.id!="action"){this.startEvents(a,e,f,c)}else{if(b){core.push(core.status.event.data.list[0].todo,a)}else{core.unshift(core.status.event.data.list[0].todo,a)}this.setEvents(null,e,f,c)}};events.prototype.getCommonEvent=function(a){if(!a||typeof a!=="string"){return null}return this.commonEvent[a]||null};events.prototype.recoverEvents=function(a){if(a){core.ui.closePanel();core.lockControl();core.status.event.id="action";core.status.event.data=a;setTimeout(function(){core.doAction()},30);return true}return false};events.prototype.__action_checkReplaying=function(){if(core.isReplaying()){core.doAction();return true}return false};events.prototype.__action_getLoc=function(a,c,d,b){if(a){c=core.calValue(a[0],b);d=core.calValue(a[1],b)}return[c,d]};events.prototype.__action_getHeroLoc=function(a,b){return this.__action_getLoc(a,core.getHeroLoc("x"),core.getHeroLoc("y"),b)};events.prototype.__action_getLoc2D=function(a,c,d,b){if(!(a&&a[0] instanceof Array)){a=[this.__action_getLoc(a,c,d,b)]}return a};events.prototype.__action_doAsyncFunc=function(b,a){var c=Array.prototype.slice.call(arguments,2);if(b){a.apply(this,c);core.doAction()}else{a.apply(this,c.concat(core.doAction))}};events.prototype._action_text=function(a,c,d,b){if(this.__action_checkReplaying()){return}core.ui.drawTextBox(a.text,a.showAll)};events.prototype._action_autoText=function(a,c,d,b){if(this.__action_checkReplaying()){return}core.ui.drawTextBox(a.text);setTimeout(core.doAction,a.time||3000)};events.prototype._action_scrollText=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.drawScrollText,a.text,a.time||5000,a.lineHeight||1.4)};events.prototype._action_comment=function(a,c,d,b){core.doAction()};events.prototype._action_setText=function(a,c,d,b){["position","offset","align","bold","titlefont","textfont","time"].forEach(function(e){if(a[e]!=null){core.status.textAttribute[e]=a[e]}});["background","title","text"].forEach(function(g){if((a[g] instanceof Array)&&a[g].length>=3){if(a[g].length==3){a[g].push(1)}core.status.textAttribute[g]=a[g]}if(g=="background"){var f=core.getMappedName(a[g]);var e=core.material.images.images[f];if(e&&e.width==192&&e.height==128){core.status.textAttribute[g]=f}}});core.setFlag("textAttribute",core.status.textAttribute);core.doAction()};events.prototype._action_tip=function(a,c,d,b){core.drawTip(core.replaceText(a.text),a.icon);core.doAction()};events.prototype._action_show=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);if(a.time>0&&!(a.floorId&&a.floorId!=core.status.floorId)){this.__action_doAsyncFunc(a.async,core.animateBlock,a.loc,"show",a.time)}else{a.loc.forEach(function(e){core.showBlock(e[0],e[1],a.floorId)});core.doAction()}};events.prototype._action_hide=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);if(a.time>0&&!(a.floorId&&a.floorId!=core.status.floorId)){a.loc.forEach(function(e){core.hideBlock(e[0],e[1],a.floorId)});this.__action_doAsyncFunc(a.async,core.animateBlock,a.loc,"hide",a.time)}else{a.loc.forEach(function(e){core.removeBlock(e[0],e[1],a.floorId)});core.doAction()}};events.prototype._action_setBlock=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.loc.forEach(function(e){core.setBlock(a.number,e[0],e[1],a.floorId)});core.doAction()};events.prototype._action_showFloorImg=function(a,c,d,b){core.maps.showFloorImage(this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_hideFloorImg=function(a,c,d,b){core.maps.hideFloorImage(this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_showBgFgMap=function(a,c,d,b){core.maps.showBgFgMap(a.name,this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_hideBgFgMap=function(a,c,d,b){core.maps.hideBgFgMap(a.name,this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_setBgFgBlock=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.loc.forEach(function(e){core.setBgFgBlock(a.name,a.number,e[0],e[1],a.floorId)});core.doAction()};events.prototype._action_follow=function(a,c,d,b){this.follow(a.name);core.doAction()};events.prototype._action_unfollow=function(a,c,d,b){this.unfollow(a.name);core.doAction()};events.prototype._action_animate=function(a,c,d,b){if(a.loc=="hero"){a.loc=[core.getHeroLoc("x"),core.getHeroLoc("y")]}else{a.loc=this.__action_getLoc(a.loc,c,d,b)}this.__action_doAsyncFunc(a.async,core.drawAnimate,a.name,a.loc[0],a.loc[1])};events.prototype._action_setViewport=function(a,d,e,c){if(a.loc==null){core.drawHero()}else{var b=this.__action_getLoc(a.loc,d,e,c);core.setViewport(32*b[0],32*b[1])}core.doAction()};events.prototype._action_moveViewport=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.moveViewport,a.steps,a.time)};events.prototype._action_move=function(a,d,e,c){var b=this.__action_getLoc(a.loc,d,e,c);this.__action_doAsyncFunc(a.async,core.moveBlock,b[0],b[1],a.steps,a.time,a.keep)};events.prototype._action_moveHero=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.eventMoveHero,a.steps,a.time)};events.prototype._action_jump=function(a,e,f,c){var b=this.__action_getLoc(a.from,e,f,c),d=this.__action_getLoc(a.to,e,f,c);this.__action_doAsyncFunc(a.async,core.jumpBlock,b[0],b[1],d[0],d[1],a.time,a.keep)};events.prototype._action_jumpHero=function(a,d,e,c){var b=this.__action_getHeroLoc(a.loc,c);this.__action_doAsyncFunc(a.async,core.jumpHero,b[0],b[1],a.time)};events.prototype._action_changeFloor=function(a,e,f,d){var c=this.__action_getHeroLoc(a.loc,d);var b={x:c[0],y:c[1],direction:a.direction};core.changeFloor(a.floorId||core.status.floorId,null,b,a.time,core.doAction)};events.prototype._action_changePos=function(a,d,e,c){core.clearMap("hero");var b=this.__action_getHeroLoc(a.loc,c);core.setHeroLoc("x",b[0]);core.setHeroLoc("y",b[1]);if(a.direction){core.setHeroLoc("direction",a.direction)}core.drawHero();core.doAction()};events.prototype._action_showImage=function(a,c,d,b){if(core.isReplaying()){a.time=0}this.__action_doAsyncFunc(a.async||a.time==0,core.showImage,a.code,a.image,a.sloc,a.loc,a.opacity,a.time)};events.prototype._action_showTextImage=function(a,d,e,c){var b=this.__action_getLoc(a.loc,0,0,c);if(core.isReplaying()){a.time=0}this.__action_doAsyncFunc(a.async||a.time==0,core.showImage,a.code,core.ui.textImage(a.text),b[0],b[1],100,100,a.opacity,a.time)};events.prototype._action_hideImage=function(a,c,d,b){if(core.isReplaying()){a.time=0}this.__action_doAsyncFunc(a.async||a.time==0,core.hideImage,a.code,a.time)};events.prototype._action_showGif=function(a,d,e,c){var b=this.__action_getLoc(a.loc,0,0,c);this.showGif(a.name,b[0],b[1]);core.doAction()};events.prototype._action_moveImage=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.moveImage,a.code,a.to,a.opacity,a.time)};events.prototype._action_setFg=function(a,c,d,b){return this._action_setCurtain(a,c,d,b)};events.prototype._action_setCurtain=function(a,c,d,b){if(a.async){core.setCurtain(a.color,a.time);core.setFlag("__color__",a.color||null);core.doAction()}else{core.setCurtain(a.color,a.time,function(){core.setFlag("__color__",a.color||null);core.doAction()})}};events.prototype._action_screenFlash=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.screenFlash,a.color,a.time,a.times)};events.prototype._action_setWeather=function(a,c,d,b){core.setWeather(a.name,a.level);if(a.name=="rain"||a.name=="snow"||a.name=="fog"){core.setFlag("__weather__",[a.name,a.level])}else{core.removeFlag("__weather__")}core.doAction()};events.prototype._action_openDoor=function(a,e,f,d){var c=this.__action_getLoc(a.loc,e,f,d);var b=a.floorId||core.status.floorId;if(b==core.status.floorId){this.__action_doAsyncFunc(a.async,core.openDoor,c[0],c[1],a.needKey)}else{core.removeBlock(c[0],c[1],b);core.doAction()}};events.prototype._action_closeDoor=function(a,d,e,c){var b=this.__action_getLoc(a.loc,d,e,c);this.__action_doAsyncFunc(a.async,core.closeDoor,b[0],b[1],a.id)};events.prototype._action_useItem=function(a,c,d,b){if(a.id!="book"&&core.canUseItem(a.id)){core.useItem(a.id,true,core.doAction)}else{core.drawTip("当前无法使用"+((core.material.items[a.id]||{}).name||"未知道具"));core.doAction()}};events.prototype._action_openShop=function(a,c,d,b){core.status.shops[a.id].visited=true;this.setEvents([]);if(!core.isReplaying()){this.openShop(a.id)}if(core.status.event.id=="action"){core.doAction()}};events.prototype._action_disableShop=function(a,c,d,b){this.disableQuickShop(a.id);core.doAction()};events.prototype._action_battle=function(a,d,e,c){if(a.id){this.battle(a.id,null,null,true,core.doAction)}else{var b=this.__action_getLoc(a.loc,d,e,c);this.battle(null,b[0],b[1],true,core.doAction)}};events.prototype._action_trigger=function(b,e,f,d){var c=this.__action_getLoc(b.loc,e,f,d);var a=core.getBlock(c[0],c[1]);if(a!=null&&a.block.event.trigger){a=a.block;this.setEvents(b.keep?null:[],a.x,a.y);if(a.event.trigger=="action"){this.insertAction(a.event.data)}else{core.doSystemEvent(a.event.trigger,a,core.doAction);return}}core.doAction()};events.prototype._action_insert=function(a,k,l,h){if(a.args instanceof Array){for(var f=0;f<a.args.length;++f){try{if(a.args[f]!=null){core.setFlag("arg"+(f+1),a.args[f])}}catch(b){main.log(b)}}}if(a.name){core.setFlag("arg0",a.name);core.insertAction(a.name)}else{var g=this.__action_getLoc(a.loc,k,l,h);core.setFlag("arg0",g);var d=a.floorId||core.status.floorId;var j=a.which||"events";var c=(core.floors[d][j]||[])[g[0]+","+g[1]];if(c){this.insertAction(c.data||c)}}core.doAction()};events.prototype._action_playBgm=function(a,c,d,b){core.playBgm(a.name);core.setFlag("__bgm__",a.keep?a.name:null);core.doAction()};events.prototype._action_pauseBgm=function(a,c,d,b){core.pauseBgm();core.doAction()};events.prototype._action_resumeBgm=function(a,c,d,b){core.resumeBgm();core.doAction()};events.prototype._action_loadBgm=function(a,c,d,b){core.loadBgm(a.name);core.doAction()};events.prototype._action_freeBgm=function(a,c,d,b){core.freeBgm(a.name);core.doAction()};events.prototype._action_playSound=function(a,c,d,b){if(a.stop){core.stopSound()}core.playSound(a.name);core.doAction()};events.prototype._action_stopSound=function(a,c,d,b){core.stopSound();core.doAction()};events.prototype._action_setVolume=function(a,c,d,b){a.value=core.clamp(parseInt(a.value)/100,0,1);core.setFlag("__volume__",a.value);this.__action_doAsyncFunc(a.async,core.setVolume,a.value,a.time||0)};events.prototype._action_setValue=function(a,c,d,b){this.setValue(a.name,a.value,b);core.doAction()};events.prototype._action_setValue2=function(a,c,d,b){this._action_addValue(a,c,d,b)};events.prototype._action_addValue=function(a,c,d,b){this.addValue(a.name,a.value,b);core.doAction()};events.prototype._action_setFloor=function(a,c,d,b){this.setFloorInfo(a.name,a.value,a.floorId,b);core.doAction()};events.prototype._action_setGlobalAttribute=function(a,c,d,b){this.setGlobalAttribute(a.name,a.value);core.doAction()};events.prototype._action_setGlobalValue=function(a,c,d,b){core.values[a.name]=a.value;core.doAction()};events.prototype._action_setGlobalFlag=function(a,c,d,b){this.setGlobalFlag(a.name,a.value);core.doAction()};events.prototype._action_setHeroIcon=function(a,c,d,b){this.setHeroIcon(a.name);core.doAction()};events.prototype._action_input=function(a,c,d,b){this.__action_getInput(a.text,false,function(e){e=Math.abs(parseInt(e)||0);core.status.route.push("input:"+e);core.setFlag("input",e);core.doAction()})};events.prototype._action_input2=function(a,c,d,b){this.__action_getInput(a.text,true,function(e){e=e||"";core.status.route.push("input2:"+core.encodeBase64(e));core.setFlag("input",e);core.doAction()})};events.prototype.__action_getInput=function(d,f,b){var h,g=f?"input2:":"input:";if(core.isReplaying()){var a=core.status.replay.toReplay.shift();try{if(a.indexOf(g)!=0){throw new Error("录像文件出错！当前需要一个 "+g+" 项，实际为 "+a)}if(f){h=core.decodeBase64(a.substring(7))}else{h=parseInt(a.substring(6))}b(h)}catch(c){core.control._replay_error(a);return}}else{core.myprompt(core.replaceText(d),null,b)}};events.prototype._action_if=function(a,c,d,b){if(core.calValue(a.condition,b)){core.events.insertAction(a["true"])}else{core.events.insertAction(a["false"])}core.doAction()};events.prototype._action_switch=function(b,g,h,f){var d=core.calValue(b.condition,f);var e=[];for(var c=0;c<b.caseList.length;c++){var a=b.caseList[c]["case"];if(a=="default"||core.calValue(a,f)==d){core.push(e,b.caseList[c].action);if(!b.caseList[c].nobreak){break}}}core.insertAction(e);core.doAction()};events.prototype._action_choices=function(b,e,f,d){b.choices=b.choices.filter(function(h){if(h.condition==null||h.condition==""){return true}try{return core.calValue(h.condition,d)}catch(g){return true}});if(b.choices.length==0){return this.doAction()}if(core.isReplaying()){var a=core.status.replay.toReplay.shift(),c;if(a=="turn"){a=core.status.replay.toReplay.shift()}if(a.indexOf("choices:")==0&&((c=parseInt(a.substring(8)))>=0)&&c<b.choices.length){core.status.event.selection=c;setTimeout(function(){core.status.route.push("choices:"+c);core.insertAction(b.choices[c].action);core.doAction()},core.status.replay.speed==24?1:750/Math.max(1,core.status.replay.speed))}else{core.control._replay_error(a);return}}core.ui.drawChoices(b.text,b.choices)};events.prototype._action_confirm=function(b,e,f,d){core.status.event.ui={text:b.text,yes:b.yes,no:b.no};if(core.isReplaying()){var a=core.status.replay.toReplay.shift(),c;if(a=="turn"){a=core.status.replay.toReplay.shift()}if(a.indexOf("choices:")==0&&((c=parseInt(a.substring(8)))>=0)&&c<2){core.status.event.selection=c;setTimeout(function(){core.status.route.push("choices:"+c);if(c==0){core.insertAction(b.yes)}else{core.insertAction(b.no)}core.doAction()},core.status.replay.speed==24?1:750/Math.max(1,core.status.replay.speed))}else{core.control._replay_error(a);return}}else{core.status.event.selection=b["default"]?0:1}core.ui.drawConfirmBox(b.text)};events.prototype._action_while=function(a,c,d,b){if(core.calValue(a.condition,b)){core.unshift(core.status.event.data.list,{todo:core.clone(a.data),total:core.clone(a.data),condition:a.condition})}core.doAction()};events.prototype._action_dowhile=function(a,c,d,b){core.unshift(core.status.event.data.list,{todo:core.clone(a.data),total:core.clone(a.data),condition:a.condition});core.doAction()};events.prototype._action_break=function(a,c,d,b){core.status.event.data.list.shift();core.doAction()};events.prototype._action_continue=function(a,c,d,b){if(core.calValue(core.status.event.data.list[0].condition,b)){core.status.event.data.list[0].todo=core.clone(core.status.event.data.list[0].total)}else{core.status.event.data.list.shift()}core.doAction()};events.prototype._action_win=function(a,c,d,b){this.win(a.reason,a.norank)};events.prototype._action_lose=function(a,c,d,b){this.lose(a.reason)};events.prototype._action_restart=function(a,c,d,b){core.restart()};events.prototype._action_function=function(data,x,y,prefix){var func=data["function"];try{if(typeof func=="string"&&func.indexOf("function")==0){eval("("+func+")()")}}catch(e){main.log(e)}if(!data.async){core.doAction()}};events.prototype._action_update=function(a,c,d,b){core.updateStatusBar();core.doAction()};events.prototype._action_showStatusBar=function(a,c,d,b){core.showStatusBar();core.doAction()};events.prototype._action_hideStatusBar=function(a,c,d,b){core.hideStatusBar(a.toolbox);core.doAction()};events.prototype._action_updateEnemys=function(a,c,d,b){core.enemys.updateEnemys();core.updateStatusBar();core.doAction()};events.prototype._action_vibrate=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.vibrate,a.time)};events.prototype._action_sleep=function(a,c,d,b){core.timeout.sleepTimeout=setTimeout(function(){core.timeout.sleepTimeout=null;core.doAction()},core.isReplaying()?Math.min(a.time,20):a.time)};events.prototype._action_wait=function(b,e,f,c){if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("input:")==0){var d=parseInt(a.substring(6));core.status.route.push("input:"+d);this.__action_wait_getValue(d)}else{main.log("录像文件出错！当前需要一个 input: 项，实际为 "+a);core.stopReplay();core.insertAction(["录像文件出错，请在控制台查看报错信息。",{type:"exit"}])}core.doAction();return}};events.prototype.__action_wait_getValue=function(c){if(c>=1000000){core.setFlag("type",1);var a=parseInt((c-1000000)/1000),b=c%1000;core.setFlag("px",a);core.setFlag("py",b);core.setFlag("x",parseInt(a/32));core.setFlag("y",parseInt(b/32))}else{if(c>=10000){core.setFlag("type",1);var d=parseInt((c-10000)/100),e=c%100;core.setFlag("px",32*d+16);core.setFlag("py",32*e+16);core.setFlag("x",d);core.setFlag("y",e)}else{if(c>0){core.setFlag("type",0);core.setFlag("keycode",c)}}}};events.prototype._action_waitAsync=function(a,d,e,b){var c=window.setInterval(function(){if(!core.hasAsync()){clearInterval(c);core.doAction()}},50)};events.prototype._action_revisit=function(b,d,e,c){var a=core.getBlock(d,e);if(a!=null&&a.block.event.trigger=="action"){this.setEvents(a.block.event.data)}core.doAction()};events.prototype._action_callBook=function(a,d,f,c){if(core.isReplaying()||!core.hasItem("book")){core.doAction()}else{var b=core.clone(core.status.event.data);core.ui.closePanel();core.openBook();core.status.event.interval=b}};events.prototype._action_callSave=function(a,d,f,c){if(core.isReplaying()||core.hasFlag("__events__")){core.removeFlag("__events__");core.doAction()}else{var b=core.clone(core.status.event.data);core.ui.closePanel();core.save();core.status.event.interval=b}};events.prototype._action_autoSave=function(a,c,d,b){core.autosave();if(!a.nohint){core.drawTip("已自动存档")}core.doAction()};events.prototype._action_callLoad=function(a,d,f,c){if(this.__action_checkReplaying()){return}var b=core.clone(core.status.event.data);core.ui.closePanel();core.load();core.status.event.interval=b};events.prototype._action_exit=function(a,c,d,b){this.setEvents([]);core.doAction()};events.prototype._action_previewUI=function(a,c,d,b){this.insertAction(a.action);core.doAction()};events.prototype._action_clearMap=function(a,c,d,b){core.ui._uievent_clearMap(a);core.doAction()};events.prototype._action_fillText=function(a,c,d,b){core.ui._uievent_fillText(a);core.doAction()};events.prototype._action_fillBoldText=function(a,c,d,b){core.ui._uievent_fillBoldText(a);core.doAction()};events.prototype._action_fillRect=function(a,c,d,b){core.ui._uievent_fillRect(a);core.doAction()};events.prototype._action_fillPolygon=function(a,c,d,b){core.ui._uievent_fillPolygon(a);core.doAction()};events.prototype._action_strokeRect=function(a,c,d,b){core.ui._uievent_strokeRect(a);core.doAction()};events.prototype._action_strokePolygon=function(a,c,d,b){core.ui._uievent_strokePolygon(a);core.doAction()};events.prototype._action_fillCircle=function(a,c,d,b){core.ui._uievent_fillCircle(a);core.doAction()};events.prototype._action_strokeCircle=function(a,c,d,b){core.ui._uievent_strokeCircle(a);core.doAction()};events.prototype._action_drawLine=function(a,c,d,b){core.ui._uievent_drawLine(a);core.doAction()};events.prototype._action_drawArrow=function(a,c,d,b){core.ui._uievent_drawArrow(a);core.doAction()};events.prototype._action_setAttribute=function(a,c,d,b){core.ui._uievent_setAttribute(a);core.doAction()};events.prototype._action_drawImage=function(a,c,d,b){core.ui._uievent_drawImage(a);core.doAction()};events.prototype._action_drawIcon=function(a,c,d,b){core.ui._uievent_drawIcon(a);core.doAction()};events.prototype._action_drawSelector=function(a,c,d,b){core.ui._uievent_drawSelector(a);core.doAction()};events.prototype._action_drawBackground=function(a,c,d,b){core.ui._uievent_drawBackground(a);core.doAction()};events.prototype._action_drawTextContent=function(a,c,d,b){core.ui._uievent_drawTextContent(a);core.doAction()};events.prototype._checkStatus=function(c,b,a){if(b&&core.status.event.id==c){core.ui.closePanel();return false}if(b&&core.status.lockControl){return false}if(a&&!core.hasItem(c)){core.drawTip("你没有"+core.material.items[c].name);return false}if(core.isMoving()){core.drawTip("请先停止勇士行动");return false}core.lockControl();core.status.event.id=c;return true};events.prototype.openBook=function(a){if(core.isReplaying()){return}if(core.status.event.id=="book"&&core.events.recoverEvents(core.status.event.interval)){return}if(core.status.event.id=="book"&&core.status.event.ui){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.ui);return}if(core.status.event.id=="viewMaps"){a=false;core.status.event.ui=core.status.event.data}if(!this._checkStatus("book",a,true)){return}core.useItem("book",true)};events.prototype.useFly=function(a){if(core.isReplaying()){return}if(!this._checkStatus("fly",a,true)){return}if(core.flags.flyNearStair&&!core.nearStair()){core.drawTip("只有在楼梯边才能使用传送器");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}if(!core.canUseItem("fly")){core.drawTip("楼层传送器好像失效了");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}core.useItem("fly",true);return};events.prototype.flyTo=function(b,a){return this.eventdata.flyTo(b,a)};events.prototype.openEquipbox=function(a){if(core.isReplaying()){return}if(!this._checkStatus("equipbox",a)){return}core.ui.drawEquipbox()};events.prototype.openToolbox=function(a){if(core.isReplaying()){return}if(!this._checkStatus("toolbox",a)){return}core.ui.drawToolbox()};events.prototype.openQuickShop=function(a){if(core.isReplaying()){return}if(Object.keys(core.status.shops).length==0){core.drawTip("本塔没有快捷商店！");return}if(Object.keys(core.status.shops).length==1){var c=Object.keys(core.status.shops)[0];if(core.status.event.id!=null||!this._checkStatus("shop",false)){return}var b=core.events.canUseQuickShop(c);if(!core.flags.enableDisabledShop&&b){core.drawText(b);return}core.events.openShop(c,true);return}if(!this._checkStatus("selectShop",a)){return}core.ui.drawQuickShop()};events.prototype.openKeyBoard=function(a){if(core.isReplaying()){return}if(!this._checkStatus("keyBoard",a)){return}core.ui.drawKeyBoard()};events.prototype.save=function(a){if(core.isReplaying()){return}if(core.status.event.id=="save"&&core.events.recoverEvents(core.status.event.interval)){return}if(!this._checkStatus("save",a)){return}var d=core.saves.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;core.ui.drawSLPanel(10*c+b)};events.prototype.load=function(a){if(core.isReplaying()){return}var d=core.saves.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;if(!core.isPlaying()){core.dom.startPanel.style.display="none";core.clearStatus();core.clearMap("all");core.status.event={id:"load",data:null};core.status.lockControl=true;core.ui.drawSLPanel(10*c+b);return}if(core.status.event.id=="load"&&core.events.recoverEvents(core.status.event.interval)){return}if(!this._checkStatus("load",a)){return}core.ui.drawSLPanel(10*c+b)};events.prototype.openSettings=function(a){if(core.isReplaying()){return}if(!this._checkStatus("settings",a)){return}core.ui.drawSettings()};events.prototype.hasAsync=function(){return Object.keys(core.animateFrame.asyncId).length>0||(core.status.animateObjs||[]).length>0};events.prototype.follow=function(a){core.status.hero.followers=core.status.hero.followers||[];a=core.getMappedName(a);if(core.material.images.images[a]){core.status.hero.followers.push({name:a});core.gatherFollowers();core.clearMap("hero");core.drawHero()}};events.prototype.unfollow=function(b){core.status.hero.followers=core.status.hero.followers||[];if(!b){core.status.hero.followers=[]}else{b=core.getMappedName(b);for(var a=0;a<core.status.hero.followers.length;a++){if(core.status.hero.followers[a].name==b){core.status.hero.followers.splice(a,1);break}}}core.gatherFollowers();core.clearMap("hero");core.drawHero()};events.prototype.setValue=function(b,d,c,a){var d=core.calValue(d,c);if(a){d+=core.calValue(b,c)}this._setValue_setStatus(b,d);this._setValue_setItem(b,d);this._setValue_setFlag(b,d);this._setValue_setSwitch(b,d,c);this._setValue_setGlobal(b,d);core.updateStatusBar()};events.prototype._setValue_setStatus=function(a,b){if(a.indexOf("status:")!==0){return}core.setStatus(a.substring(7),b);if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose()}};events.prototype._setValue_setItem=function(c,d){if(c.indexOf("item:")!==0){return}var b=c.substring(5),a=core.itemCount(b);if(d>a){core.getItem(b,d-a)}else{core.setItem(b,d)}};events.prototype._setValue_setFlag=function(a,b){if(a.indexOf("flag:")!==0){return}core.setFlag(a.substring(5),b)};events.prototype._setValue_setSwitch=function(a,c,b){if(a.indexOf("switch:")!==0){return}core.setFlag((b||":f@x@y")+"@"+a.substring(7),c)};events.prototype._setValue_setGlobal=function(a,b){if(a.indexOf("global:")!==0){return}core.setGlobal(a.substring(7),b)};events.prototype.addValue=function(a,c,b){this.setValue(a,c,b,true)};events.prototype.doEffect=function(a,b,c){a.split(";").forEach(function(e){var d=e.split("+=");if(d.length!=2){return}var f=d[0],g=core.calValue(d[1],null,b,c);core.addValue(f,g)})};events.prototype.setFloorInfo=function(b,d,a,c){a=a||core.status.floorId;core.status.maps[a][b]=core.calValue(d,c);core.updateStatusBar()};events.prototype.setGlobalAttribute=function(name,value){if(typeof value=="string"){if((value.charAt(0)=='"'&&value.charAt(value.length-1)=='"')||(value.charAt(0)=="'"&&value.charAt(value.length-1)=="'")){value=value.substring(1,value.length-1)}if(value.charAt(0)=="["&&value.charAt(value.length-1)=="]"){value=eval(value)}}core.status.globalAttribute[name]=value;core.updateGlobalAttribute(name);core.setFlag("globalAttribute",core.status.globalAttribute)};events.prototype.setGlobalFlag=function(b,c){var a=core.getFlag("globalFlags",{});a[b]=c;core.flags[b]=c;core.setFlag("globalFlags",a);core.resize()};events.prototype.closeDoor=function(g,h,d,b){d=d||"";if(!(d.endsWith("Door")||d.endsWith("Wall"))||core.material.icons.animates[d]==null||core.getBlock(g,h)!=null){if(b){b()}return}core.playSound("door.mp3");var c=core.material.icons.animates[d];var e=d.endsWith("Door")?30:70,f=0;var a=window.setInterval(function(){f++;if(f==4){clearInterval(a);delete core.animateFrame.asyncId[a];core.setBlock(core.getNumberById(d),g,h);if(b){b()}return}core.clearMap("event",32*g,32*h,32,32);core.drawImage("event",core.material.images.animates,32*(4-f),32*c,32,32,32*g,32*h,32,32)},core.status.replay.speed==24?1:e/Math.max(core.status.replay.speed,1));core.animateFrame.asyncId[a]=true};events.prototype.showImage=function(b,e,k,f,i,o,a){if(typeof e=="string"){e=core.getMappedName(e);e=core.material.images.images[e]}if(!e){if(a){a()}return}k=k||[];var m=core.calValue(k[0])||0,n=core.calValue(k[1])||0;var l=core.calValue(k[2]),j=core.calValue(k[3]);if(l==null){l=e.width}if(j==null){j=e.height}f=f||[];var q=core.calValue(f[0])||0,r=core.calValue(f[1])||0;var p=core.calValue(f[2]),d=core.calValue(f[3]);if(p==null){p=l}if(d==null){d=j}var s=b+100;o=o||0;var g="image"+s;var c=core.createCanvas(g,q,r,p,d,s);c.drawImage(e,m,n,l,j,0,0,p,d);if(o==0){core.setOpacity(g,i);if(a){a()}return}core.setOpacity(g,0);this.moveImage(b,null,i,o,a)};events.prototype.hideImage=function(b,d,a){d=d||0;var c="image"+(b+100);if(d==0||!core.dymCanvas[c]){core.deleteCanvas(c);if(a){a()}return}this.moveImage(b,null,0,d,function(){core.deleteCanvas(c);if(a){a()}})};events.prototype.moveImage=function(c,k,i,j,a){j=j||1000;k=k||[];var g="image"+(c+100);if(!core.dymCanvas[g]){if(a){a()}return}var f=function(o,p){o=core.calValue(o);return o!=null?o:p};var b=core.dymCanvas[g].canvas;var d=parseFloat(b.getAttribute("_left")),e=parseFloat(b.getAttribute("_top")),m=f(k[0],d),n=f(k[1],e);var h=parseFloat(b.style.opacity),l=f(i,h);this._moveImage_moving(g,{fromX:d,fromY:e,toX:m,toY:n,opacity:h,toOpacity:l,time:j/Math.max(core.status.replay.speed,1)},a)};events.prototype._moveImage_moving=function(i,h,b){var k=10,l=0,m=parseInt(h.time/10);var f=h.fromX,g=h.fromY,o=h.toX,p=h.toY,j=h.opacity,n=h.toOpacity;var d=f,e=g,c=j;var a=setInterval(function(){l++;c=j+(n-j)*l/m;d=parseInt(f+(o-f)*l/m);e=parseInt(g+(p-g)*l/m);core.setOpacity(i,c);core.relocateCanvas(i,d,e);if(l==m){core.setOpacity(i,n);delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},k);core.animateFrame.asyncId[a]=true};events.prototype.showGif=function(c,d,e){c=core.getMappedName(c);var b=core.material.images.images[c];if(b){var a=new Image();a.src=b.src;a.style.position="absolute";a.style.left=d*core.domStyle.scale+"px";a.style.top=e*core.domStyle.scale+"px";a.style.width=b.width*core.domStyle.scale+"px";a.style.height=b.height*core.domStyle.scale+"px";core.dom.gif2.appendChild(a)}else{core.dom.gif2.innerHTML=""}};events.prototype.setVolume=function(i,h,a){var e=function(j){core.musicStatus.volume=j;if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].volume=j}};if(!h||h<100){e(i);if(a){a()}return}var b=core.musicStatus.volume;h/=Math.max(core.status.replay.speed,1);var d=10,f=0,g=parseInt(h/d);var c=setInterval(function(){f++;e(b+(i-b)*f/g);if(f>=g){delete core.animateFrame.asyncId[c];clearInterval(c);if(a){a()}}},d);core.animateFrame.asyncId[c]=true};events.prototype.vibrate=function(d,b){if(core.isReplaying()){if(b){b()}return}if(!d||d<1000){d=1000}d/=Math.max(core.status.replay.speed,1);d=Math.ceil(d/500)*500;var c={duration:d*3/50,speed:5,power:5,direction:1,shake:0};var a=setInterval(function(){core.events._vibrate_update(c);core.control.addGameCanvasTranslate(c.shake,0);if(c.duration===0){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},50/3);core.animateFrame.asyncId[a]=true};events.prototype._vibrate_update=function(b){if(b.duration>=1||b.shake!=0){var a=(b.power*b.speed*b.direction)/10;if(b.duration<=1&&b.shake*(b.shake+a)<0){b.shake=0}else{b.shake+=a}if(b.shake>b.power*2){b.direction=-1}if(b.shake<-b.power*2){b.direction=1}if(b.duration>=1){b.duration-=1}}};events.prototype.eventMoveHero=function(e,f,b){f=f||core.values.moveSpeed||100;var d=0,c=(e||[]).filter(function(g){return["up","down","left","right","forward","backward"].indexOf(g)>=0});var a=window.setInterval(function(){if(c.length==0){delete core.animateFrame.asyncId[a];clearInterval(a);core.drawHero();if(b){b()}}else{if(core.events._eventMoveHero_moving(++d,c)){d=0}}},core.status.replay.speed==24?1:f/8/core.status.replay.speed);core.animateFrame.asyncId[a]=true};events.prototype._eventMoveHero_moving=function(d,b){var a=b[0],e=core.getHeroLoc("x"),f=core.getHeroLoc("y");var c=a=="backward"?-1:1;if(a=="forward"||a=="backward"){a=core.getHeroLoc("direction")}core.setHeroLoc("direction",a);if(d<=4){core.drawHero("leftFoot",4*c*d)}else{if(d<=8){core.drawHero("rightFoot",4*c*d)}}if(d==8){core.setHeroLoc("x",e+c*core.utils.scan[a].x,true);core.setHeroLoc("y",f+c*core.utils.scan[a].y,true);core.updateFollowers();b.shift();return true}return false};events.prototype.jumpHero=function(b,c,g,a){var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");if(b==null){b=e}if(c==null){c=f}var e=core.status.hero.loc.x,f=core.status.hero.loc.y;if(!core.isset(b)){b=e}if(!core.isset(c)){c=f}core.playSound("jump.mp3");var d=core.maps.__generateJumpInfo(e,f,b,c,g||500);d.icon=core.material.icons.hero[core.getHeroLoc("direction")];d.width=core.material.icons.hero.width||32;d.height=core.material.icons.hero.height;this._jumpHero_doJump(d,a)};events.prototype._jumpHero_doJump=function(c,b){var a=window.setInterval(function(){if(c.jump_count>0){core.events._jumpHero_jumping(c)}else{core.events._jumpHero_finished(a,c.ex,c.ey,b)}},c.per_time);core.animateFrame.asyncId[a]=true};events.prototype._jumpHero_jumping=function(b){core.clearMap("hero");core.maps.__updateJumpInfo(b);var c=b.px,d=b.py,e=b.width||32,a=b.height;core.bigmap.offsetX=core.clamp(c-32*core.__HALF_SIZE__,0,32*core.bigmap.width-core.__PIXELS__);core.bigmap.offsetY=core.clamp(d-32*core.__HALF_SIZE__,0,32*core.bigmap.height-core.__PIXELS__);core.control.updateViewport();core.drawImage("hero",core.material.images.hero,b.icon.stop,b.icon.loc*a,e,a,c+(32-e)/2-core.bigmap.offsetX,d+32-a-core.bigmap.offsetY,e,a)};events.prototype._jumpHero_finished=function(a,c,d,b){delete core.animateFrame.asyncId[a];clearInterval(a);core.setHeroLoc("x",c);core.setHeroLoc("y",d);core.drawHero();if(b){b()}};events.prototype.openShop=function(c,a){var b=core.status.shops[c];b.times=b.times||0;if(b.commonTimes){b.times=core.getFlag("commonTimes",0)}if(a&&!b.visited){if(!core.flags.enableDisabledShop||b.commonEvent){if(b.times==0){core.drawTip("该项尚未开启")}else{core.drawTip("该项已失效")}return}else{core.drawTip("该商店尚未开启，只能浏览不可使用")}}else{b.visited=true}if(b.commonEvent){core.status.route.push("shop:"+c+":0");core.insertAction({type:"insert",name:b.commonEvent,args:b.args});return}core.ui.drawShop(c)};events.prototype._useShop=function(e,b){var d=core.events.canUseQuickShop(e.id);if(!d&&!e.visited){d=e.times?"该商店已失效":"该商店尚未开启"}if(d){core.drawTip(d);return false}var g=e.use,a=e.choices[b];var f=e.times,c=core.calValue(a.need||e.need,null,null,f);if(c>core.getStatus(g)){core.drawTip("你的"+(g=="money"?"金币":"经验")+"不足");return false}core.status.event.selection=b;core.status.event.data.actions.push(b);core.setStatus(g,core.getStatus(g)-c);core.doEffect(a.effect,c,f);core.updateStatusBar();e.times++;if(e.commonTimes){core.setFlag("commonTimes",e.times)}this.openShop(e.id);return true};events.prototype._exitShop=function(){if(core.status.event.data.actions.length>0){core.status.route.push("shop:"+core.status.event.data.id+":"+core.status.event.data.actions.join(""))}core.status.event.data.actions=[];core.status.boxAnimateObjs=[];if(core.status.event.data.fromList){core.ui.drawQuickShop()}else{core.ui.closePanel()}};events.prototype.disableQuickShop=function(a){core.status.shops[a].visited=false};events.prototype.canUseQuickShop=function(a){return this.eventdata.canUseQuickShop(a)};events.prototype.setHeroIcon=function(b,c){b=core.getMappedName(b);var a=core.material.images.images[b];if(!a){return}core.setFlag("heroIcon",b);core.material.images.hero=a;core.material.icons.hero.width=a.width/4;core.material.icons.hero.height=a.height/4;core.control.updateHeroIcon(b);if(!c){core.drawHero()}};events.prototype.checkLvUp=function(){var a=[];while(true){var b=this._checkLvUp_check();if(b==null){break}a=a.concat(b)}if(a.length>0){core.insertAction(a)}};events.prototype._checkLvUp_check=function(){if(!core.flags.enableLevelUp||!core.firstData.levelUp||core.status.hero.lv>=core.firstData.levelUp.length){return null}var b=(core.firstData.levelUp[core.status.hero.lv]||{});var a=core.calValue(b.need);if(a==null){return null}if(core.status.hero.experience>=a){core.status.hero.lv++;if(b.clear){core.status.hero.experience-=a}return b.action||[]}return null};events.prototype.tryUseItem=function(a){core.ui.closePanel();if(a=="book"){return core.openBook(false)}if(a=="fly"){return core.useFly(false)}if(a=="centerFly"){return core.ui.drawCenterFly()}if(core.canUseItem(a)){core.useItem(a)}else{core.drawTip("当前无法使用"+core.material.items[a].name)}};events.prototype.afterUseBomb=function(){return this.eventdata.afterUseBomb()};events.prototype._uploadCurrent=function(b){var a=new FormData();a.append("type","score");a.append("name",core.firstData.name);a.append("version",core.firstData.version);a.append("platform",core.platform.string);a.append("hard",core.encodeBase64(core.status.hard));a.append("username",core.encodeBase64(b||"current"));a.append("lv",core.status.hero.lv);a.append("hp",Math.min(core.status.hero.hp,Math.pow(2,63)));a.append("atk",core.status.hero.atk);a.append("def",core.status.hero.def);a.append("mdef",core.status.hero.mdef);a.append("money",core.status.hero.money);a.append("experience",core.status.hero.experience);a.append("steps",core.status.hero.steps);a.append("seed",core.getFlag("__seed__"));a.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));a.append("route",core.encodeRoute(core.status.route));a.append("deler","current");a.append("base64",1);core.http("POST","/games/upload.php",a)};"use strict";function actions(){this._init();this.SIZE=core.__SIZE__;this.HSIZE=core.__HALF_SIZE__;this.LAST=this.SIZE-1;this.CHOICES_LEFT=5;this.CHOICES_RIGHT=this.LAST-this.CHOICES_LEFT}actions.prototype._init=function(){this.actionsdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.actions;this.actions={};this.registerAction("onkeyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onkeyDown","_sys_onkeyDown",this._sys_onkeyDown,0);this.registerAction("onkeyUp","_sys_onkeyUp_replay",this._sys_onkeyUp_replay,100);this.registerAction("onkeyUp","_sys_onkeyUp",this._sys_onkeyUp,0);this.registerAction("pressKey","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("pressKey","_sys_pressKey",this._sys_pressKey,0);this.registerAction("keyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("keyDown","_sys_keyDown_lockControl",this._sys_keyDown_lockControl,50);this.registerAction("keyDown","_sys_keyDown",this._sys_keyDown,0);this.registerAction("keyUp","_sys_keyUp_replay",this._sys_keyUp_replay,100);this.registerAction("keyUp","_sys_keyUp_lockControl",this._sys_keyUp_lockControl,50);this.registerAction("keyUp","_sys_keyUp",this._sys_keyUp,0);this.registerAction("ondown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("ondown","_sys_ondown_paint",this._sys_ondown_paint,60);this.registerAction("ondown","_sys_ondown_lockControl",this._sys_ondown_lockControl,30);this.registerAction("ondown","_sys_ondown",this._sys_ondown,0);this.registerAction("onmove","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onmove","_sys_onmove_paint",this._sys_onmove_paint,50);this.registerAction("onmove","_sys_onmove",this._sys_onmove,0);this.registerAction("onup","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onup","_sys_onup_paint",this._sys_onup_paint,50);this.registerAction("onup","_sys_onup",this._sys_onup,0);this.registerAction("onclick","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onclick","_sys_onclick_lockControl",this._sys_onclick_lockControl,50);this.registerAction("onclick","_sys_onclick",this._sys_onclick,0);this.registerAction("onmousewheel","_sys_onmousewheel",this._sys_onmousewheel,0);this.registerAction("keyDownCtrl","_sys_keyDownCtrl",this._sys_keyDownCtrl,0);this.registerAction("longClick","_sys_longClick_lockControl",this._sys_longClick_lockControl,50);this.registerAction("longClick","_sys_longClick",this._sys_longClick,0)};actions.prototype.registerAction=function(a,c,b,d){if(!c||!b){return}d=d||0;if(!this.actions[a]){this.actions[a]=[]}this.unregisterAction(a,c);this.actions[a].push({action:a,name:c,func:b,priority:d});this.actions[a]=this.actions[a].sort(function(e,f){return f.priority-e.priority})};actions.prototype.unregisterAction=function(a,b){if(!this.actions[a]){return}this.actions[a]=this.actions[a].filter(function(c){return c.name!=b})};actions.prototype.doRegisteredAction=function(a){var b=this.actions[a];if(!b){return false}for(var d=0;d<b.length;++d){try{if(core.doFunc.apply(core,[b[d].func,this].concat(Array.prototype.slice.call(arguments,1)))){return true}}catch(c){main.log(c);main.log("ERROR in actions["+b[d].name+"].")}}return false};actions.prototype._checkReplaying=function(){if(core.isReplaying()&&["save","book","book-detail","viewMaps","toolbox","equipbox","text"].indexOf(core.status.event.id)<0){return true}return false};actions.prototype._sys_checkReplay=function(){if(this._checkReplaying()){return true}};actions.prototype.onkeyDown=function(a){this.doRegisteredAction("onkeyDown",a)};actions.prototype._sys_onkeyDown=function(a){core.status.holdingKeys=core.status.holdingKeys||[];var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){return}}a.preventDefault();core.status.holdingKeys.push(a.keyCode);this.pressKey(a.keyCode)}else{if(a.keyCode==17){core.status.ctrlDown=true}this.keyDown(a.keyCode)}};actions.prototype.onkeyUp=function(a){this.doRegisteredAction("onkeyUp",a)};actions.prototype._sys_onkeyUp_replay=function(a){if(this._checkReplaying()){if(a.keyCode==27){core.stopReplay()}else{if(a.keyCode==90){core.speedDownReplay()}else{if(a.keyCode==88){core.speedUpReplay()}else{if(a.keyCode==32){core.triggerReplay()}else{if(a.keyCode==65){core.rewindReplay()}else{if(a.keyCode==83){core.saveReplay()}else{if(a.keyCode==67){core.bookReplay()}else{if(a.keyCode==33||a.keyCode==34){core.viewMapReplay()}else{if(a.keyCode==78){core.stepReplay()}else{if(a.keyCode==84){core.toolboxReplay()}else{if(a.keyCode==81){core.equipboxReplay()}else{if(a.keyCode==66){core.drawStatistics()}else{if(a.keyCode>=49&&a.keyCode<=51){core.setReplaySpeed(a.keyCode-48)}else{if(a.keyCode==52){core.setReplaySpeed(6)}else{if(a.keyCode==53){core.setReplaySpeed(12)}else{if(a.keyCode==54){core.setReplaySpeed(24)}}}}}}}}}}}}}}}}return true}};actions.prototype._sys_onkeyUp=function(a){var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));if(b===core.status.holdingKeys.length&&core.status.holdingKeys.length!==0){core.pressKey(core.status.holdingKeys.slice(-1)[0])}break}}a.preventDefault();this.keyUp(a.keyCode,a.altKey)}else{if(a.keyCode==17){core.status.ctrlDown=false}this.keyUp(a.keyCode,a.altKey)}};actions.prototype.pressKey=function(a){this.doRegisteredAction("pressKey",a)};actions.prototype._sys_pressKey=function(a){if(a===core.status.holdingKeys.slice(-1)[0]){this.keyDown(a);window.setTimeout(function(){core.pressKey(a)},30)}};actions.prototype.keyDown=function(a){this.doRegisteredAction("keyDown",a)};actions.prototype._sys_keyDown_lockControl=function(a){if(!core.status.lockControl){return false}if(a==17){this.keyDownCtrl();return true}switch(core.status.event.id){case"action":this._keyDownAction(a);break;case"book":this._keyDownBook(a);break;case"fly":this._keyDownFly(a);break;case"viewMaps":this._keyDownViewMaps(a);break;case"equipbox":this._keyDownEquipbox(a);break;case"toolbox":this._keyDownToolbox(a);break;case"save":case"load":case"replayLoad":case"replayRemain":this._keyDownSL(a);break;case"shop":this._keyDownShop(a);break;case"selectShop":case"switchs":case"settings":case"syncSave":case"syncSelect":case"localSaveSelect":case"storageRemove":case"replay":case"gameInfo":this._keyDownChoices(a);break;case"cursor":this._keyDownCursor(a);break}return true};actions.prototype._sys_keyDown=function(a){if(!core.status.played){return true}switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break}return true};actions.prototype.keyUp=function(c,a,b){this.doRegisteredAction("keyUp",c,a,b)};actions.prototype._sys_keyUp_replay=function(c,a,b){if(!b&&this._checkReplaying()){return true}};actions.prototype._sys_keyUp_lockControl=function(b,a){if(!core.status.lockControl){return false}var c=function(){return b==27||b==88||b==13||b==32||b==67};core.status.holdingKeys=[];switch(core.status.event.id){case"text":c()&&core.drawText();break;case"confirmBox":this._keyUpConfirmBox(b);break;case"action":this._keyUpAction(b);break;case"about":c()&&core.closePanel();break;case"help":c()&&core.closePanel();break;case"book":this._keyUpBook(b);break;case"book-detail":c()&&this._clickBookDetail();break;case"fly":this._keyUpFly(b);break;case"viewMaps":this._keyUpViewMaps(b);break;case"shop":this._keyUpShop(b);break;case"selectShop":this._keyUpQuickShop(b);break;case"toolbox":this._keyUpToolbox(b);break;case"equipbox":this._keyUpEquipbox(b,a);break;case"save":case"load":case"replayLoad":case"replayRemain":this._keyUpSL(b);break;case"keyBoard":c()&&core.closePanel();break;case"switchs":this._keyUpSwitchs(b);break;case"settings":this._keyUpSettings(b);break;case"syncSave":this._keyUpSyncSave(b);break;case"syncSelect":this._keyUpSyncSelect(b);break;case"localSaveSelect":this._keyUpLocalSaveSelect(b);break;case"storageRemove":this._keyUpStorageRemove(b);break;case"cursor":this._keyUpCursor(b);break;case"replay":this._keyUpReplay(b);break;case"gameInfo":this._keyUpGameInfo(b);break;case"centerFly":this._keyUpCenterFly(b);break;case"paint":this._keyUpPaint(b);break}return true};actions.prototype._sys_keyUp=function(b,a){if(!core.status.played){return true}this.actionsdata.onKeyUp(b,a);if(core.status.automaticRoute&&core.status.automaticRoute.autoHeroMove){core.stopAutomaticRoute()}core.status.heroStop=true;return true};actions.prototype.ondown=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("ondown",d,e,b,c)};actions.prototype._sys_ondown_paint=function(c,d,a,b){if(core.status.played&&(core.status.event||{}).id=="paint"){this._ondownPaint(a,b);return true}};actions.prototype._sys_ondown_lockControl=function(c,d,a,b){if(core.status.played&&!core.status.lockControl){return false}if(core.status.event.id=="action"&&core.status.event.data.type=="wait"){core.setFlag("type",1);core.setFlag("x",c);core.setFlag("y",d);core.setFlag("px",a);core.setFlag("py",b);core.status.route.push("input:"+(1000000+1000*a+b));core.doAction()}else{core.actions.onclick(c,d,[])}if(core.timeout.onDownTimeout==null){core.timeout.onDownTimeout=setTimeout(function(){if(core.interval.onDownInterval==null){core.interval.onDownInterval=setInterval(function(){if(!core.actions.longClick(c,d,true)){clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null}},40)}},500)}return true};actions.prototype._sys_ondown=function(d,e,b,c){core.status.downTime=new Date();core.deleteCanvas("route");var a={x:d,y:e};core.status.stepPostfix=[];core.status.stepPostfix.push(a);core.fillPosWithPoint(a)};actions.prototype.onmove=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("onmove",d,e,b,c)};actions.prototype._sys_onmove_paint=function(c,d,a,b){if(core.status.played&&(core.status.event||{}).id=="paint"){core.actions._onmovePaint(a,b);return true}};actions.prototype._sys_onmove=function(g,h){if((core.status.stepPostfix||[]).length>0){var e={x:g,y:h};var f=core.status.stepPostfix[core.status.stepPostfix.length-1];var a=[e.y-f.y,f.x-e.x,f.y-e.y,e.x-f.x];var d=0,c=4;for(var b=0;b<4;b++){if(a[b]>d){c=b;d=a[b]}}e=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},false][c];if(e){e.x+=f.x;e.y+=f.y;core.status.stepPostfix.push(e);core.fillPosWithPoint(e)}}return true};actions.prototype.onup=function(){this.doRegisteredAction("onup")};actions.prototype._sys_onup_paint=function(){if(core.status.played&&(core.status.event||{}).id=="paint"){this._onupPaint();return true}};actions.prototype._sys_onup=function(){clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null;if((core.status.stepPostfix||[]).length==0){return false}var g=[];var a={"0":{"1":"down","-1":"up"},"-1":{"0":"left"},"1":{"0":"right"}};for(var b=1;b<core.status.stepPostfix.length;b++){var d=core.status.stepPostfix[b-1];var c=core.status.stepPostfix[b];g.push({direction:a[c.x-d.x][c.y-d.y],x:c.x+parseInt(core.bigmap.offsetX/32),y:c.y+parseInt(core.bigmap.offsetY/32)})}var e=core.status.stepPostfix[0].x;var f=core.status.stepPostfix[0].y;core.status.stepPostfix=[];if(!core.status.lockControl){core.clearMap("ui")}if(!core.status.lockControl&&g.length==0&&core.status.downTime!=null&&new Date()-core.status.downTime>=1000){core.actions.longClick(e,f)}else{core.actions.onclick(e,f,g)}core.status.downTime=null;return true};actions.prototype._getClickLoc=function(f,g){var d={x:0,y:0};var c=32;c=c*core.domStyle.scale;if(core.domStyle.isVertical){d.x=0;d.y=core.dom.statusBar.offsetHeight+3}else{d.x=core.dom.statusBar.offsetWidth+3;d.y=0}var a=core.dom.gameGroup.offsetLeft+d.x;var e=core.dom.gameGroup.offsetTop+d.y;var b={x:f-a,y:g-e,size:c};return b};actions.prototype.onclick=function(b,c,a){this.doRegisteredAction("onclick",b,c,a||[])};actions.prototype._sys_onclick_lockControl=function(a,b){if(!core.status.lockControl){return false}switch(core.status.event.id){case"centerFly":this._clickCenterFly(a,b);break;case"book":this._clickBook(a,b);break;case"book-detail":this._clickBookDetail(a,b);break;case"fly":this._clickFly(a,b);break;case"viewMaps":this._clickViewMaps(a,b);break;case"switchs":this._clickSwitchs(a,b);break;case"settings":this._clickSettings(a,b);break;case"shop":this._clickShop(a,b);break;case"selectShop":this._clickQuickShop(a,b);break;case"equipbox":this._clickEquipbox(a,b);break;case"toolbox":this._clickToolbox(a,b);break;case"save":case"load":case"replayLoad":case"replayRemain":this._clickSL(a,b);break;case"confirmBox":this._clickConfirmBox(a,b);break;case"keyBoard":this._clickKeyBoard(a,b);break;case"action":this._clickAction(a,b);break;case"text":core.drawText();break;case"syncSave":this._clickSyncSave(a,b);break;case"syncSelect":this._clickSyncSelect(a,b);break;case"localSaveSelect":this._clickLocalSaveSelect(a,b);break;case"storageRemove":this._clickStorageRemove(a,b);break;case"cursor":this._clickCursor(a,b);break;case"replay":this._clickReplay(a,b);break;case"gameInfo":this._clickGameInfo(a,b);break;case"about":case"help":core.ui.closePanel();break}return true};actions.prototype._sys_onclick=function(b,c,a){core.setAutomaticRoute(b+parseInt(core.bigmap.offsetX/32),c+parseInt(core.bigmap.offsetY/32),a);return true};actions.prototype.onmousewheel=function(a){this.doRegisteredAction("onmousewheel",a)};actions.prototype._sys_onmousewheel=function(a){if(this._checkReplaying()){if(a==1){core.speedUpReplay()}if(a==-1){core.speedDownReplay()}return}if(core.status.lockControl&&core.status.event.id=="fly"){if(a==1){core.ui.drawFly(this._getNextFlyFloor(1))}if(a==-1){core.ui.drawFly(this._getNextFlyFloor(-1))}return}if(core.status.lockControl&&core.status.event.id=="book"){if(a==1){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==-1){core.ui.drawBook(core.status.event.data+this.HSIZE)}return}if(core.status.lockControl&&(core.status.event.id=="save"||core.status.event.id=="load")){var b=core.status.event.data.page*10+core.status.event.data.offset;if(a==1){core.ui.drawSLPanel(b-10)}if(a==-1){core.ui.drawSLPanel(b+10)}return}if(core.status.lockControl&&core.status.event.id=="viewMaps"){if(a==1){this._clickViewMaps(this.HSIZE,this.HSIZE-3)}if(a==-1){this._clickViewMaps(this.HSIZE,this.HSIZE+3)}return}if(core.status.lockControl&&core.status.event.id=="action"&&core.status.event.data.type=="wait"){core.setFlag("type",0);var c=a==1?33:34;core.setFlag("keycode",c);core.status.route.push("input:"+c);core.doAction();return}};actions.prototype.keyDownCtrl=function(){this.doRegisteredAction("keyDownCtrl")};actions.prototype._sys_keyDownCtrl=function(){if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction()}return true}};actions.prototype.longClick=function(b,c,a){if(!core.isPlaying()){return false}return this.doRegisteredAction("longClick",b,c,a)};actions.prototype._sys_longClick_lockControl=function(a,b){if(!core.status.lockControl){return false}if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="fly"){if((a==this.SIZE-2||a==this.SIZE-3)&&(b==this.HSIZE-1||b==this.HSIZE+3)){this._clickFly(a,b);return true}}if(["save","load","replayLoad","replayRemain"].indexOf(core.status.event.id)>=0){if([this.HSIZE-2,this.HSIZE-3,this.HSIZE+2,this.HSIZE+3].indexOf(a)>=0&&b==this.LAST){this._clickSL(a,b);return true}}if(core.status.event.id=="shop"&&a>=this.CHOICES_LEFT&&a<=this.CHOICES_RIGHT){return this._clickShop(a,b)}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction();return true}}return false};actions.prototype._sys_longClick=function(b,c,a){if(!core.status.lockControl&&!a){core.waitHeroToStop(function(){core.ui.drawKeyBoard()});return true}return false};actions.prototype._selectChoices=function(d,c,a){var e=this.HSIZE-parseInt((d-1)/2)+(core.status.event.ui.offset||0);if(c==13||c==32||c==67){a.apply(this,[this.HSIZE,e+core.status.event.selection])}if(c>=49&&c<=57){var b=c-49;if(b<d){a.apply(this,[this.HSIZE,e+b])}}};actions.prototype._keyDownChoices=function(a){if(a==38){core.status.event.selection--;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}if(a==40){core.status.event.selection++;core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices)}};actions.prototype._clickCenterFly=function(c,d){var a=core.status.event.data.posX,b=core.status.event.data.posY;core.ui.closePanel();if(c==a&&d==b){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}};actions.prototype._keyUpCenterFly=function(a){core.ui.closePanel();if(a==51||a==13||a==32||a==67){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.drawTip("当前不能使用中心对称飞行器")}}};actions.prototype._clickConfirmBox=function(a,b){if((a==this.HSIZE-2||a==this.HSIZE-1)&&b==this.HSIZE+1&&core.status.event.data.yes){core.status.event.data.yes()}if((a==this.HSIZE+2||a==this.HSIZE+1)&&b==this.HSIZE+1&&core.status.event.data.no){core.status.event.data.no()}};actions.prototype._keyUpConfirmBox=function(a){if(a==37){core.status.event.selection=0;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no);return}if(a==39){core.status.event.selection=1;core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no);return}if(a==13||a==32||a==67){if(core.status.event.selection==0&&core.status.event.data.yes){core.status.event.selection=null;core.status.event.data.yes();return}if(core.status.event.selection==1&&core.status.event.data.no){core.status.event.selection=null;core.status.event.data.no();return}}};actions.prototype._clickAction=function(d,e){if(core.status.event.data.type=="text"){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length==0){return}if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){core.status.route.push("choices:"+(e-c));core.insertAction(a[e-c].action);core.doAction()}}return}if(core.status.event.data.type=="confirm"){if((d==this.HSIZE-2||d==this.HSIZE-1)&&e==this.HSIZE+1){core.status.route.push("choices:0");core.insertAction(core.status.event.ui.yes);core.doAction()}else{if((d==this.HSIZE+2||d==this.HSIZE+1)&&e==this.HSIZE+1){core.status.route.push("choices:1");core.insertAction(core.status.event.ui.no);core.doAction()}}return}};actions.prototype._keyDownAction=function(a){if(core.status.event.data.type=="choices"){this._keyDownChoices(a);return}if(core.status.event.data.type=="confirm"&&(a==37||a==39)){core.status.event.selection=1-core.status.event.selection;core.drawConfirmBox(core.status.event.ui.text);return}};actions.prototype._keyUpAction=function(c){if(core.status.event.data.type=="text"&&(c==13||c==32||c==67)){if(core.status.event.interval!=null){core.insertAction({type:"text",text:core.status.event.ui,showAll:true})}core.doAction();return}if(core.status.event.data.type=="wait"){core.setFlag("type",0);core.setFlag("keycode",c);core.status.route.push("input:"+c);core.doAction();return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length>0){this._selectChoices(a.length,c,this._clickAction)}return}if(core.status.event.data.type=="confirm"&&(c==13||c==32||c==67)){core.status.route.push("choices:"+core.status.event.selection);if(core.status.event.selection==0){core.insertAction(core.status.event.ui.yes)}else{core.insertAction(core.status.event.ui.no)}core.doAction();return}};actions.prototype._clickBook=function(h,j){if((h==this.HSIZE-2||h==this.HSIZE-3)&&j==this.LAST){core.ui.drawBook(core.status.event.data-this.HSIZE);return}if((h==this.HSIZE+2||h==this.HSIZE+3)&&j==this.LAST){core.ui.drawBook(core.status.event.data+this.HSIZE);return}if(h>=this.LAST-2&&j==this.LAST){if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}var a=core.status.event.data;if(a!=null&&j<this.LAST){var e=core.ui._drawBook_pageinfo();var f=e.per_page,d=parseInt(a/f);var g=this.LAST/f;for(var b=0;b<f;++b){if(j>=g*b&&j<g*(b+1)){var c=f*d+b;core.ui.drawBook(c);core.ui.drawBookDetail(c);break}}return}return};actions.prototype._keyDownBook=function(a){if(a==37){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==38){core.ui.drawBook(core.status.event.data-1)}if(a==39){core.ui.drawBook(core.status.event.data+this.HSIZE)}if(a==40){core.ui.drawBook(core.status.event.data+1)}if(a==33){core.ui.drawBook(core.status.event.data-this.HSIZE)}if(a==34){core.ui.drawBook(core.status.event.data+this.HSIZE)}return};actions.prototype._keyUpBook=function(b){if(b==27||b==88){if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}if(b==13||b==32||b==67){var a=core.status.event.data;if(a!=null){core.ui.drawBookDetail(a)}return}};actions.prototype._clickBookDetail=function(){core.clearMap("data");core.status.event.id="book"};actions.prototype._clickFly=function(a,b){if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE+3){core.ui.drawFly(this._getNextFlyFloor(-1))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE-1){core.ui.drawFly(this._getNextFlyFloor(1))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE+4){core.ui.drawFly(this._getNextFlyFloor(-10))}if((a==this.SIZE-2||a==this.SIZE-3)&&b==this.HSIZE-2){core.ui.drawFly(this._getNextFlyFloor(10))}if(a>=this.HSIZE-1&&a<=this.HSIZE+1&&b==this.LAST){core.ui.closePanel()}if(a>=0&&a<=this.HSIZE+3&&b>=3&&b<=this.LAST-1){core.flyTo(core.floorIds[core.status.event.data])}return};actions.prototype._keyDownFly=function(a){if(a==37){core.ui.drawFly(this._getNextFlyFloor(-10))}else{if(a==38){core.ui.drawFly(this._getNextFlyFloor(1))}else{if(a==39){core.ui.drawFly(this._getNextFlyFloor(10))}else{if(a==40){core.ui.drawFly(this._getNextFlyFloor(-1))}}}}return};actions.prototype._getNextFlyFloor=function(b,d){if(d==null){d=core.status.event.data}if(b==0){return d}var e=Math.sign(b);b=Math.abs(b);var a=d;while(true){d+=e;if(d<0||d>=core.floorIds.length){break}var c=core.floorIds[d];if(core.status.maps[c].canFlyTo&&core.hasVisitedFloor(c)){b--;a=d}if(b==0){break}}return a};actions.prototype._keyUpFly=function(a){if(a==71||a==27||a==88){core.ui.closePanel()}if(a==13||a==32||a==67){this._clickFly(this.HSIZE-1,this.HSIZE-1)}return};actions.prototype._clickViewMaps=function(i,j){if(core.status.event.data==null){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}var g=core.floorIds.indexOf(core.status.floorId);var d=core.status.event.data.index;var a=core.status.event.data.x,b=core.status.event.data.y;var c=core.floorIds[d],f=core.floors[c].width,e=core.floors[c].height;var h=this.HSIZE-4;if(i<=h-2&&j<=h-2){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(d,a,b);return}if(i<=h-2&&j>=this.SIZE+1-h){core.status.event.data.paint=!core.status.event.data.paint;core.ui.drawMaps(d,a,b);return}if(i>=this.SIZE+1-h&&j<=h-2){core.status.event.data.all=!core.status.event.data.all;core.ui.drawMaps(d,a,b);return}if(i>=h&&i<=this.LAST-h&&j<=h-1&&e>this.SIZE){core.ui.drawMaps(d,a,b-1);return}if(i>=h&&i<=this.LAST-h&&j>=this.SIZE-h&&e>this.SIZE){core.ui.drawMaps(d,a,b+1);return}if(i<=h-1&&j>=h&&j<=this.LAST-h){core.ui.drawMaps(d,a-1,b);return}if(i>=this.SIZE-h&&j>=h&&j<=this.LAST-h){core.ui.drawMaps(d,a+1,b);return}if(j<=this.HSIZE-2&&(e==this.SIZE||(i>=h&&i<=this.LAST-h))){d++;while(d<core.floorIds.length&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d++}if(d<core.floorIds.length){core.ui.drawMaps(d)}return}if(j>=this.HSIZE+2&&(e==this.SIZE||(i>=h&&i<=this.LAST-h))){d--;while(d>=0&&d!=g&&core.status.maps[core.floorIds[d]].cannotViewMap){d--}if(d>=0){core.ui.drawMaps(d)}return}if(i>=h&&i<=this.LAST-h&&j>=this.HSIZE-1&&j<=this.HSIZE+1){core.clearMap("data");core.ui.closePanel();return}};actions.prototype._keyDownViewMaps=function(b){if(core.status.event.data==null){return}var a=core.floorIds[core.status.event.data.index],c=core.floors[a].height;if(b==38||b==33){this._clickViewMaps(this.HSIZE,this.HSIZE-3)}if(b==40||b==34){this._clickViewMaps(this.HSIZE,this.HSIZE+3)}if(b==87&&c>this.SIZE){this._clickViewMaps(this.HSIZE,0)}if(b==65){this._clickViewMaps(0,this.HSIZE)}if(b==83&&c>this.SIZE){this._clickViewMaps(this.HSIZE,this.LAST)}if(b==68){this._clickViewMaps(this.LAST,this.HSIZE)}return};actions.prototype._keyUpViewMaps=function(a){if(core.status.event.data==null){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId));return}if(a==27||a==13||a==32||(!core.isReplaying()&&a==67)){core.clearMap("data");core.ui.closePanel();return}if(a==86){core.status.event.data.damage=!core.status.event.data.damage;core.ui.drawMaps(core.status.event.data);return}if(a==90){core.status.event.data.all=!core.status.event.data.all;core.ui.drawMaps(core.status.event.data);return}if(a==77){core.status.event.data.paint=!core.status.event.data.paint;core.ui.drawMaps(core.status.event.data);return}if(a==88||(core.isReplaying()&&a==67)){if(core.isReplaying()){core.bookReplay()}else{core.openBook(false)}return}return};actions.prototype._clickShop=function(d,e){var b=core.status.event.data.shop;var a=b.choices;if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt(a.length/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){return core.events._useShop(b,e-c)}else{if(e==c+a.length){core.events._exitShop()}else{return false}}}return true};actions.prototype._keyDownShop=function(a){if(a==32&&core.status.event.selection!=core.status.event.data.shop.choices.length){this._selectChoices(core.status.event.data.shop.choices.length+1,a,this._clickShop);return}this._keyDownChoices(a)};actions.prototype._keyUpShop=function(a){if(a==27||a==88){core.events._exitShop();return}if(a!=32||core.status.event.selection==core.status.event.data.shop.choices.length){this._selectChoices(core.status.event.data.shop.choices.length+1,a,this._clickShop);return}return};actions.prototype._clickQuickShop=function(d,e){var a=Object.keys(core.status.shops).filter(function(f){return core.status.shops[f].visited||!core.status.shops[f].mustEnable});if(d>=this.CHOICES_LEFT&&d<=this.CHOICES_RIGHT){var c=this.HSIZE-parseInt(a.length/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=core.events.canUseQuickShop(a[e-c]);if(!core.flags.enableDisabledShop&&b){core.drawText(b);return}core.events.openShop(a[e-c],true);if(core.status.event.id=="shop"){core.status.event.data.fromList=true}}else{if(e==c+a.length){core.ui.closePanel()}}return}return};actions.prototype._keyUpQuickShop=function(a){if(a==27||a==75||a==88||a==86){core.ui.closePanel();return}var b=Object.keys(core.status.shops).filter(function(c){return core.status.shops[c].visited||!core.status.shops[c].mustEnable});this._selectChoices(b.length+1,a,this._clickQuickShop);return};actions.prototype._clickToolbox=function(d,e){if(d>=this.LAST-2&&e==0){core.ui.closePanel();if(core.isReplaying()){core.equipboxReplay()}else{core.openEquipbox()}return}if(d>=this.LAST-2&&e==this.LAST){core.ui.closePanel();return}var c=core.status.event.data.toolsPage;var a=core.status.event.data.constantsPage;if(d==this.HSIZE-2||d==this.HSIZE-3){if(e==this.LAST-5&&c>1){core.status.event.data.toolsPage--;core.ui.drawToolbox(core.status.event.selection)}if(e==this.LAST&&a>1){core.status.event.data.constantsPage--;core.ui.drawToolbox(core.status.event.selection)}}if(d==this.HSIZE+2||d==this.HSIZE+3){if(e==this.LAST-5&&c<Math.ceil(Object.keys(core.status.hero.items.tools).length/this.LAST)){core.status.event.data.toolsPage++;core.ui.drawToolbox(core.status.event.selection)}if(e==this.LAST&&a<Math.ceil(Object.keys(core.status.hero.items.constants).length/this.LAST)){core.status.event.data.constantsPage++;core.ui.drawToolbox(core.status.event.selection)}}var b=parseInt(d/2);if(e==this.LAST-8){b+=0}else{if(e==this.LAST-6){b+=this.HSIZE}else{if(e==this.LAST-3){b+=this.LAST}else{if(e==this.LAST-1){b+=this.LAST+this.HSIZE}else{b=-1}}}}if(b>=0){this._clickToolboxIndex(b)}};actions.prototype._clickToolboxIndex=function(a){var c=null;var d;if(a<this.LAST){d=a+this.LAST*(core.status.event.data.toolsPage-1);c=Object.keys(core.status.hero.items.tools).sort()}else{d=a%this.LAST+this.LAST*(core.status.event.data.constantsPage-1);c=Object.keys(core.status.hero.items.constants).sort()}if(c==null){return}if(d>=c.length){return}var b=c[d];if(b==core.status.event.data.selectId){if(core.isReplaying()){return}core.events.tryUseItem(b)}else{core.ui.drawToolbox(a)}};actions.prototype._keyDownToolbox=function(f){if(core.status.event.data==null){return}var g=this.LAST-1;var i=Object.keys(core.status.hero.items.tools).sort();var a=Object.keys(core.status.hero.items.constants).sort();var e=core.status.event.selection;var k=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var l=Math.ceil(i.length/this.LAST);var d=Math.ceil(a.length/this.LAST);var j=k<l?g:(i.length+g)%this.LAST;var b=this.LAST+(c<d?g:(a.length+g)%this.LAST);if(f==37){if(e==0){if(k>1){core.status.event.data.toolsPage--;e=g}else{return}}else{if(e==this.LAST){if(c==1){if(l==0){return}core.status.event.data.toolsPage=l;e=(i.length+g)%this.LAST}else{core.status.event.data.constantsPage--;e=2*this.LAST-1}}else{e-=1}}this._clickToolboxIndex(e);return}if(f==38){if(e>=this.LAST&&e<this.LAST+this.HSIZE){if(l==0){return}if(j>=this.HSIZE){e=Math.min(j,e-this.HSIZE)}else{e=Math.min(j,e-this.LAST)}}else{if(e<this.HSIZE){return}else{e-=this.HSIZE}}this._clickToolboxIndex(e);return}if(f==39){if(k<l&&e==g){core.status.event.data.toolsPage++;e=0}else{if(c<d&&e==2*this.LAST-1){core.status.event.data.constantsPage++;e=this.LAST}else{if(e==j){if(d==0){return}core.status.event.data.constantsPage=1;e=this.LAST}else{if(e==b){return}else{e++}}}}this._clickToolboxIndex(e);return}if(f==40){var h=null;if(e<this.HSIZE){if(j>=this.HSIZE){h=Math.min(j,e+this.HSIZE)}else{e+=this.HSIZE}}if(h==null&&e<this.LAST){if(d==0){return}h=Math.min(e+this.HSIZE,b)}if(h==null&&e<this.LAST+this.HSIZE){if(b>=this.LAST+this.HSIZE){h=Math.min(b,e+this.HSIZE)}}if(h!=null){this._clickToolboxIndex(h)}return}};actions.prototype._keyUpToolbox=function(a){if(a==81){core.ui.closePanel();if(core.isReplaying()){core.equipboxReplay()}else{core.openEquipbox()}return}if(a==84||a==27||a==88){core.ui.closePanel();return}if(core.status.event.data==null){return}if(a==13||a==32||a==67){this._clickToolboxIndex(core.status.event.selection);return}};actions.prototype._clickEquipbox=function(e,f){if(e>=this.LAST-2&&f==0){core.ui.closePanel();if(core.isReplaying()){core.toolboxReplay()}else{core.openToolbox()}return}if(e>=this.LAST-2&&f==this.LAST){core.ui.closePanel();return}if((e==this.HSIZE-2||e==this.HSIZE-3)&&f==this.LAST){if(core.status.event.data.page>1){core.status.event.data.page--;core.ui.drawEquipbox(core.status.event.selection)}return}if((e==this.HSIZE+2||e==this.HSIZE+3)&&f==this.LAST){var b=Math.ceil(Object.keys(core.status.hero.items.equips).length/this.LAST);if(core.status.event.data.page<b){core.status.event.data.page++;core.ui.drawEquipbox(core.status.event.selection)}return}var c=this.HSIZE-3,d=this.SIZE/c;if(f==this.LAST-8){for(var a=0;a<c;++a){if(e>=a*d&&e<=(a+1)*d){return this._clickEquipboxIndex(a)}}}else{if(f==this.LAST-6){for(var a=0;a<c;++a){if(e>=a*d&&e<=(a+1)*d){return this._clickEquipboxIndex(c+a)}}}else{if(f==this.LAST-3){this._clickEquipboxIndex(this.LAST+parseInt(e/2))}else{if(f==this.LAST-1){this._clickEquipboxIndex(this.LAST+this.HSIZE+parseInt(e/2))}}}}};actions.prototype._clickEquipboxIndex=function(c){if(c<this.LAST){if(c>=core.status.globalAttribute.equipName.length){return}if(c==core.status.event.selection&&core.status.hero.equipment[c]){if(core.isReplaying()){return}core.unloadEquip(c);core.status.route.push("unEquip:"+c)}}else{var b=Object.keys(core.status.hero.items.equips||{}).sort();if(c==core.status.event.selection){if(core.isReplaying()){return}var a=b[c-this.LAST+(core.status.event.data.page-1)*this.LAST];core.loadEquip(a);core.status.route.push("equip:"+a)}}core.ui.drawEquipbox(c)};actions.prototype._keyDownEquipbox=function(c){if(core.status.event.data==null){return}var d=this.LAST-1;var g=this.HSIZE-3;var a=core.status.globalAttribute.equipName.length;var e=Object.keys(core.status.hero.items.equips).sort();var b=core.status.event.selection;var f=core.status.event.data.page;var i=Math.ceil(e.length/this.LAST);var h=this.LAST+(f<i?d:(e.length+d)%this.LAST);if(c==37){if(b==0){return}if(b==this.LAST){if(f>1){core.status.event.data.page--;b=this.LAST+d}else{if(f==1){b=a-1}else{return}}}else{b-=1}this._clickEquipboxIndex(b);return}if(c==38){if(b<g){return}else{if(b<2*g){b-=g}else{if(b<this.LAST+this.HSIZE){b=parseInt((b-this.LAST)/2);if(a>g){b=Math.min(a-1,b+g)}else{b=Math.min(a-1,b)}}else{b-=this.HSIZE}}}this._clickEquipboxIndex(b);return}if(c==39){if(f<i&&b==this.LAST+d){core.status.event.data.page++;b=this.LAST}else{if(b==a-1){if(i==0){return}b=this.LAST}else{if(b==h){return}else{b++}}}this._clickEquipboxIndex(b);return}if(c==40){if(b<g){if(a>g){b=Math.min(b+g,a-1)}else{if(i==0){return}b=Math.min(2*b+1+this.LAST,h)}}else{if(b<2*g){if(i==0){return}b=Math.min(2*(b-g)+1+this.LAST,h)}else{if(b<this.LAST+this.HSIZE){b=Math.min(b+this.HSIZE,h)}else{return}}}this._clickEquipboxIndex(b);return}};actions.prototype._keyUpEquipbox=function(b,a){if(a&&b>=48&&b<=57){core.items.quickSaveEquip(b-48);return}if(b==84){core.ui.closePanel();if(core.isReplaying()){core.toolboxReplay()}else{core.openToolbox()}return}if(b==81||b==27||b==88){core.ui.closePanel();return}if(!core.status.event.data.selectId){return}if(b==13||b==32||b==67){this._clickEquipboxIndex(core.status.event.selection);return}};actions.prototype._clickSL=function(g,j){var d=core.status.event.data.page,c=core.status.event.data.offset;var b=d*10+c;if((g==this.HSIZE-2||g==this.HSIZE-3)&&j==this.LAST){core.ui.drawSLPanel(10*(d-1)+c);return}if((g==this.HSIZE+2||g==this.HSIZE+3)&&j==this.LAST){core.ui.drawSLPanel(10*(d+1)+c);return}if(g>=this.LAST-2&&j==this.LAST){if(core.events.recoverEvents(core.status.event.interval)){return}core.ui.closePanel();delete core.status.tempRoute;if(!core.isPlaying()){core.showStartAnimate(true)}return}if(g>=0&&g<=2&&j==this.LAST){if(core.status.event.id=="save"){core.status.event.selection=!core.status.event.selection;core.ui.drawSLPanel(b)}else{core.status.event.data.mode=core.status.event.data.mode=="all"?"fav":"all";if(core.status.event.data.mode=="fav"){core.ui.drawSLPanel(1,true)}else{d=parseInt((core.saves.saveIndex-1)/5);c=core.saves.saveIndex-5*d;core.ui.drawSLPanel(10*d+c,true)}}return}var h=parseInt(this.SIZE/3),i=parseInt(this.SIZE*2/3);var e=0,f=this.HSIZE;if(j>=e&&j<=e+1){if(g>=h&&g<i){return this._clickSL_favorite(d,1)}if(g>=i){return this._clickSL_favorite(d,2)}}if(j>=f&&j<=f+1){if(g<h){return this._clickSL_favorite(d,3)}if(g>=h&&g<i){return this._clickSL_favorite(d,4)}if(g>=i){return this._clickSL_favorite(d,5)}}var a=null;if(j>=e+2&&j<this.HSIZE-1){if(g<h){a="autoSave"}if(g>=h&&g<i){a=5*d+1}if(g>=i){a=5*d+2}}if(j>=f+2&&j<this.SIZE-1){if(g<h){a=5*d+3}if(g>=h&&g<i){a=5*d+4}if(g>=i){a=5*d+5}}if(a!=null){if(core.status.event.selection){if(a=="autoSave"){core.drawTip("无法删除自动存档！")}else{core.removeSave(a,function(){core.ui.drawSLPanel(b,true)})}}else{if(core.status.event.data.mode=="fav"&&a!="autoSave"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}}};actions.prototype._clickSL_favorite=function(c,b){if(b==0){return}var a=5*c+b;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1];core.myprompt("请输入想要显示的存档名(长度不超过5字符)",null,function(e){if(e&&e.length<=5){core.saves.favoriteName[a]=e;core.control._updateFavoriteSaves();core.drawSLPanel(10*c+b)}else{if(e){alert("无效的输入！")}}})}else{var d=core.saves.favorite.indexOf(a);if(d>=0){core.saves.favorite.splice(d,1);delete core.saves.favoriteName[a]}else{if(core.hasSave(a)){core.saves.favorite.push(a);core.saves.favorite=core.saves.favorite.sort(function(e,f){return e-f});core.drawTip("收藏成功！")}}core.control._updateFavoriteSaves();core.ui.drawSLPanel(10*c+b)}};actions.prototype._keyDownSL=function(b){var d=core.status.event.data.page,c=core.status.event.data.offset;var a=d*10+c;if(b==37){if(c==0){core.ui.drawSLPanel(10*(d-1)+5)}else{core.ui.drawSLPanel(a-1)}return}if(b==38){if(c<3){core.ui.drawSLPanel(10*(d-1)+c+3)}else{core.ui.drawSLPanel(a-3)}return}if(b==39){if(c==5){core.ui.drawSLPanel(10*(d+1)+1)}else{core.ui.drawSLPanel(a+1)}return}if(b==40){if(c>=3){core.ui.drawSLPanel(10*(d+1)+c-3)}else{core.ui.drawSLPanel(a+3)}return}if(b==33){core.ui.drawSLPanel(10*(d-1)+c);return}if(b==34){core.ui.drawSLPanel(10*(d+1)+c);return}};actions.prototype._keyUpSL=function(c){var e=core.status.event.data.page,d=core.status.event.data.offset;var b=e*10+d;if(c==27||c==88||(core.status.event.id=="save"&&c==83)||(core.status.event.id=="load"&&c==68)){this._clickSL(this.LAST,this.LAST);return}if(c>=48&&c<=57){if(c==48){c=58}core.ui.drawSLPanel((c-49)*1000+1);return}if(c==13||c==32||c==67){if(d==0){core.doSL("autoSave",core.status.event.id)}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}return}if(c==69&&core.status.event.id!="save"){this._clickSL(0,this.LAST);return}if(c==46){if(d==0){core.drawTip("无法删除自动存档！")}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.removeSave(a,function(){core.ui.drawSLPanel(b,true)})}}if(c==70&&core.status.event.data.mode=="all"){this._clickSL_favorite(e,d)}};actions.prototype._clickSwitchs=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickSwitchs_bgm();case 1:return this._clickSwitchs_sound();case 2:return this._clickSwitchs_moveSpeed();case 3:return this._clickSwitchs_displayEnemyDamage();case 4:return this._clickSwitchs_displayCritical();case 5:return this._clickSwitchs_displayExtraDamage();case 6:return this._clickSwitchs_localForage();case 7:return this._clickSwitchs_clickMove();case 8:core.status.event.selection=0;core.ui.drawSettings();break}}};actions.prototype._clickSwitchs_bgm=function(){core.triggerBgm();core.ui.drawSwitchs()};actions.prototype._clickSwitchs_sound=function(){core.musicStatus.soundStatus=!core.musicStatus.soundStatus;core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_moveSpeed=function(){core.myprompt("请输入行走速度（每走一步的时间，单位毫秒，默认100）",core.values.moveSpeed,function(a){a=parseInt(a)||core.values.moveSpeed;a=core.clamp(a,10,500);core.values.moveSpeed=a;core.setLocalStorage("moveSpeed",a);core.ui.drawSwitchs()})};actions.prototype._clickSwitchs_displayEnemyDamage=function(){core.flags.displayEnemyDamage=!core.flags.displayEnemyDamage;core.updateDamage();core.setLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_displayCritical=function(){core.flags.displayCritical=!core.flags.displayCritical;core.updateDamage();core.setLocalStorage("critical",core.flags.displayCritical);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_displayExtraDamage=function(){core.flags.displayExtraDamage=!core.flags.displayExtraDamage;core.updateDamage();core.setLocalStorage("extraDamage",core.flags.displayExtraDamage);core.ui.drawSwitchs()};actions.prototype._clickSwitchs_localForage=function(){core.platform.useLocalForage=!core.platform.useLocalForage;core.setLocalStorage("useLocalForage",core.platform.useLocalForage);core.control.getSaveIndexes(function(a){core.saves.ids=a});core.ui.drawSwitchs()};actions.prototype._clickSwitchs_clickMove=function(){if(core.hasFlag("__noClickMove__")){core.removeFlag("__noClickMove__")}else{core.setFlag("__noClickMove__",true)}core.ui.drawSwitchs()};actions.prototype._keyUpSwitchs=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs)};actions.prototype._clickSettings=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.ui.drawSwitchs();break;case 1:core.ui.drawKeyBoard();break;case 2:core.clearUI();core.ui.drawMaps();break;case 3:core.clearUI();core.ui.drawPaint();break;case 4:core.status.event.selection=0;core.ui.drawSyncSave();break;case 5:core.status.event.selection=0;core.ui.drawGameInfo();break;case 6:return core.confirmRestart();case 7:core.ui.closePanel();break}}return};actions.prototype._keyUpSettings=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSettings)};actions.prototype._clickSyncSave=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.ui.drawSyncSelect();break;case 1:core.syncLoad();break;case 2:core.status.event.selection=0;core.ui.drawLocalSaveSelect();break;case 3:return this._clickSyncSave_readFile();case 4:return this._clickSyncSave_replay();case 5:core.status.event.selection=0;core.ui.drawStorageRemove();break;case 6:core.status.event.selection=4;core.ui.drawSettings();break}}return};actions.prototype._clickSyncSave_readFile=function(){core.readFile(function(a){if(a.name!=core.firstData.name){return alert("存档和游戏不一致！")}if(a.version!=core.firstData.version){return alert("游戏版本不一致！")}if(!a.data){return alert("无效的存档！")}core.control._syncLoad_write(a.data)})};actions.prototype._clickSyncSave_replay=function(){core.ui.drawReplay()};actions.prototype._keyUpSyncSave=function(a){if(a==27||a==88){core.status.event.selection=2;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSave)};actions.prototype._clickSyncSelect=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.syncSave("all");break;case 1:core.syncSave();break;case 2:core.status.event.selection=0;core.ui.drawSyncSave();break}}};actions.prototype._keyUpSyncSelect=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSelect)};actions.prototype._clickLocalSaveSelect=function(e,f){if(e<this.CHOICES_LEFT||e>this.CHOICES_RIGHT){return}var b=core.status.event.ui.choices;var d=this.HSIZE-parseInt((b.length-1)/2)+(core.status.event.ui.offset||0);if(f>=d&&f<d+b.length){var c=f-d;core.status.event.selection=c;if(c<2){var a=function(h){if(h){var g={name:core.firstData.name,version:core.firstData.version,data:h};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5save",JSON.stringify(g))}};if(c==0){core.getAllSaves(a)}else{core.getSave(core.saves.saveIndex,a)}}core.status.event.selection=2;core.ui.drawSyncSave()}};actions.prototype._keyUpLocalSaveSelect=function(a){if(a==27||a==88){core.status.event.selection=0;core.ui.drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickLocalSaveSelect)};actions.prototype._clickStorageRemove=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickStorageRemove_all();case 1:return this._clickStorageRemove_current();case 2:core.status.event.selection=6;core.ui.drawSyncSave();break}}};actions.prototype._clickStorageRemove_all=function(){core.myconfirm("你确定要清除【全部塔】的所有本地存档？\n此行为不可逆！！！",function(){var a=function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]你的所有存档已被清空。")};if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");localforage.clear(a)}else{localStorage.clear();a()}})};actions.prototype._clickStorageRemove_current=function(){core.myconfirm("你确定要清除本塔的所有本地存档？\n此行为不可逆！！！",function(){var a=function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]当前塔的存档已被清空。")};if(core.platform.useLocalForage){core.ui.drawWaiting("正在清空，请稍后...");Object.keys(core.saves.ids).forEach(function(b){core.removeLocalForage("save"+b)});core.removeLocalForage("autoSave",a)}else{Object.keys(core.saves.ids).forEach(function(b){core.removeLocalStorage("save"+b)});core.removeLocalStorage("autoSave");a()}})};actions.prototype._keyUpStorageRemove=function(a){if(a==27||a==88){core.status.event.selection=5;core.ui.drawSyncSave();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickStorageRemove)};actions.prototype._clickReplay=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickReplay_fromBeginning();case 1:return this._clickReplay_fromLoad();case 2:return this._clickReplay_replayRemain();case 3:return core.chooseReplayFile();case 4:return this._clickReplay_download();case 5:return core.ui.closePanel()}}};actions.prototype._clickReplay_fromBeginning=function(){core.ui.closePanel();core.startGame(core.status.hard,core.getFlag("__seed__"),core.clone(core.status.route))};actions.prototype._clickReplay_fromLoad=function(){core.status.event.id="replayLoad";core.status.event.selection=null;core.clearUI();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)};actions.prototype._clickReplay_replayRemain=function(){core.closePanel();core.drawText(["\t[接续播放录像]该功能允许你播放\r[yellow]两个存档之间的录像\r，常常用于\r[yellow]区域优化\r。\n例如，有若干个区，已经全部通关；之后重打一区并进行了优化，则可以对剩余区域直接播放录像而无需全部重打。","\t[步骤1]请选择一个存档。\n\r[yellow]该存档的坐标必须和当前勇士坐标完全相同。\r\n将尝试从此处开始回放。",],function(){core.status.event.id="replayRemain";core.lockControl();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui.drawSLPanel(10*b+a)})};actions.prototype._clickReplay_download=function(){core.download(core.firstData.name+"_"+core.formatDate2()+".h5route",JSON.stringify({name:core.firstData.name,hard:core.status.hard,seed:core.getFlag("__seed__"),route:core.encodeRoute(core.status.route)}))};actions.prototype._keyUpReplay=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickReplay)};actions.prototype._clickGameInfo=function(d,e){if(d<this.CHOICES_LEFT||d>this.CHOICES_RIGHT){return}var a=core.status.event.ui.choices;var c=this.HSIZE-parseInt((a.length-1)/2)+(core.status.event.ui.offset||0);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return core.ui.drawStatistics();case 1:return this._clickGameInfo_openProject();case 2:return this._clickGameInfo_openComments();case 3:return core.ui.drawHelp();case 4:return core.ui.drawAbout();case 5:return this._clickGameInfo_download();case 6:core.status.event.selection=5;core.ui.drawSettings();break}}};actions.prototype._clickGameInfo_openProject=function(){if(core.platform.isPC){window.open("editor.html","_blank")}else{core.myconfirm("即将离开本塔，跳转至本塔工程页面，确认？",function(){window.location.href="editor-mobile.html"})}};actions.prototype._clickGameInfo_openComments=function(){if(core.platform.isPC){window.open("/score.php?name="+core.firstData.name+"&num=10","_blank")}else{core.myconfirm("即将离开本塔，跳转至本塔评论页面，确认？",function(){window.location.href="/score.php?name="+core.firstData.name+"&num=10"})}};actions.prototype._clickGameInfo_download=function(){if(core.platform.isPC){window.open(core.firstData.name+".zip")}else{window.location.href=core.firstData.name+".zip"}};actions.prototype._keyUpGameInfo=function(a){if(a==27||a==88){core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickGameInfo)};actions.prototype._clickKeyBoard=function(x,y){var m=this.HSIZE;if(y==m-3&&x>=m-5&&x<=m+5){core.ui.closePanel();core.keyUp(112+x+5-m)}if(y==m-3&&x==m+6){var val=prompt();if(val!=null){try{eval(val)}catch(e){}}}if(y==m-2&&x>=m-5&&x<=m+4){core.ui.closePanel();core.keyUp(x==m+4?48:49+x+5-m)}var lines=[["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],];if(y==m-1&&x>=m-5&&x<=m+4){core.ui.closePanel();core.keyUp(lines[0][x+5-m].charCodeAt(0))}if(y==m&&x>=m-5&&x<=m+3){core.ui.closePanel();core.keyUp(lines[1][x+5-m].charCodeAt(0))}if(y==m+1&&x>=m-5&&x<=m+1){core.ui.closePanel();core.keyUp(lines[2][x+5-m].charCodeAt(0))}if(y==m+2&&x>=m-5&&x<=m+5){core.ui.closePanel();if(x==m-5){core.keyUp(189)}if(x==m-4){core.keyUp(187)}if(x==m-3){core.keyUp(219)}if(x==m-2){core.keyUp(221)}if(x==m-1){core.keyUp(220)}if(x==m){core.keyUp(186)}if(x==m+1){core.keyUp(222)}if(x==m+2){core.keyUp(188)}if(x==m+3){core.keyUp(190)}if(x==m+4){core.keyUp(191)}if(x==m+5){core.keyUp(192)}}if(y==m+3&&x>=m-5&&x<=m+4){core.ui.closePanel();if(x==m-5){core.keyUp(27)}if(x==m-4){core.keyUp(9)}if(x==m-3){core.keyUp(20)}if(x==m-2){core.keyUp(16)}if(x==m-1){core.keyUp(17)}if(x==m){core.keyUp(18)}if(x==m+1){core.keyUp(32)}if(x==m+2){core.keyUp(8)}if(x==m+3){core.keyUp(13)}if(x==m+4){core.keyUp(46)}}if(y==m+4&&x>=m+3&&x<=m+5){core.ui.closePanel()}};actions.prototype._clickCursor=function(a,b){if(a==core.status.automaticRoute.cursorX&&b==core.status.automaticRoute.cursorY){core.ui.closePanel();core.onclick(a,b,[]);return}core.status.automaticRoute.cursorX=a;core.status.automaticRoute.cursorY=b;core.ui.drawCursor()};actions.prototype._keyDownCursor=function(a){if(a==37){core.status.automaticRoute.cursorX--;core.ui.drawCursor();return}if(a==38){core.status.automaticRoute.cursorY--;core.ui.drawCursor();return}if(a==39){core.status.automaticRoute.cursorX++;core.ui.drawCursor();return}if(a==40){core.status.automaticRoute.cursorY++;core.ui.drawCursor();return}};actions.prototype._keyUpCursor=function(a){if(a==27||a==88){core.ui.closePanel();return}if(a==13||a==32||a==67||a==69){core.ui.closePanel();core.onclick(core.status.automaticRoute.cursorX,core.status.automaticRoute.cursorY,[]);return}};actions.prototype._ondownPaint=function(a,b){a+=core.bigmap.offsetX;b+=core.bigmap.offsetY;if(!core.status.event.data.erase){core.dymCanvas.paint.beginPath();core.dymCanvas.paint.moveTo(a,b)}core.status.event.data.x=a;core.status.event.data.y=b};actions.prototype._onmovePaint=function(c,d){if(core.status.event.data.x==null){return}c+=core.bigmap.offsetX;d+=core.bigmap.offsetY;if(core.status.event.data.erase){core.clearMap("paint",c-10,d-10,20,20);return}var a=(core.status.event.data.x+c)/2,b=(core.status.event.data.y+d)/2;core.dymCanvas.paint.quadraticCurveTo(a,b,c,d);core.dymCanvas.paint.stroke();core.status.event.data.x=c;core.status.event.data.y=d};actions.prototype._onupPaint=function(){core.status.event.data.x=null;core.status.event.data.y=null;core.paint[core.status.floorId]=lzw_encode(core.utils._encodeCanvas(core.dymCanvas.paint).join(","))};actions.prototype.setPaintMode=function(a){if(a=="paint"){core.status.event.data.erase=false}else{if(a=="erase"){core.status.event.data.erase=true}else{return}}core.drawTip("进入"+(core.status.event.data.erase?"擦除":"绘图")+"模式")};actions.prototype.clearPaint=function(){core.clearMap("paint");delete core.paint[core.status.floorId];core.drawTip("已清空绘图内容")};actions.prototype.savePaint=function(){var a={};for(var b in core.paint){if(core.paint[b]){a[b]=lzw_decode(core.paint[b])}}core.download(core.firstData.name+".h5paint",JSON.stringify({name:core.firstData.name,paint:a}))};actions.prototype.loadPaint=function(){core.readFile(function(b){if(b.name!=core.firstData.name){alert("绘图文件和游戏不一致！");return}if(!b.paint){alert("无效的绘图文件！");return}core.paint={};for(var a in b.paint){if(b.paint[a]){core.paint[a]=lzw_encode(b.paint[a])}}core.clearMap("paint");var c=core.paint[core.status.floorId];if(c){c=lzw_decode(c).split(",")}core.utils._decodeCanvas(c,32*core.bigmap.width,32*core.bigmap.height);core.drawImage("paint",core.bigmap.tempCanvas.canvas,0,0);core.drawTip("读取绘图文件成功")})};actions.prototype.exitPaint=function(){core.deleteCanvas("paint");core.ui.closePanel();core.statusBar.image.keyboard.style.opacity=1;core.statusBar.image.shop.style.opacity=1;core.updateStatusBar();core.drawTip("退出绘图模式")};actions.prototype._keyUpPaint=function(a){if(a==27||a==88||a==77||a==13||a==32||a==67){this.exitPaint();return}};"use strict";function data(){this._init()}data.prototype._init=function(){this.firstData=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.firstData;this.values=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.values;this.flags=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.flags};"use strict";function ui(){this._init();this.SIZE=core.__SIZE__;this.HSIZE=core.__HALF_SIZE__;this.LAST=this.SIZE-1;this.PIXEL=core.__PIXELS__;this.HPIXEL=this.PIXEL/2}ui.prototype._init=function(){this.uidata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.ui};ui.prototype.getContextByName=function(b){var a=b;if(typeof b=="string"){if(core.canvas[b]){a=core.canvas[b]}else{if(core.dymCanvas[b]){a=core.dymCanvas[b]}}}if(a&&a.canvas){return a}return null};ui.prototype._createUIEvent=function(){if(main.mode=="editor"){return}if(!core.dymCanvas.uievent){core.createCanvas("uievent",0,0,this.PIXEL,this.PIXEL,135)}};ui.prototype.clearMap=function(d,f,g,e,b){if(d=="all"){for(var c in core.canvas){core.canvas[c].clearRect(0,0,core.bigmap.width*32,core.bigmap.height*32)}core.dom.gif.innerHTML="";core.removeGlobalAnimate()}else{var a=this.getContextByName(d);if(a){a.clearRect(f||0,g||0,e||a.canvas.width,b||a.canvas.height)}}};ui.prototype._uievent_clearMap=function(a){if(main.mode!="editor"&&(a.x==null||a.y==null||a.width==null||a.height==null)){this.deleteCanvas("uievent");return}this._createUIEvent();this.clearMap("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height))};ui.prototype.fillText=function(d,f,g,h,e,b,c){if(e){core.setFillStyle(d,e)}if(b){core.setFont(d,b)}var a=this.getContextByName(d);if(a){if(c!=null){this._fillTextWithMaxWidth(a,f,g,h,c)}else{a.fillText(f,g,h)}}};ui.prototype._uievent_fillText=function(a){this._createUIEvent();this.fillText("uievent",core.replaceText(a.text),core.calValue(a.x),core.calValue(a.y),a.style,a.font,a.maxWidth)};ui.prototype._fillTextWithMaxWidth=function(a,e,g,h,d){var b=a.font,f=/(\d+)px/.exec(b);if(f==null){return a.fillText(e,g,h)}for(var c=parseInt(f[1]);c>=8;c--){a.font=b.replace(/(\d+)px/,c+"px");if(a.measureText(e).width<=d){break}}a.fillText(e,g,h);a.font=b};ui.prototype.fillBoldText=function(c,e,f,g,d,b){var a=this.getContextByName(c);if(!a){return}if(b){a.font=b}if(!d){d=a.fillStyle}if(d instanceof Array){d=core.arrayToRGBA(d)}a.fillStyle="#000000";a.fillText(e,f-1,g-1);a.fillText(e,f-1,g+1);a.fillText(e,f+1,g-1);a.fillText(e,f+1,g+1);a.fillStyle=d;a.fillText(e,f,g)};ui.prototype._uievent_fillBoldText=function(a){this._createUIEvent();this.fillBoldText("uievent",core.replaceText(a.text),core.calValue(a.x),core.calValue(a.y),a.style,a.font)};ui.prototype.fillRect=function(c,f,g,e,b,d){if(d){core.setFillStyle(c,d)}var a=this.getContextByName(c);if(a){a.fillRect(f,g,e,b)}};ui.prototype._uievent_fillRect=function(a){this._createUIEvent();this.fillRect("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height),a.style)};ui.prototype.fillPolygon=function(c,d,e){if(e){core.setFillStyle(c,e)}var a=this.getContextByName(c);if(!a){return}if(!d||d.length<3){return}a.beginPath();for(var b=0;b<d.length;++b){var f=core.calValue(d[b][0]),g=core.calValue(d[b][1]);if(b==0){a.moveTo(f,g)}else{a.lineTo(f,g)}}a.closePath();a.fill()};ui.prototype._uievent_fillPolygon=function(a){this._createUIEvent();this.fillPolygon("uievent",a.nodes,a.style)};ui.prototype.strokeRect=function(d,g,h,f,b,e,c){if(e){core.setStrokeStyle(d,e)}if(c){core.setLineWidth(d,c)}var a=this.getContextByName(d);if(a){a.strokeRect(g,h,f,b)}};ui.prototype._uievent_strokeRect=function(a){this._createUIEvent();this.strokeRect("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height),a.style,a.lineWidth)};ui.prototype.strokePolygon=function(d,e,f,c){if(f){core.setStrokeStyle(d,f)}if(c){core.setLineWidth(d,c)}var a=this.getContextByName(d);if(!a){return}if(!e||e.length<3){return}a.beginPath();for(var b=0;b<e.length;++b){var g=core.calValue(e[b][0]),h=core.calValue(e[b][1]);if(b==0){a.moveTo(g,h)}else{a.lineTo(g,h)}}a.closePath();a.stroke()};ui.prototype._uievent_strokePolygon=function(a){this._createUIEvent();this.strokePolygon("uievent",a.nodes,a.style,a.lineWidth)};ui.prototype.fillCircle=function(b,e,f,c,d){if(d){core.setFillStyle(b,d)}var a=this.getContextByName(b);if(!a){return}a.beginPath();a.arc(e,f,c,0,2*Math.PI);a.fill()};ui.prototype._uievent_fillCircle=function(a){this._createUIEvent();this.fillCircle("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.r),a.style)};ui.prototype.strokeCircle=function(c,f,g,d,e,b){if(e){core.setStrokeStyle(c,e)}if(b){core.setLineWidth(c,b)}var a=this.getContextByName(c);if(!a){return}a.beginPath();a.arc(f,g,d,0,2*Math.PI);a.stroke()};ui.prototype._uievent_strokeCircle=function(a){this._createUIEvent();this.strokeCircle("uievent",core.calValue(a.x),core.calValue(a.y),core.calValue(a.r),a.style,a.lineWidth)};ui.prototype.drawLine=function(c,e,g,f,h,d,b){if(d){core.setStrokeStyle(c,d)}if(b!=null){core.setLineWidth(c,b)}var a=this.getContextByName(c);if(!a){return}a.beginPath();a.moveTo(e,g);a.lineTo(f,h);a.stroke()};ui.prototype._uievent_drawLine=function(a){this._createUIEvent();this.drawLine("uievent",core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.x2),core.calValue(a.y2),a.style,a.lineWidth)};ui.prototype.drawArrow=function(g,i,k,j,l,h,f){if(i==j&&k==l){return}if(h){core.setStrokeStyle(g,h)}if(f!=null){core.setLineWidth(g,f)}var b=this.getContextByName(g);if(!b){return}var e=10;var c=j-i,d=l-k;var a=Math.atan2(d,c);b.beginPath();b.moveTo(i,k);b.lineTo(j,l);b.lineTo(j-e*Math.cos(a-Math.PI/6),l-e*Math.sin(a-Math.PI/6));b.moveTo(j,l);b.lineTo(j-e*Math.cos(a+Math.PI/6),l-e*Math.sin(a+Math.PI/6));b.stroke()};ui.prototype._uievent_drawArrow=function(a){this._createUIEvent();this.drawArrow("uievent",core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.x2),core.calValue(a.y2),a.style,a.lineWidth)};ui.prototype.setFont=function(c,b){var a=this.getContextByName(c);if(a){a.font=b}};ui.prototype.setLineWidth=function(c,b){var a=this.getContextByName(c);if(a){a.lineWidth=b}};ui.prototype.saveCanvas=function(b){var a=this.getContextByName(b);if(a){a.save()}};ui.prototype.loadCanvas=function(b){var a=this.getContextByName(b);if(a){a.restore()}};ui.prototype.setAlpha=function(c,a){var b=this.getContextByName(c);if(b){b.globalAlpha=a}};ui.prototype.setOpacity=function(b,c){var a=this.getContextByName(b);if(a){a.canvas.style.opacity=c}};ui.prototype.setFillStyle=function(b,c){var a=this.getContextByName(b);if(c instanceof Array){c=core.arrayToRGBA(c)}if(a){a.fillStyle=c}};ui.prototype.setStrokeStyle=function(b,c){var a=this.getContextByName(b);if(c instanceof Array){c=core.arrayToRGBA(c)}if(a){a.strokeStyle=c}};ui.prototype.setTextAlign=function(c,a){var b=this.getContextByName(c);if(b){b.textAlign=a}};ui.prototype.setTextBaseline=function(c,a){var b=this.getContextByName(c);if(b){b.textBaseline=a}};ui.prototype._uievent_setAttribute=function(a){this._createUIEvent();if(a.font){this.setFont("uievent",a.font)}if(a.lineWidth){this.setLineWidth("uievent",a.lineWidth)}if(a.alpha!=null){this.setAlpha("uievent",a.alpha)}if(a.fillStyle){this.setFillStyle("uievent",a.fillStyle)}if(a.strokeStyle){this.setStrokeStyle("uievent",a.strokeStyle)}if(a.align){this.setTextAlign("uievent",a.align)}if(a.baseline){this.setTextBaseline("uievent",a.baseline)}if(a.z!=null&&main.mode!="editor"){var b=parseInt(a.z)||135;core.dymCanvas.uievent.canvas.style.zIndex=b;if(core.dymCanvas._uievent_selector){core.dymCanvas._uievent_selector.canvas.style.zIndex=b+1}}};ui.prototype.calWidth=function(c,d,b){var a=this.getContextByName(c);if(a){if(b){a.font=b}return a.measureText(d).width}return 0};ui.prototype.splitLines=function(g,h,f,c){var b=this.getContextByName(g);if(!b){return}if(c){core.setFont(g,c)}var a=[];var e=0;for(var d=0;d<h.length;d++){if(h.charAt(d)=="\n"){a.push(h.substring(e,d));e=d+1}else{if(h.charAt(d)=="\\"&&h.charAt(d+1)=="n"){a.push(h.substring(e,d));e=d+2}else{var j=h.substring(e,d+1);var k=core.calWidth(g,j);if(f&&k>f){a.push(h.substring(e,d));e=d}}}}a.push(h.substring(e));return a};ui.prototype.drawImage=function(e,d,i,k,f,b,j,l,g,c){var a=this.getContextByName(e);if(!a){return}if(typeof d=="string"){d=core.getMappedName(d);d=core.material.images.images[d];if(!d){return}}if(i!=null&&k!=null){if(f!=null&&b!=null){if(j!=null&&l!=null&&g!=null&&c!=null){a.drawImage(d,i,k,f,b,j,l,g,c);return}a.drawImage(d,i,k,f,b);return}a.drawImage(d,i,k);return}};ui.prototype._uievent_drawImage=function(a){this._createUIEvent();this.drawImage("uievent",a.image,core.calValue(a.x),core.calValue(a.y),core.calValue(a.w),core.calValue(a.h),core.calValue(a.x1),core.calValue(a.y1),core.calValue(a.w1),core.calValue(a.h1))};ui.prototype.drawIcon=function(e,c,g,i,f,b){var a=this.getContextByName(e);if(!a){return}var d=core.getBlockInfo(c);if(!d){if(core.statusBar.icons[c] instanceof Image){d={image:core.statusBar.icons[c],posX:0,posY:0,height:32}}else{return}}a.drawImage(d.image,32*d.posX,d.height*d.posY,32,d.height,g,i,f||32,b||d.height)};ui.prototype._uievent_drawIcon=function(a){this._createUIEvent();var c;try{c=core.calValue(a.id);if(typeof c!=="string"){c=a.id}}catch(b){c=a.id}this.drawIcon("uievent",c,core.calValue(a.x),core.calValue(a.y),core.calValue(a.width),core.calValue(a.height))};ui.prototype.closePanel=function(){this.clearUI();core.maps.generateGroundPattern();core.updateStatusBar();core.unLockControl();core.status.event.data=null;core.status.event.id=null;core.status.event.selection=null;core.status.event.ui=null;core.status.event.interval=null};ui.prototype.clearUI=function(){core.status.boxAnimateObjs=[];if(core.dymCanvas._selector){core.deleteCanvas("_selector")}main.dom.next.style.display="none";core.clearMap("ui");core.setAlpha("ui",1)};ui.prototype.drawTip=function(d,b){var e,f,g,a;clearInterval(core.interval.tipAnimate);core.setFont("data","16px Arial");core.setTextAlign("data","left");if(b!=null){var c=core.getBlockInfo(b);if(c==null||!c.image||c.height!=32){if(core.statusBar.icons[b] instanceof Image){b={image:core.statusBar.icons[b],posX:0,posY:0}}else{b=null}}else{b=c}}if(!b){e=16;f=18;g=e+core.calWidth("data",d)+16;a=42}else{e=44;f=18;g=e+core.calWidth("data",d)+8;a=42}this._drawTip_animate(d,b,e,f,g,a)};ui.prototype._drawTip_animate=function(e,d,f,g,h,b){var a=0,c=false;core.interval.tipAnimate=window.setInterval(function(){if(c){a-=0.1}else{a+=0.1}core.clearMap("data",5,5,core.ui.PIXEL,b);core.setAlpha("data",a);core.fillRect("data",5,5,h,b,"#000");if(d){core.drawImage("data",d.image,d.posX*32,d.posY*32,32,32,10,8,32,32)}core.fillText("data",e,f+5,g+15,"#fff");core.setAlpha("data",1);if(a>0.6||a<0){if(c){core.clearMap("data",5,5,core.ui.PIXEL,b);clearInterval(core.interval.tipAnimate);return}else{if(!core.timeout.tipTimeout){core.timeout.tipTimeout=window.setTimeout(function(){c=true;core.timeout.tipTimeout=null},750)}a=0.6}}},30)};ui.prototype.drawText=function(b,a){if(b!=null){return this._drawText_setContent(b,a)}if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel(false);if(a){a()}return}var c=core.status.event.data.list.shift();if(typeof c=="string"){core.ui.drawTextBox(c)}else{core.ui.drawTextBox(c.content,c.id)}};ui.prototype._drawText_setContent=function(b,a){if((core.status.event&&core.status.event.id=="action")||(!core.hasFlag("__replayText__")&&core.isReplaying())){core.insertAction(b,null,null,a);return}if(!(b instanceof Array)){b=[b]}core.status.event={id:"text",data:{list:b,callback:a}};core.lockControl();core.waitHeroToStop(core.drawText);return};ui.prototype._getTitleAndIcon=function(b){var f=null,e=null,d=null,c=32,a=1;b=b.replace(/(\t|\\t)\[(([^\],]+),)?([^\],]+)\]/g,function(h,i,j,k,l){if(l){if(l=="hero"){f=core.status.hero.name;e=core.material.images.hero;d=0;var m=core.material.icons.hero.width||32;c=32*core.material.icons.hero.height/m}else{if(l.endsWith(".png")){l=core.getMappedName(l);e=core.material.images.images[l]}else{var g=core.getBlockInfo(l);if(g!=null){if(g.name){f=g.name}e=g.image;d=g.posY;c=g.height;a=g.animate}else{f=l}}}}if(k!=null){f=k;if(f=="null"){f=null}}return""});return{content:b,title:f,image:e,icon:d,height:c,animate:a}};ui.prototype._getPosition=function(a){var b=null,c=null,d=null;if(core.status.event.id=="action"){c=core.status.event.data.x;d=core.status.event.data.y}a=a.replace("\b","\\b").replace(/\\b\[(up|center|down|hero|null)(,(hero|null|\d+,\d+|\d+))?]/g,function(f,g,h,i){b=g;if(i=="hero"||g=="hero"&&!i){c=core.status.hero.loc.x;d=core.status.hero.loc.y}else{if(i=="null"){c=d=null}else{if(i){var j=i.split(",");c=d=null;if(j.length==1){var e=(core.status.hero.followers||[])[parseInt(j[0])-1];if(e){c=e.x;d=e.y}}else{c=parseInt(j[0]);d=parseInt(j[1])}}}}if(b=="hero"||b=="null"){b=d==null?"center":(d>=core.__HALF_SIZE__?"up":"down")}return""});return{content:a,position:b,px:c,py:d}};ui.prototype.drawWindowSelector=function(a,e,f,d,c){d=Math.round(d),c=Math.round(c);var b=core.ui.createCanvas("_selector",e,f,d,c,165);this._drawSelector(b,a,d,c)};ui.prototype._uievent_drawSelector=function(c){if(c.image==null){if(main.mode!="editor"){core.deleteCanvas("_uievent_selector")}return}var a=c.image||core.status.textAttribute.background;if(typeof a!="string"){return}var f=core.calValue(c.x),g=core.calValue(c.y),e=core.calValue(c.width),d=core.calValue(c.height);e=Math.round(e);d=Math.round(d);if(main.mode=="editor"){this._drawSelector("uievent",a,e,d,f,g);return}var i=136;if(core.dymCanvas.uievent){i=(parseInt(core.dymCanvas.uievent.canvas.style.zIndex)||135)+1}var b=core.createCanvas("_uievent_selector",f,g,e,d,i);this._drawSelector(b,a,e,d)};ui.prototype._drawSelector=function(b,a,f,c,d,e){d=d||0;e=e||0;b=this.getContextByName(b);if(!b){return}if(typeof a=="string"){a=core.material.images.images[a]}if(!(a instanceof Image)){return}b.drawImage(a,130,66,28,28,d+2,e+2,f-4,c-4);b.drawImage(a,128,64,2,2,d,e,2,2);b.drawImage(a,158,64,2,2,d+f-2,e,2,2);b.drawImage(a,128,94,2,2,d,e+c-2,2,2);b.drawImage(a,158,94,2,2,d+f-2,e+c-2,2,2);b.drawImage(a,130,64,28,2,d+2,e,f-4,2);b.drawImage(a,130,94,28,2,d+2,e+c-2,f-4,2);b.drawImage(a,128,66,2,28,d,e+2,2,c-4);b.drawImage(a,158,66,2,28,d+f-2,e+2,2,c-4)};ui.prototype.drawWindowSkin=function(a,b,l,m,k,g,c,i,j){a=a||core.status.textAttribute.background;if(typeof a=="string"){a=core.getMappedName(a);a=core.material.images.images[a]}var d=core.getContextByName(b);if(!d){return}d.drawImage(a,0,0,128,128,l+2,m+2,k-4,g-4);d.drawImage(a,128,0,16,16,l,m,16,16);for(var e=0;e<k-64;e+=32){d.drawImage(a,144,0,32,16,l+e+16,m,32,16);d.drawImage(a,144,48,32,16,l+e+16,m+g-16,32,16)}d.drawImage(a,144,0,k-e-32,16,l+e+16,m,k-e-32,16);d.drawImage(a,144,48,k-e-32,16,l+e+16,m+g-16,k-e-32,16);d.drawImage(a,176,0,16,16,l+k-16,m,16,16);for(var f=0;f<g-64;f+=32){d.drawImage(a,128,16,16,32,l,m+f+16,16,32);d.drawImage(a,176,16,16,32,l+k-16,m+f+16,16,32)}d.drawImage(a,128,16,16,g-f-32,l,m+f+16,16,g-f-32);d.drawImage(a,176,16,16,g-f-32,l+k-16,m+f+16,16,g-f-32);d.drawImage(a,128,48,16,16,l,m+g-16,16,16);d.drawImage(a,176,48,16,16,l+k-16,m+g-16,16,16);if(i!=null&&j!=null){if(c=="up"){d.drawImage(a,128,96,32,32,i,m+g-3,32,32)}else{if(c=="down"){d.drawImage(a,160,96,32,32,i,m-29,32,32)}}}};ui.prototype.drawBackground=function(c,h,g,b,d){d=d||{};var e=d.px==null?null:d.px*32-core.bigmap.offsetX;var f=d.py==null?null:d.py*32-core.bigmap.offsetY;var i=d.xoffset||0,j=d.yoffset||0;var a=core.status.textAttribute.background;if(this._drawBackground_drawWindowSkin(a,c,h,g,b,d.position,e,f)){return true}if(typeof a=="string"){a=core.initStatus.textAttribute.background}this._drawBackground_drawColor(a,c,h,g,b,d.position,e,f,i,j);return false};ui.prototype._uievent_drawBackground=function(b){this._createUIEvent();var a=b.background||core.status.textAttribute.background;var e=core.calValue(b.x),f=core.calValue(b.y),d=core.calValue(b.width),c=core.calValue(b.height);if(typeof a=="string"){this.drawWindowSkin(a,"uievent",e,f,d,c)}else{if(a instanceof Array){this.fillRect("uievent",e,f,d,c,core.arrayToRGBA(a));this.strokeRect("uievent",e,f,d,c)}}};ui.prototype._drawWindowSkin_getOpacity=function(){return core.getFlag("__winskin_opacity__",0.85)};ui.prototype._drawBackground_drawWindowSkin=function(a,d,i,h,b,e,f,g){if(typeof a=="string"&&core.material.images.images[a]){var c=core.material.images.images[a];if(c.width==192&&c.height==128){core.setAlpha("ui",this._drawWindowSkin_getOpacity());this.drawWindowSkin(c,"ui",d,i,h-d,b-i,e,f,g);core.setAlpha("ui",1);return true}}return false};ui.prototype._drawBackground_drawColor=function(b,e,j,i,c,f,g,h,k,l){var a=b[3];core.setAlpha("ui",a);core.setStrokeStyle("ui",core.status.globalAttribute.borderColor);core.setFillStyle("ui",core.arrayToRGB(b));core.setLineWidth("ui",2);var d=core.canvas.ui;d.beginPath();d.moveTo(e,j);if(f=="down"&&g!=null&&h!=null){d.lineTo(g+k,j);d.lineTo(g+16,j-l);d.lineTo(g+32-k,j)}d.lineTo(i,j);d.lineTo(i,c);if(f=="up"&&g!=null&&h!=null){d.lineTo(g+32-k,c);d.lineTo(g+16,c+l);d.lineTo(g+k,c)}d.lineTo(e,c);d.closePath();d.fill();d.stroke();core.setAlpha("ui",1)};ui.prototype._calTextBoxWidth=function(c,b,f,e,d){var a=core.splitLines(c,b,null,d);if(a.length==1){var g=core.calWidth(c,a[0])+10;if(g<f*2.3){return core.clamp(g/1.4,f,e)}if(g<e*2.2){return core.clamp(g/2.4,f,e)}return core.clamp(g/3.4,f,e)}else{return core.clamp(a.reduce(function(i,h){return Math.max(i,core.calWidth(c,h)+10)},0),f,e)}};ui.prototype._getDrawableIconInfo=function(b){if(b&&b.indexOf("flag:")===0){b=core.getFlag(b.substring(5),b)}var c=null,a=null;["terrains","animates","items","npcs","enemys"].forEach(function(d){if(core.material.icons[d][b]!=null){c=core.material.images[d];a=core.material.icons[d][b]}});if(c==null&&b in core.statusBar.icons){c=core.statusBar.icons[b];a=0}return[c,a]};ui.prototype._buildFont=function(b,a,d){var e=core.status.textAttribute||core.initStatus.textAttribute,c=core.status.globalAttribute||core.initStatus.globalAttribute;if(a==null){a=e.bold}return(a?"bold ":"")+(d?"italic ":"")+(b||e.textfont)+"px "+c.font};ui.prototype.drawTextContent=function(c,b,a){c=core.getContextByName(c);var e=core.status.textAttribute||core.initStatus.textAttribute;a=core.clone(a||{});a.left=a.left||0;a.right=a.left+(a.maxWidth==null?(c!=null?c.canvas.width:core.__PIXELS__):a.maxWidth);a.top=a.top||0;a.color=a.color||e.text;if(a.color instanceof Array){a.color=core.arrayToRGBA(a.color)}if(a.bold==null){a.bold=e.bold}a.italic=false;a.align=a.align||e.align||"left";a.fontSize=a.fontSize||e.textfont;a.lineHeight=a.lineHeight||(a.fontSize*1.3);a.time=a.time||0;a.index=0;a.currcolor=a.color;a.currfont=a.fontSize;a.lineMargin=Math.max(0,a.lineHeight-a.fontSize);a.topMargin=parseInt(a.lineMargin/2);a.lineMaxHeight=a.lineMargin+a.fontSize;a.offsetX=0;a.offsetY=0;a.line=0;a.blocks=[];var d=core.createCanvas("__temp__",0,0,c==null?1:c.canvas.width,c==null?1:c.canvas.height,-1);d.textBaseline="top";d.font=this._buildFont(a.fontSize,a.bold,a.italic);d.fillStyle=a.color;a=this._drawTextContent_draw(c,d,b,a);core.deleteCanvas("__temp__");return a};ui.prototype._uievent_drawTextContent=function(a){this._createUIEvent();a.left=core.calValue(a.left);a.top=core.calValue(a.top);this.drawTextContent("uievent",core.replaceText(a.text),a)};ui.prototype._drawTextContent_draw=function(d,e,c,b){while(this._drawTextContent_next(e,c,b)){}if(d==null){return b}b.index=0;var a=function(){if(b.index>=b.blocks.length){return false}var f=b.blocks[b.index++];d.drawImage(e.canvas,f.left,f.top,f.width,f.height,b.left+f.left+f.marginLeft,b.top+f.top+f.marginTop,f.width,f.height);return true};if(b.time==0){while(a()){}}else{core.status.event.interval=setInterval(function(){if(!a()){clearInterval(core.status.event.interval);core.status.event.interval=null}},b.time)}return b};ui.prototype._drawTextContent_next=function(d,c,b){if(b.index>=c.length){this._drawTextContent_newLine(d,b);return false}var a=c.charAt(b.index++);return this._drawTextContent_drawChar(d,c,b,a)};ui.prototype._drawTextContent_drawChar=function(h,f,e,b){if(b=="\n"||(b=="\\"&&f.charAt(e.index)=="n")){this._drawTextContent_newLine(h,e);if(b=="\\"){e.index++}return this._drawTextContent_next(h,f,e)}if(b=="\r"||(b=="\\"&&f.charAt(e.index)=="r")){if(b=="\\"){e.index++}return this._drawTextContent_changeColor(h,f,e)}if(b=="\\"){var a=f.charAt(e.index);if(a=="i"){return this._drawTextContent_drawIcon(h,f,e)}if(a=="c"){return this._drawTextContent_changeFont(h,f,e)}if(a=="d"||a=="e"){e.index++;if(a=="d"){e.bold=!e.bold}if(a=="e"){e.italic=!e.italic}h.font=this._buildFont(e.currfont,e.bold,e.italic);return true}}if(b=="\\"&&f.charAt(e.index)=="e"){e.italic=!e.italic;h.font=this._buildFont(e.fontSize,e.bold,e.italic)}var d=core.calWidth(h,b);if(e.maxWidth!=null&&e.offsetX+d>e.maxWidth){this._drawTextContent_newLine(h,e);e.index--;return this._drawTextContent_next(h,f,e)}var g=e.offsetX,i=e.offsetY+e.topMargin;core.fillText(h,b,g,i);e.blocks.push({left:e.offsetX,top:e.offsetY,width:d,height:e.currfont+e.lineMargin,line:e.line,marginLeft:0});e.offsetX+=d;return true};ui.prototype._drawTextContent_newLine=function(c,a){var e=a.offsetX,d=a.right-a.left;var b=0;if(a.align=="center"){b=(d-e)/2}else{if(a.align=="right"){b=d-e}}a.blocks.forEach(function(f){if(f.line==a.line){f.marginLeft=b;f.marginTop=(a.lineMaxHeight-f.height)/2}});a.offsetX=0;a.offsetY+=a.lineMaxHeight;a.lineMaxHeight=a.currfont+a.lineMargin;a.line++};ui.prototype._drawTextContent_changeColor=function(f,b,a){var c=a.index,d;if(b.charAt(c)=="["&&((d=b.indexOf("]",c))>=0)){var e=b.substring(c+1,d);if(e==""){f.fillStyle=a.color}else{f.fillStyle=e}a.index=d+1}else{f.fillStyle=a.color}return this._drawTextContent_next(f,b,a)};ui.prototype._drawTextContent_changeFont=function(f,b,a){a.index++;var c=a.index,d;if(b.charAt(c)=="["&&((d=b.indexOf("]",c))>=0)){var e=b.substring(c+1,d);if(!/^\d+$/.test(e)){a.currfont=a.fontSize}else{a.currfont=parseInt(e)}a.index=d+1}else{a.currfont=a.fontSize}a.lineMaxHeight=Math.max(a.lineMaxHeight,a.currfont+a.lineMargin);f.font=this._buildFont(a.currfont,a.bold,a.italic);return this._drawTextContent_next(f,b,a)};ui.prototype._drawTextContent_drawIcon=function(j,b,a){var f=a.index,g;if(b.charAt(a.index+1)=="["&&((g=b.indexOf("]",f+1))>=0)){var i=b.substring(f+2,g);var d=core.ui._getDrawableIconInfo(i),e=d[0],c=d[1];if(e==null){return this._drawTextContent_next(j,b,a)}var l=a.currfont+2,h=a.offsetX+2,k=a.offsetY+a.topMargin-1;if(a.maxWidth!=null&&h+l>a.maxWidth){this._drawTextContent_newLine(j,a);a.index--;return this._drawTextContent_next(j,b,a)}core.drawImage(j,e,0,32*c,32,32,h,k,l,l);a.blocks.push({left:h,top:a.offsetY,width:l,height:l+a.lineMargin,line:a.line,marginLeft:0});a.offsetX+=l+6;a.index=g+1;return true}return this._drawTextContent_next(j,b,a)};ui.prototype.getTextContentHeight=function(b,a){return this.drawTextContent(null,b,a).offsetY};ui.prototype._getRealContent=function(a){return a.replace(/(\r|\\(r|c|d|e))(\[.*?])?/g,"").replace(/(\\i)(\[.*?])?/g,"占1")};ui.prototype.drawTextBox=function(c,j){if(core.status.event&&core.status.event.id=="action"){core.status.event.ui=c}this.clearUI();c=core.replaceText(c);var k=core.status.textAttribute;var l=this._getTitleAndIcon(c);var i=this._getPosition(l.content);if(i.position!="up"&&i.position!="down"){i.px=i.py=null}if(!i.position){i.position=k.position}c=this._drawTextBox_drawImages(i.content);var e=this._drawTextBox_getHorizontalPosition(c,l,i);var m=this._drawTextBox_getVerticalPosition(c,l,i,e.validWidth);var h=core.clone(i);h.xoffset=e.xoffset;h.yoffset=m.yoffset-4;var f=this.drawBackground(e.left,m.top,e.right,m.bottom,h);var a=f?this._drawWindowSkin_getOpacity():k.background[3];var d=this._drawTextBox_drawTitleAndIcon(l,e,m,a);var b=this.drawTextContent("ui",c,{left:e.content_left,top:d,maxWidth:e.validWidth,lineHeight:m.lineHeight,time:(j||k.time<=0||core.status.event.id!="action")?0:k.time});main.dom.next.style.display="block";main.dom.next.style.borderRightColor=main.dom.next.style.borderBottomColor=core.arrayToRGB(k.text);main.dom.next.style.top=(m.bottom-20)*core.domStyle.scale+"px";var g=(e.left+e.right)/2;if(h.position=="up"&&h.px!=null&&Math.abs(h.px*32+16-g)<50){g=e.right-64}main.dom.next.style.left=g*core.domStyle.scale+"px";return b};ui.prototype._drawTextBox_drawImages=function(a){return a.replace(/(\f|\\f)\[(.*?)]/g,function(f,e,d){var c=d.split(",");if(c.length!=3&&c.length!=5&&c.length!=9){return""}c[0]=core.getMappedName(c[0]);var b=core.material.images.images[c[0]];if(!b){return""}if(c.length==3){core.drawImage("ui",b,parseFloat(c[1]),parseFloat(c[2]))}else{if(c.length==5){core.drawImage("ui",b,0,0,b.width,b.height,parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]),parseFloat(c[4]))}else{if(c.length==9||c.length==10){if(c.length==10){core.setAlpha("ui",parseFloat(c[9]))}core.drawImage("ui",b,parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]),parseFloat(c[4]),parseFloat(c[5]),parseFloat(c[6]),parseFloat(c[7]),parseFloat(c[8]));core.setAlpha("ui",1)}}}return""})};ui.prototype._drawTextBox_getHorizontalPosition=function(a,j,g){var h=this._getRealContent(a);var e=25,f=12;if(g.px!=null&&g.py!=null){e=20}if(j.icon!=null){e=62}else{if(j.image){e=90}}var b=7+3*(this.HSIZE-6),i=this.PIXEL-b,l=i-b,k=l-e-f;if(g.px!=null&&g.py!=null){var d=220-e,c=k;if(j.image==null){d=160}k=this._calTextBoxWidth("ui",h,d,c,this._buildFont());l=k+e+f;b=core.clamp(32*g.px+16-l/2-core.bigmap.offsetX,b,i-l);i=b+l}return{left:b,right:i,width:l,validWidth:k,xoffset:11,content_left:b+e}};ui.prototype._drawTextBox_getVerticalPosition=function(a,f,d,h){var e=core.status.textAttribute||core.initStatus.textAttribute;var c=e.textfont+6;var b=45+this.getTextContentHeight(a,{lineHeight:c,maxWidth:h});if(f.title){b+=e.titlefont+5}if(f.icon!=null){if(f.title){b=Math.max(b,f.height+50)}else{b=Math.max(b,f.height+30)}}else{if(f.image){b=Math.max(b,90)}}var i=16;var g=parseInt((this.PIXEL-b)/2);switch(d.position){case"center":g=parseInt((this.PIXEL-b)/2);break;case"up":if(d.px==null||d.py==null){g=5+e.offset}else{g=32*d.py-b-(f.height-32)-i-core.bigmap.offsetY}break;case"down":if(d.px==null||d.py==null){g=this.PIXEL-b-5-e.offset}else{g=32*d.py+32+i-core.bigmap.offsetY}}return{top:g,height:b,bottom:g+b,yoffset:i,lineHeight:c}};ui.prototype._drawTextBox_drawTitleAndIcon=function(i,c,j,a){core.setTextAlign("ui","left");var e=core.status.textAttribute;var b=j.top+15;var d=j.top+15;if(i.title!=null){var h=e.titlefont;b+=h+5;d=j.top+40;core.setFillStyle("ui",core.arrayToRGB(e.title));core.setStrokeStyle("ui",core.arrayToRGB(e.title));var g=core.calWidth("ui",i.title,this._buildFont(h,true));var f=c.content_left;if(e.align=="center"){f=c.left+(c.width-g)/2}else{if(e.align=="right"){f=c.right-g-12}}core.fillText("ui",i.title,f,j.top+8+h)}if(i.icon!=null){core.setAlpha("ui",a);core.strokeRect("ui",c.left+15-1,d-1,34,i.height+2,null,2);core.setAlpha("ui",1);core.status.boxAnimateObjs=[];if(i.image==core.material.images.hero){core.clearMap("ui",c.left+15,d,32,i.height);core.fillRect("ui",c.left+15,d,32,i.height,core.material.groundPattern);core.drawImage("ui",i.image,0,0,core.material.icons.hero.width||32,core.material.icons.hero.height,c.left+15,d,32,i.height)}else{core.status.boxAnimateObjs.push({bgx:c.left+15,bgy:d,bgWidth:32,bgHeight:i.height,x:c.left+15,y:d,height:i.height,animate:i.animate,image:i.image,pos:i.icon*i.height})}core.drawBoxAnimate()}if(i.image!=null&&i.icon==null){core.drawImage("ui",i.image,0,0,i.image.width,i.image.height,c.left+10,j.top+10,70,70)}return b};ui.prototype._createTextCanvas=function(a,d){var e=this.PIXEL,c=30+this.getTextContentHeight(a,{lineHeight:d});var b=document.createElement("canvas").getContext("2d");b.canvas.width=e;b.canvas.height=c;b.clearRect(0,0,e,c);return b};ui.prototype.drawScrollText=function(b,g,d,a){b=core.replaceText(b||"");d=d||1.4;g=g||5000;this.clearUI();var f=core.status.textAttribute.offset||15;d*=core.status.textAttribute.textfont;var c=this._createTextCanvas(b,d);var e={align:core.status.textAttribute.align,lineHeight:d};if(e.align=="right"){e.left=this.PIXEL-f}else{if(e.align!="center"){e.left=f}}this.drawTextContent(c,b,e);this._drawScrollText_animate(c,g,a)};ui.prototype._drawScrollText_animate=function(c,h,b){h/=Math.max(core.status.replay.speed,1);var f=1,e=c.canvas.height,g=h*f/(this.PIXEL+e);var d=this.PIXEL;core.drawImage("ui",c.canvas,0,d);var a=setInterval(function(){core.clearMap("ui");d-=f;if(d<-e){delete core.animateFrame.asyncId[a];clearInterval(a);if(core.isset(b)){b()}return}core.drawImage("ui",c.canvas,0,d)},g);core.animateFrame.asyncId[a]=true};ui.prototype.textImage=function(a,c){a=core.replaceText(a||"");c=c||1.4;c*=core.status.textAttribute.textfont;var b=this._createTextCanvas(a,c);this.drawTextContent(b,a,{align:core.status.textAttribute.align,lineHeight:c});return b.canvas};ui.prototype.drawChoices=function(b,a){a=core.clone(a||[]);core.status.event.ui={text:b,choices:a};this.clearUI();b=core.replaceText(b||"");var e=this._getTitleAndIcon(b);e.content=this._drawTextBox_drawImages(e.content);var c=this._drawChoices_getHorizontalPosition(e,a);var f=this._drawChoices_getVerticalPosition(e,a,c);core.status.event.ui.offset=f.offset;var d=this.drawBackground(c.left,f.top,c.right,f.bottom);this._drawChoices_drawTitle(e,c,f);this._drawChoices_drawChoices(a,d,c,f)};ui.prototype._drawChoices_getHorizontalPosition=function(f,a){var h=246;core.setFont("ui",this._buildFont(17,true));for(var c=0;c<a.length;c++){if(typeof a[c]==="string"){a[c]={text:a[c]}}a[c].text=core.replaceText(a[c].text);a[c].width=core.calWidth("ui",core.replaceText(a[c].text));if(a[c].icon!=null){a[c].width+=28}h=Math.max(h,a[c].width+30)}var d=(this.PIXEL-h)/2,e=d+h;var b=d+(f.icon==null?15:60),g=e-b-10;return{left:d,right:e,width:h,content_left:b,validWidth:g}};ui.prototype._drawChoices_getVerticalPosition=function(i,c,f){var g=c.length;var e=32*(g+2),a=this.HPIXEL+e/2;if(g%2==0){a+=16}var h=0;var b=a-e+56;if(i.content){var d=0;if(i.title){d+=25}d+=this.getTextContentHeight(i.content,{lineHeight:20,maxWidth:f.validWidth,fontSize:15,bold:true});e+=d;if(a-e<=32){h=Math.floor(d/64);a+=32*h;b+=32*h}}return{top:a-e,height:e,bottom:a,choice_top:b,offset:h}};ui.prototype._drawChoices_drawTitle=function(d,b,e){if(!d.content){return}var a=e.top+21;if(d.title!=null){core.setTextAlign("ui","center");a=e.top+41;var c=b.left+b.width/2;if(d.icon!=null){c+=12;core.strokeRect("ui",b.left+15-1,e.top+30-1,34,d.height+2,"#DDDDDD",2);core.status.boxAnimateObjs=[];core.status.boxAnimateObjs.push({bgx:b.left+15,bgy:e.top+30,bgWidth:32,bgHeight:d.height,x:b.left+15,y:e.top+30,height:d.height,animate:d.animate,image:d.image,pos:d.icon*d.height});core.drawBoxAnimate()}core.fillText("ui",d.title,c,e.top+27,core.arrayToRGBA(core.status.textAttribute.title),this._buildFont(19,true))}core.setTextAlign("ui","left");this.drawTextContent("ui",d.content,{left:b.content_left,top:a,maxWidth:b.validWidth,fontSize:15,lineHeight:20,bold:true})};ui.prototype._drawChoices_drawChoices=function(a,h,c,l){core.setTextAlign("ui","center");core.setFont("ui",this._buildFont(17,true));for(var d=0;d<a.length;d++){var b=a[d].color||core.status.textAttribute.text;if(b instanceof Array){b=core.arrayToRGBA(b)}core.setFillStyle("ui",b);var k=this.HPIXEL;if(core.isset(a[d].icon)){var f=this._getDrawableIconInfo(a[d].icon),g=f[0],e=f[1];if(g!=null){core.drawImage("ui",g,0,32*e,32,32,this.HPIXEL-a[d].width/2,l.choice_top+32*d-17,22,22);k+=14}}core.fillText("ui",a[d].text,k,l.choice_top+32*d,b)}if(a.length>0){core.status.event.selection=core.status.event.selection||0;while(core.status.event.selection<0){core.status.event.selection+=a.length}while(core.status.event.selection>=a.length){core.status.event.selection-=a.length}var j=a[core.status.event.selection].width;if(h){this.drawWindowSelector(core.status.textAttribute.background,this.HPIXEL-j/2-5,l.choice_top+32*core.status.event.selection-20,j+10,28)}else{core.strokeRect("ui",this.HPIXEL-j/2-5,l.choice_top+32*core.status.event.selection-20,j+10,28,"#FFD700",2)}}};ui.prototype.drawConfirmBox=function(h,j,e){core.lockControl();h=core.replaceText(h||"");if(core.status.event.id!="action"){core.status.event.id="confirmBox";core.status.event.ui=h;core.status.event.data={yes:j,no:e}}if(core.status.event.selection!=0){core.status.event.selection=1}this.clearUI();core.setFont("ui",this._buildFont(19,true));var a=h.split("\n");var f=this._drawConfirmBox_getRect(a);var c=this.drawBackground(f.left,f.top,f.right,f.bottom);core.setTextAlign("ui","center");core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.text));for(var b in a){core.fillText("ui",a[b],this.HPIXEL,f.top+50+b*30)}core.fillText("ui","确定",this.HPIXEL-38,f.bottom-35,null,this._buildFont(17,true));core.fillText("ui","取消",this.HPIXEL+38,f.bottom-35);var d=core.calWidth("ui","确定");var g=this.HPIXEL+(76*core.status.event.selection-38)-parseInt(d/2)-5;if(c){this.drawWindowSelector(core.status.textAttribute.background,g,f.bottom-35-20,d+10,28)}else{core.strokeRect("ui",g,f.bottom-35-20,d+10,28,"#FFD700",2)}};ui.prototype._drawConfirmBox_getRect=function(b){var d=b.reduce(function(h,g){return Math.max(h,core.calWidth("ui",g))},0);var c=Math.min(this.HPIXEL-40-parseInt(d/2),100),e=this.PIXEL-c;var f=this.HPIXEL-68-(b.length-1)*30,a=this.HPIXEL+68;return{top:f,left:c,bottom:a,right:e,width:e-c,height:a-f}};ui.prototype.drawWaiting=function(e){core.lockControl();core.status.event.id="waiting";core.clearUI();e=core.replaceText(e||"");var f=core.calWidth("ui",e,this._buildFont(19,true));var h=Math.max(f+80,220),c=this.HPIXEL-parseInt(h/2),d=c+h;var g=this.HPIXEL-48,b=96,a=g+b;this.drawBackground(c,g,d,a);core.setTextAlign("ui","center");core.fillText("ui",e,this.HPIXEL,g+56,core.arrayToRGBA(core.status.textAttribute.text))};ui.prototype.drawSwitchs=function(){core.status.event.id="switchs";var a=["背景音乐： "+(core.musicStatus.bgmStatus?"[ON]":"[OFF]"),"背景音效： "+(core.musicStatus.soundStatus?"[ON]":"[OFF]"),"行走速度： "+parseInt(core.values.moveSpeed),"怪物显伤： "+(core.flags.displayEnemyDamage?"[ON]":"[OFF]"),"临界显伤： "+(core.flags.displayCritical?"[ON]":"[OFF]"),"领域显伤： "+(core.flags.displayExtraDamage?"[ON]":"[OFF]"),"新版存档： "+(core.platform.useLocalForage?"[ON]":"[OFF]"),"单击瞬移： "+(!core.hasFlag("__noClickMove__")?"[ON]":"[OFF]"),"返回主菜单"];this.drawChoices(null,a)};ui.prototype.drawSettings=function(){core.status.event.id="settings";this.drawChoices(null,["系统设置","虚拟键盘","浏览地图","绘图模式","同步存档","游戏信息","返回标题","返回游戏"])};ui.prototype.drawQuickShop=function(){core.status.event.id="selectShop";var c=core.status.shops,b=Object.keys(c).filter(function(d){return c[d].visited||!c[d].mustEnable});var a=b.map(function(d){return{text:c[d].textInList,color:c[d].visited?null:"#999999"}});a.push("返回游戏");this.drawChoices(null,a)};ui.prototype.drawSyncSave=function(){core.status.event.id="syncSave";this.drawChoices(null,["同步存档到服务器","从服务器加载存档","存档至本地文件","从本地文件读档","回放和下载录像","清空本地存档","返回主菜单"])};ui.prototype.drawSyncSelect=function(){core.status.event.id="syncSelect";this.drawChoices(null,["同步本地所有存档","只同步当前单存档","返回上级菜单"])};ui.prototype.drawLocalSaveSelect=function(){core.status.event.id="localSaveSelect";this.drawChoices(null,["下载所有存档","只下载当前单存档","返回上级菜单"])};ui.prototype.drawStorageRemove=function(){core.status.event.id="storageRemove";this.drawChoices(null,["清空全部塔的存档","只清空当前塔的存档","返回上级菜单"])};ui.prototype.drawReplay=function(){core.lockControl();core.status.event.id="replay";this.drawChoices(null,["从头回放录像","从存档开始回放","接续播放剩余录像","选择录像文件","下载当前录像","返回游戏"])};ui.prototype.drawGameInfo=function(){core.status.event.id="gameInfo";this.drawChoices(null,["数据统计","查看工程","游戏主页","操作帮助","关于本塔","下载离线版本","返回主菜单"])};ui.prototype.drawPagination=function(b,c,d){if(c<=1){return}if(d==null){d=this.LAST}core.setFillStyle("ui","#DDDDDD");var a=core.calWidth("ui",b+" / "+b,this._buildFont(15,true));core.setTextAlign("ui","left");core.fillText("ui",b+" / "+c,parseInt((this.PIXEL-a)/2),d*32+19);core.setTextAlign("ui","center");if(b>1){core.fillText("ui","上一页",this.HPIXEL-80,d*32+19)}if(b<c){core.fillText("ui","下一页",this.HPIXEL+80,d*32+19)}};ui.prototype.drawCursor=function(){var a=core.status.automaticRoute;if(a.cursorX==null){a.cursorX=core.getHeroLoc("x")}if(a.cursorY==null){a.cursorY=core.getHeroLoc("y")}a.cursorX=core.clamp(a.cursorX,0,this.LAST);core.status.event.id="cursor";core.lockControl();core.clearUI();var b=4;core.strokeRect("ui",32*a.cursorX+b/2,32*a.cursorY+b/2,32-b,32-b,"#FFD700",b)};ui.prototype.drawBook=function(d){var b=core.floorIds[(core.status.event.ui||{}).index]||core.status.floorId;var a=core.enemys.getCurrentEnemys(b);core.clearUI();core.clearMap("data");core.maps.generateGroundPattern(b);this._drawBook_drawBackground();core.setAlpha("ui",1);if(a.length==0){core.setTextAlign("ui","center");core.fillText("ui","本层无怪物",this.HPIXEL,this.HPIXEL+14,"#999999",this._buildFont(50,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13,"#DDDDDD",this._buildFont(15,true));return}d=core.clamp(d,0,a.length-1);core.status.event.data=d;var f=this._drawBook_pageinfo();var g=f.per_page,e=parseInt(d/g)+1,j=Math.ceil(a.length/g);var h=(e-1)*g;a=a.slice(h,e*g);for(var c=0;c<a.length;c++){this._drawBook_drawOne(b,c,a[c],f,d==h+c)}core.drawBoxAnimate();this.drawPagination(e,j);core.setTextAlign("ui","center");core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13,"#DDDDDD",this._buildFont(15,true))};ui.prototype._drawBook_pageinfo=function(){var c=this.HSIZE;var a=12;var b=(this.PIXEL-32-a)/c;return{per_page:c,padding_top:a,per_height:b}};ui.prototype._drawBook_drawBackground=function(){core.setAlpha("ui",1);core.setFillStyle("ui",core.material.groundPattern);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL);core.setAlpha("ui",0.6);core.setFillStyle("ui","#000000");core.fillRect("ui",0,0,this.PIXEL,this.PIXEL)};ui.prototype._drawBook_drawOne=function(b,c,a,f,g){var h=f.per_height*c+f.padding_top;this._drawBook_drawBox(c,a,h,f);var d=64,i=this.PIXEL-d;var e=i*10/35;this._drawBook_drawName(c,a,h,d,e);this._drawBook_drawContent(c,a,h,d+e);if(g){core.strokeRect("ui",10,h+1,this.PIXEL-10*2,f.per_height,"#FFD700")}};ui.prototype._drawBook_drawBox=function(g,d,i,h){var c=i+(h.per_height-42)/2,b=22;var f=c+5,e=b+5;core.strokeRect("ui",22,c,42,42,"#DDDDDD",2);var a=core.getBlockInfo(d.id);core.status.boxAnimateObjs.push({bgx:b,bgy:c,bgWidth:42,bgHeight:42,x:e,y:f,height:32,animate:a.animate,image:a.image,pos:a.posY*a.height})};ui.prototype._drawBook_drawName=function(b,a,d,c,e){core.setTextAlign("ui","center");if(a.specialText==""){core.fillText("ui",a.name,c+e/2,d+35,"#DDDDDD",this._buildFont(17,true))}else{core.fillText("ui",a.name,c+e/2,d+28,"#DDDDDD",this._buildFont(17,true));core.fillText("ui",a.specialText,c+e/2,d+50,"#FF6A6A",this._buildFont(15,true))}};ui.prototype._drawBook_drawContent=function(b,a,d,c){var e=this.PIXEL-c;this._drawBook_drawRow1(b,a,d,c,e,d+20);this._drawBook_drawRow2(b,a,d,c,e,d+38);this._drawBook_drawRow3(b,a,d,c,e,d+56)};ui.prototype._drawBook_drawRow1=function(g,e,j,h,k,i){core.setTextAlign("ui","left");var a=this._buildFont(13,true),f=this._buildFont(13,false);var b=h,c=h+k*9/25,d=h+k*17/25;core.fillText("ui","生命",b,i,"#DDDDDD",f);core.fillText("ui",core.formatBigNumber(e.hp||0),b+30,i,null,a);core.fillText("ui","攻击",c,i,null,f);core.fillText("ui",core.formatBigNumber(e.atk||0),c+30,i,null,a);core.fillText("ui","防御",d,i,null,f);core.fillText("ui",core.formatBigNumber(e.def||0),d+30,i,null,a)};ui.prototype._drawBook_drawRow2=function(h,f,m,i,n,k){core.setTextAlign("ui","left");var a=this._buildFont(13,true),g=this._buildFont(13,false);var b=i,c=i+n*9/25,d=i+n*17/25;var l=[];if(core.flags.enableMoney){l.push(["金币",core.formatBigNumber(f.money||0)])}if(core.flags.enableAddPoint){l.push(["加点",core.formatBigNumber(f.point||0)])}if(core.flags.enableExperience){l.push(["经验",core.formatBigNumber(f.experience||0)])}var e=b+(this.PIXEL-b)/2-12;if(l.length>0){var j=l.shift();core.fillText("ui",j[0],b,k,"#DDDDDD",g);core.fillText("ui",j[1],b+30,k,null,a);e=c+(this.PIXEL-c)/2-12}if(l.length>0){var j=l.shift();core.fillText("ui",j[0],c,k,"#DDDDDD",g);core.fillText("ui",j[1],c+30,k,null,a);e=d+(this.PIXEL-d)/2-12}this._drawBook_drawDamage(h,f,e,k)};ui.prototype._drawBook_drawRow3=function(g,e,j,h,k,i){core.setTextAlign("ui","left");var a=this._buildFont(13,true),f=this._buildFont(13,false);var b=h,c=h+k*9/25,d=h+k*17/25;core.fillText("ui","临界",b,i,"#DDDDDD",f);core.fillText("ui",core.formatBigNumber(e.critical||0),b+30,i,null,a);core.fillText("ui","减伤",c,i,null,f);core.fillText("ui",core.formatBigNumber(e.criticalDamage||0),c+30,i,null,a);core.fillText("ui","1防",d,i,null,f);core.fillText("ui",core.formatBigNumber(e.defDamage||0),d+30,i,null,a)};ui.prototype._drawBook_drawDamage=function(d,c,e,f){core.setTextAlign("ui","center");var b=c.damage,a="#FFFF00";if(b==null){b="无法战斗";a="#FF0000"}else{if(b>=core.status.hero.hp){a="#FF0000"}if(b<=0){a="#00FF00"}b=core.formatBigNumber(b);if(core.enemys.hasSpecial(c,19)){b+="+"}if(core.enemys.hasSpecial(c,21)){b+="-"}if(core.enemys.hasSpecial(c,11)){b+="^"}}if(c.notBomb){b+="[b]"}core.fillText("ui",b,e,f,a,this._buildFont(13,true))};ui.prototype.drawBookDetail=function(g){var h=this._drawBookDetail_getInfo(g),e=h[0];if(!e){return}var b=h[1].join("\n");core.status.event.id="book-detail";clearInterval(core.interval.tipAnimate);core.clearMap("data");var i=10,m=this.PIXEL-2*i,j=i+m;var c=i+25,l=j-c-13;var d=core.splitLines("data",b,l,this._buildFont(16,false));var f=Math.max(24*d.length+55,80),k=(this.PIXEL-f)/2,a=k+f;core.setAlpha("data",0.9);core.fillRect("data",i,k,m,f,"#000000");core.setAlpha("data",1);core.strokeRect("data",i-1,k-1,m+1,f+1,core.status.globalAttribute.borderColor,2);this._drawBookDetail_drawContent(e,d,{top:k,content_left:c,bottom:a})};ui.prototype._drawBookDetail_getInfo=function(e){var d=core.floorIds[(core.status.event.ui||{}).index]||core.status.floorId;var c=core.enemys.getCurrentEnemys(d);if(c.length==0){return[]}e=core.clamp(e,0,c.length-1);var a=c[e],b=a.id;var f=core.enemys.getSpecialHint(b);if(f.length==0){f.push("该怪物无特殊属性。")}f.push("");this._drawBookDetail_getTexts(a,d,f);return[a,f]};ui.prototype._drawBookDetail_getTexts=function(a,b,c){this._drawBookDetail_mofang(a,c);this._drawBookDetail_vampire(a,c);this._drawBookDetail_hatred(a,c);this._drawBookDetail_turnAndCriticals(a,b,c)};ui.prototype._drawBookDetail_mofang=function(b,d){if(core.enemys.hasSpecial(b.special,10)){var c=b.hp;var a=core.status.hero.atk-core.status.hero.def;if(a<c&&c<=10000&&c>0){d.push("模仿临界计算器：（当前攻防差"+core.formatBigNumber(a)+"）");var e=[];this._drawBookDetail_mofang_getArray(c).forEach(function(f){if(e.length<20){e.push(f)}else{if(Math.abs(f[0]-a)<Math.abs(e[0][0]-a)){e.shift();e.push(f)}}});d.push(JSON.stringify(e.map(function(f){return core.formatBigNumber(f[0])+":"+f[1]})))}}};ui.prototype._drawBookDetail_mofang_getArray=function(b){var a=[];var d=0,f=0;for(var c=1;c<b;c++){var e=parseInt((b-1)/c);if(e!=d){if(d!=0){a.push([f,d+"x"])}d=e;f=c}}if(d!=0){a.push([f,"1x"]);a.push([b,"0"])}return a};ui.prototype._drawBookDetail_vampire=function(c,g){if(core.enemys.hasSpecial(c.special,11)){var a=core.getDamage(c.id);if(a!=null){var f=1,b=100*a;var e=core.status.hero.hp;while(f<b){var d=Math.floor((f+b)/2);core.status.hero.hp=d;if(core.canBattle(c.id)){b=d}else{f=d+1}}core.status.hero.hp=f;if(core.canBattle(c.id)){g.push("打死该怪物最低需要生命值："+core.formatBigNumber(f))}core.status.hero.hp=e}}};ui.prototype._drawBookDetail_hatred=function(a,b){if(core.enemys.hasSpecial(a.special,17)){b.push("当前仇恨伤害值："+core.getFlag("hatred",0))}};ui.prototype._drawBookDetail_turnAndCriticals=function(c,d,f){var b=core.getDamageInfo(c,null,null,null,d);f.push("战斗回合数："+((b||{}).turn||0));var a=core.enemys.nextCriticals(c,8,null,null,d).map(function(g){return core.formatBigNumber(g[0])+":"+core.formatBigNumber(g[1])});while(a[0]=="0:0"){a.shift()}f.push("临界表："+JSON.stringify(a));var e=core.getDamageInfo(c,{atk:core.status.hero.atk-1},null,null,d);if(e!=null&&b!=null){if(b.damage!=null){b=b.damage}if(e.damage!=null){e=e.damage}if(e>b){f.push("（当前攻击力正位于临界点上）")}}};ui.prototype._drawBookDetail_drawContent=function(c,b,g){core.setTextAlign("data","left");core.fillText("data",c.name,g.content_left,g.top+30,"#FFD700",this._buildFont(22,true));var a=g.top+57;for(var d=0;d<b.length;d++){var h=b[d];var e=h.indexOf("：");if(e>=0){var j=h.substring(0,e+1);core.fillText("data",j,g.content_left,a,"#FF6A6A",this._buildFont(16,true));var f=core.calWidth("data",j);core.fillText("data",h.substring(e+1),g.content_left+f,a,"#FFFFFF",this._buildFont(16,false))}else{core.fillText("data",b[d],g.content_left,a,"#FFFFFF",this._buildFont(16,false))}a+=24}};ui.prototype.drawFly=function(e){core.status.event.data=e;var a=core.floorIds[e];var h=core.status.maps[a].title;core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000");core.setAlpha("ui",1);core.setTextAlign("ui","center");core.fillText("ui","楼层跳跃",this.HPIXEL,60,"#FFFFFF",this._buildFont(28,true));core.fillText("ui","返回游戏",this.HPIXEL,this.PIXEL-13,null,this._buildFont(15,true));var d=this.HPIXEL+39;var c=core.splitLines("ui",h,120,this._buildFont(19,true));var g=d-(c.length-1)*11;for(var b in c){core.fillText("ui",c[b],this.PIXEL-60,g);g+=22}if(core.actions._getNextFlyFloor(1)!=e){core.fillText("ui","▲",this.PIXEL-60,d-64,null,this._buildFont(17,false));core.fillText("ui","▲",this.PIXEL-60,d-96);core.fillText("ui","▲",this.PIXEL-60,d-96-7)}if(core.actions._getNextFlyFloor(-1)!=e){core.fillText("ui","▼",this.PIXEL-60,d+64,null,this._buildFont(17,false));core.fillText("ui","▼",this.PIXEL-60,d+96);core.fillText("ui","▼",this.PIXEL-60,d+96+7)}var f=this.PIXEL-143;core.strokeRect("ui",20,100,f,f,"#FFFFFF",2);core.drawThumbnail(a,null,null,{ctx:"ui",x:20,y:100,size:f})};ui.prototype.drawCenterFly=function(){core.lockControl();core.status.event.id="centerFly";var a="rgba(255,0,0,0.5)";if(core.canUseItem("centerFly")){a="rgba(0,255,0,0.5)"}var d=core.bigmap.width-1-core.getHeroLoc("x"),e=core.bigmap.height-1-core.getHeroLoc("y");core.drawThumbnail(null,null,{heroLoc:core.status.hero.loc,heroIcon:core.getFlag("heroIcon","hero.png")},{ctx:"ui",centerX:d,centerY:e});var b=core.clamp(d-core.__HALF_SIZE__,0,core.bigmap.width-core.__SIZE__),c=core.clamp(e-core.__HALF_SIZE__,0,core.bigmap.height-core.__SIZE__);core.fillRect("ui",(d-b)*32,(e-c)*32,32,32,a);core.status.event.data={x:d,y:e,posX:d-b,posY:e-c};core.drawTip("请确认当前中心对称飞行器的位置");return};ui.prototype.drawShop=function(k){var j=core.status.shops[k];var a=[],e=(core.status.event.data||{}).fromList,h=core.status.event.selection;if(core.status.event.data&&core.status.event.data.actions){a=core.status.event.data.actions}core.ui.closePanel();core.lockControl();core.status.event.id="shop";core.status.event.data={id:k,shop:j,actions:a,fromList:e};core.status.event.selection=h;var m=j.times,g=core.calValue(j.need,null,null,m);var d="\t["+j.name+","+j.icon+"]"+core.replaceText(j.text,g,m);var n=j.use=="experience"?"经验":"金币";var c=[];for(var f=0;f<j.choices.length;f++){var b=j.choices[f];var l=core.replaceText(b.text,g,m);if(core.isset(b.need)){l+="（"+core.calValue(b.need,null,null,m)+n+"）"}c.push({text:l,color:j.visited?null:"#999999"})}c.push("离开");core.ui.drawChoices(d,c)};ui.prototype.drawMaps=function(c,k,l){core.lockControl();core.status.event.id="viewMaps";this.clearUI();if(c==null){return this._drawMaps_drawHint()}clearTimeout(core.interval.tipAnimate);core.status.checkBlock.cache={};var a=this._drawMaps_buildData(c,k,l);core.drawThumbnail(a.floorId,null,{damage:a.damage},{ctx:"ui",centerX:a.x,centerY:a.y,all:a.all});if(a.paint){var d=32*(a.x-this.HSIZE),e=32*(a.y-this.HSIZE);var i=core.paint[a.floorId];if(i){i=lzw_decode(i).split(",")}core.utils._decodeCanvas(i,32*a.mw,32*a.mh);core.drawImage("ui",core.bigmap.tempCanvas.canvas,d*32,e*32,this.PIXEL,this.PIXEL,0,0,this.PIXEL,this.PIXEL)}core.clearMap("data");core.setTextAlign("data","left");core.setFont("data","16px Arial");var f=core.status.maps[a.floorId].title;if(!a.all&&(a.mw>this.SIZE||a.mh>this.SIZE)){f+=" ["+(a.x-this.HSIZE)+","+(a.y-this.HSIZE)+"]"}var g=16,h=18,j=g+core.calWidth("data",f)+16,b=42;core.fillRect("data",5,5,j,b,"rgba(0,0,0,0.4)");core.fillText("data",f,g+5,h+15,"rgba(255,255,255,0.6)")};ui.prototype._drawMaps_drawHint=function(){core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"rgba(0,0,0,0.4)");core.setTextAlign("ui","center");var g=function(k,m,n,j,i,l){core.strokeRect("ui",k*32+2,m*32+2,n*32-4,j*32-4,i,l)};var d=this.HSIZE-4;g(d,0,9,d,"#FFD700",4);g(0,d,d,9);g(d,this.SIZE-d,9,d);g(this.SIZE-d,d,d,9);g(d,d,9,3);g(d,this.SIZE-d-3,9,3);g(0,0,d-1,d-1);g(this.SIZE-(d-1),0,d-1,d-1);g(0,this.SIZE-(d-1),d-1,d-1);core.setTextBaseline("ui","middle");core.fillText("ui","上移地图 [W]",this.HPIXEL,d*16,"#FFD700","20px Arial");core.fillText("ui","下移地图 [S]",this.HPIXEL,this.PIXEL-d*16);core.fillText("ui","V",(d-1)*16,(d-1)*16);core.fillText("ui","Z",this.PIXEL-(d-1)*16,(d-1)*16);core.fillText("ui","M",(d-1)*16,this.PIXEL-(d-1)*16);var h=this.HPIXEL-66,b=d*16,e=this.PIXEL-b;var c=["左","移","地","图","[A]"],f=["右","移","地","图","[D]"];for(var a=0;a<5;++a){core.fillText("ui",c[a],b,h+32*a);core.fillText("ui",f[a],e,h+32*a)}core.fillText("ui","前张地图 [▲ / PGUP]",this.HPIXEL,32*d+48);core.fillText("ui","后张地图 [▼ / PGDN]",this.HPIXEL,this.PIXEL-(32*d+48));core.fillText("ui","退出 [ESC / ENTER]",this.HPIXEL,this.HPIXEL);core.fillText("ui","[X] 可查看怪物手册",this.HPIXEL+77,this.HPIXEL+32,null,"13px Arial");core.setTextBaseline("ui","alphabetic")};ui.prototype._drawMaps_buildData=function(d,h,i){var b=(core.status.event.data||{}).damage;var g=(core.status.event.data||{}).paint;var a=(core.status.event.data||{}).all;if(d.damage!=null){b=d.damage}if(d.paint!=null){g=d.paint}if(d.all!=null){a=d.all}if(d.index!=null){h=d.x;i=d.y;d=d.index}d=core.clamp(d,0,core.floorIds.length-1);if(b==null){b=true}var c=core.floorIds[d],f=core.floors[c].width,e=core.floors[c].height;if(h==null){h=parseInt(f/2)}if(i==null){i=parseInt(e/2)}h=core.clamp(h,this.HSIZE,f-this.HSIZE-1);i=core.clamp(i,this.HSIZE,e-this.HSIZE-1);core.status.event.data={index:d,x:h,y:i,floorId:c,mw:f,mh:e,damage:b,paint:g,all:a};return core.status.event.data};ui.prototype.drawToolbox=function(a){var b=this._drawToolbox_getInfo(a);this._drawToolbox_drawBackground();core.setAlpha("ui",1);core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;core.setTextAlign("ui","right");var c=this.PIXEL-306;this._drawToolbox_drawLine(c,"消耗道具");var d=this.PIXEL-146;this._drawToolbox_drawLine(d,"永久道具");this._drawToolbox_drawDescription(b,c);this._drawToolbox_drawContent(b,c,b.tools,b.toolsPage,true);this.drawPagination(b.toolsPage,b.toolsTotalPage,this.LAST-5);this._drawToolbox_drawContent(b,d,b.constants,b.constantsPage);this.drawPagination(b.constantsPage,b.constantsTotalPage);core.setTextAlign("ui","center");core.fillText("ui","[装备栏]",this.PIXEL-46,25,"#DDDDDD",this._buildFont(15,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13)};ui.prototype._drawToolbox_getInfo=function(d){if(!core.status.event.data||core.status.event.data.toolsPage==null){core.status.event.data={toolsPage:1,constantsPage:1,selectId:null}}var g=Object.keys(core.status.hero.items.tools).sort();var a=Object.keys(core.status.hero.items.constants).sort();var h=core.status.event.data.toolsPage;var b=core.status.event.data.constantsPage;var i=Math.ceil(g.length/this.LAST);var c=Math.ceil(a.length/this.LAST);if(d==null){d=g.length==0&&a.length>0?this.LAST:0}core.status.event.selection=d;var e,f;if(d<this.LAST){e=d+(h-1)*this.LAST;if(e>=g.length){e=Math.max(0,g.length-1)}f=g[e]}else{e=d%this.LAST+(b-1)*this.LAST;if(e>=a.length){e=Math.max(0,a.length-1)}f=a[e]}if(!core.hasItem(f)){f=null}core.status.event.data.selectId=f;return{index:d,tools:g,constants:a,toolsPage:h,constantsPage:b,toolsTotalPage:i,constantsTotalPage:c,selectId:f}};ui.prototype._drawToolbox_drawBackground=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000")};ui.prototype._drawToolbox_drawLine=function(b,a){core.setFillStyle("ui","#DDDDDD");core.canvas.ui.beginPath();core.canvas.ui.moveTo(0,b);core.canvas.ui.lineTo(this.PIXEL,b);core.canvas.ui.stroke();core.canvas.ui.beginPath();core.canvas.ui.moveTo(this.PIXEL,b-1);core.canvas.ui.lineTo(this.PIXEL,b-25);core.canvas.ui.lineTo(this.PIXEL-72,b-25);core.canvas.ui.lineTo(this.PIXEL-102,b-1);core.canvas.ui.fill();core.fillText("ui",a,this.PIXEL-5,b-6,"#333333",this._buildFont(16,true))};ui.prototype._drawToolbox_drawDescription=function(f,k){core.setTextAlign("ui","left");if(!f.selectId){return}var g=core.material.items[f.selectId];core.fillText("ui",g.name,10,32,"#FFD700",this._buildFont(20,true));var l=g.text||"该道具暂无描述。";try{l=core.replaceText(l)}catch(b){}for(var c=17;c>=14;c-=3){var j=core.splitLines("ui",l,this.PIXEL-15,this._buildFont(c,false));var h=parseInt(c*1.4),a=37+h;if(a+j.length*h<k){break}}core.setFillStyle("ui","#FFFFFF");for(var d=0;d<j.length;++d){core.fillText("ui",j[d],10,a);a+=h;if(a>=k){break}}if(a<k){core.fillText("ui","<继续点击该道具即可进行使用>",10,a,"#CCCCCC",this._buildFont(14,false))}};ui.prototype._drawToolbox_drawContent=function(e,h,g,j,a){core.setTextAlign("ui","right");for(var b=0;b<this.LAST;b++){var f=g[this.LAST*(j-1)+b];if(!f){continue}var k=h+54*Math.floor(b/this.HSIZE)+19;var c=core.material.icons.items[f],d=core.material.images.items;core.drawImage("ui",d,0,32*c,32,32,64*(b%this.HSIZE)+21,k,32,32);if(a){core.fillText("ui",core.itemCount(f),64*(b%this.HSIZE)+56,k+33,"#FFFFFF",this._buildFont(14,true))}if(e.selectId==f){core.strokeRect("ui",64*(b%this.HSIZE)+17,k-4,40,40,"#FFD700")}}};ui.prototype.drawEquipbox=function(a){var b=this._drawEquipbox_getInfo(a);this._drawToolbox_drawBackground();core.setAlpha("ui",1);core.setStrokeStyle("ui","#DDDDDD");core.canvas.ui.lineWidth=2;core.canvas.ui.strokeWidth=2;core.setTextAlign("ui","right");var c=this.PIXEL-306;this._drawToolbox_drawLine(c,"当前装备");var d=this.PIXEL-146;this._drawToolbox_drawLine(d,"拥有装备");this._drawEquipbox_description(b,c);this._drawEquipbox_drawEquiped(b,c);this._drawToolbox_drawContent(b,d,b.ownEquipment,b.page,true);this.drawPagination(b.page,b.totalPage);core.setTextAlign("ui","center");core.fillText("ui","[道具栏]",this.PIXEL-46,25,"#DDDDDD",this._buildFont(15,true));core.fillText("ui","返回游戏",this.PIXEL-46,this.PIXEL-13)};ui.prototype._drawEquipbox_getInfo=function(d){if(!core.status.event.data||core.status.event.data.page==null){core.status.event.data={page:1,selectId:null}}var a=core.status.globalAttribute.equipName;var c=a.length;if(!core.status.hero.equipment){core.status.hero.equipment=[]}var b=core.status.hero.equipment;var e=Object.keys(core.status.hero.items.equips).sort();var f=core.status.event.data.page;var h=Math.ceil(e.length/this.LAST);if(d==null){if(c>0&&b[0]){d=0}else{if(e.length>0){d=this.LAST}else{d=0}}}if(d>=this.LAST&&e.length==0){d=0}var g=null;if(d<this.LAST){if(d>=c){d=Math.max(0,c-1)}g=b[d]||null}else{if(f==h){d=Math.min(d,(e.length+this.LAST-1)%this.LAST+this.LAST)}g=e[d-this.LAST+(f-1)*this.LAST];if(!core.hasItem(g)){g=null}}core.status.event.selection=d;core.status.event.data.selectId=g;return{index:d,selectId:g,page:f,totalPage:h,allEquips:a,equipLength:c,equipEquipment:b,ownEquipment:e}};ui.prototype._drawEquipbox_description=function(j,m){core.setTextAlign("ui","left");if(!j.selectId){return}var c=core.material.items[j.selectId];if(!c.equip){c.equip={type:0}}var f=c.equip.type,d;if(typeof f==="string"){d=f||"未知部位";f=core.items.getEquipTypeByName(f)}else{d=j.allEquips[f]||"未知部位"}core.fillText("ui",c.name+"（"+d+"）",10,32,"#FFD700",this._buildFont(20,true));var n=c.text||"该装备暂无描述。";try{n=core.replaceText(n)}catch(b){}for(var g=17;g>=11;g-=3){var l=core.splitLines("ui",n,this.PIXEL-15,this._buildFont(g,false));var k=parseInt(g*1.4),a=37+k;if(a+l.length*k<m){break}}core.setFillStyle("ui","#FFFFFF");for(var h=0;h<l.length;++h){core.fillText("ui",l[h],10,a);a+=k;if(a>=m){break}}if(a>=m){return}this._drawEquipbox_drawStatusChanged(j,a,c,f)};ui.prototype._drawEquipbox_getStatusChanged=function(e,c,d,g){var a,b=null;if(e.index<this.LAST){a=core.compareEquipment(null,e.selectId)}else{if(d<0){b="<当前没有该装备的空位，请先卸下装备>"}else{var f=core.material.items[e.equipEquipment[d]]||{};if(f.equip&&(f.equip.percentage||false)!=(c.equip.percentage||false)){b="<数值和比例模式之间的切换不显示属性变化>"}else{a=core.compareEquipment(e.selectId,e.equipEquipment[d])}}}if(b!=null){core.fillText("ui",b,10,g,"#CCCCCC",this._buildFont(14,false));return}return a};ui.prototype._drawEquipbox_drawStatusChanged=function(e,m,b,c){var a=this._drawEquipbox_getStatusChanged(e,b,c,m);if(a==null){return}var k={drawOffset:10,y:m};core.setFont("ui",this._buildFont(14,true));for(var f in a){var d=core.statusBar.icons[f];var l=core.getStatusName(f);if(d&&core.flags.iconInEquipbox){core.drawImage("ui",d,0,0,32,32,k.drawOffset,k.y-13,16,16);k.drawOffset+=20}else{this._drawEquipbox_drawStatusChanged_draw(l+" ","#CCCCCC",k)}var j=core.getStatus(f)*core.getBuff(f),h=(j+a[f])*core.getBuff(f);if(b.equip.percentage){var i=core.getBuff(f),g=i+a[f]/100;j=Math.floor(i*core.getStatus(f));h=Math.floor(g*core.getStatus(f))}j=core.formatBigNumber(j);h=core.formatBigNumber(h);this._drawEquipbox_drawStatusChanged_draw(j+"->","#CCCCCC",k);this._drawEquipbox_drawStatusChanged_draw(h,a[f]>0?"#00FF00":"#FF0000",k);k.drawOffset+=8}};ui.prototype._drawEquipbox_drawStatusChanged_draw=function(d,a,c){var b=core.calWidth("ui",d);if(c.drawOffset+b>=core.__PIXELS__){c.y+=19;c.drawOffset=10}core.fillText("ui",d,c.drawOffset,c.y,a);c.drawOffset+=b};ui.prototype._drawEquipbox_drawEquiped=function(d,e){core.setTextAlign("ui","center");var h=this.HSIZE-3,j=Math.floor(this.PIXEL/(h+0.25));for(var b=0;b<d.equipLength;b++){var a=d.equipEquipment[b]||null;var f=j*(b%h)+j*2/3;var g=f-(j-32)/2;var k=e+54*Math.floor(b/h)+19;if(a){var c=core.material.icons.items[a];core.drawImage("ui",core.material.images.items,0,32*c,32,32,f,k,32,32)}core.fillText("ui",d.allEquips[b]||"未知",g,k+27,"#FFFFFF",this._buildFont(16,true));core.strokeRect("ui",f-4,k-4,40,40,d.index==b?"#FFD700":"#FFFFFF")}};ui.prototype.drawSLPanel=function(a,g){core.control._loadFavoriteSaves();if(a==null){a=1}if(a<0){a=0}var f=parseInt(a/10),e=a%10;var c=main.savePages||30;if(core.status.event.data&&core.status.event.data.mode=="fav"){c=Math.ceil((core.saves.favorite||[]).length/5)}if(f>=c){f=c-1}if(e>5){e=5}if(core.status.event.data&&core.status.event.data.mode=="fav"&&f==c-1){e=Math.min(e,(core.saves.favorite||[]).length-5*f)}var b=-1;var d="all";if(core.status.event.data){b=core.status.event.data.page;d=core.status.event.data.mode}core.status.event.data={page:f,offset:e,mode:d};core.status.event.ui=core.status.event.ui||[];if(g||f!=b){core.status.event.ui=[];this._drawSLPanel_loadSave(f,function(){core.ui._drawSLPanel_draw(f,c)})}else{this._drawSLPanel_draw(f,c)}};ui.prototype._drawSLPanel_draw=function(c,b){this._drawSLPanel_drawBackground();core.ui.drawPagination(c+1,b);core.setTextAlign("ui","center");var a=this.PIXEL-13;core.fillText("ui","返回游戏",this.PIXEL-48,a,"#DDDDDD",this._buildFont(15,true));if(core.status.event.selection){core.setFillStyle("ui","#FF6A6A")}if(core.status.event.id=="save"){core.fillText("ui","删除模式",48,a)}else{if(core.status.event.data.mode=="all"){core.fillText("ui","[E]显示收藏",52,a)}else{core.fillText("ui","[E]显示全部",52,a)}}this._drawSLPanel_drawRecords()};ui.prototype._drawSLPanel_drawBackground=function(){core.clearMap("ui");core.setAlpha("ui",0.85);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#000000");core.setAlpha("ui",1)};ui.prototype._drawSLPanel_loadSave=function(e,a){var d=[0];for(var b=1;b<=5;++b){var c=5*e+b;if(core.status.event.data.mode=="fav"){c=core.saves.favorite[c-1]}d.push(c)}core.getSaves(d,function(f){for(var g=0;g<d.length;++g){core.status.event.ui[g]=f[g]}core.saves.autosave.data=f[0];a()})};ui.prototype._drawSLPanel_drawRecord=function(f,b,i,j,d,a,c){var e="#FFD700";if(core.status.event.selection){e="#FF6A6A"}if(!b||!b.floorId){c=false}core.fillText("ui",f,i,j,c?"#FFD700":"#FFFFFF",this._buildFont(17,true));core.strokeRect("ui",i-d/2,j+15,d,d,a?e:"#FFFFFF",a?6:2);if(b&&b.floorId){core.drawThumbnail(b.floorId,core.maps.loadMap(b.maps,b.floorId).blocks,{heroLoc:b.hero.loc,heroIcon:b.hero.flags.heroIcon,flags:b.hero.flags},{ctx:"ui",x:i-d/2,y:j+15,size:d,centerX:b.hero.loc.x,centerY:b.hero.loc.y});var g=core.formatBigNumber(b.hero.hp,true)+"/"+core.formatBigNumber(b.hero.atk,true)+"/"+core.formatBigNumber(b.hero.def,true);var h="/"+core.formatBigNumber(b.hero.mdef,true);if(core.calWidth("ui",g+h,this._buildFont(10,false))<=d){g+=h}core.fillText("ui",g,i,j+30+d,"#FFD700");core.fillText("ui",core.formatDate(new Date(b.time)),i,j+43+d,b.hero.flags.__consoleOpened__||b.hero.flags.debug?"#FF6A6A":"#FFFFFF")}else{core.fillRect("ui",i-d/2,j+15,d,d,"#333333",2);core.fillText("ui","空",i,parseInt(j+22+d/2),"#FFFFFF",this._buildFont(30,true))}};ui.prototype._drawSLPanel_drawRecords=function(f){var j=core.status.event.data.page;var h=core.status.event.data.offset;var p=Math.floor(this.PIXEL/6),l=Math.floor(this.PIXEL/3-20);var g=core.status.event.id=="save"?"存档":core.status.event.id=="load"?"读档":"回放";for(var d=0;d<(f||6);d++){var b=core.status.event.ui[d];var e=5*j+d;var c=(d>0&&core.saves.favorite.indexOf(e)>=0)||core.status.event.data.mode=="fav";var m=(c?"★ ":"☆ ")+(core.saves.favoriteName[e]||(g+e));if(d!=0&&core.status.event.data.mode=="fav"){if(!b){break}var k=core.saves.favorite[e-1];m=(core.saves.favoriteName[k]||(g+k))+" ?"}var a=32;var o=parseInt((this.PIXEL-a-2*(a*2+l))/3);var q=o+parseInt(a/2)+8;var r=q+a*2+l+o;if(d<3){this._drawSLPanel_drawRecord(d==0?"自动存档":m,b,(2*d+1)*p,q,l,d==h,c)}else{this._drawSLPanel_drawRecord(m,b,(2*d-5)*p,r,l,d==h,c)}}};ui.prototype.drawKeyBoard=function(){core.lockControl();core.status.event.id="keyBoard";core.clearUI();var i=384,b=320;var d=(this.PIXEL-i)/2,g=d+i;var h=(this.PIXEL-b)/2,a=h+b;var c=this.drawBackground(d,h,g,a);core.setTextAlign("ui","center");core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.title));core.fillText("ui","虚拟键盘",this.HPIXEL,h+35,null,this._buildFont(22,true));core.setFont("ui",this._buildFont(17,false));core.setFillStyle("ui",core.arrayToRGBA(core.status.textAttribute.text));var f=this.HPIXEL-89;var e=[["F1","F2","F3","F4","F5","F6","F7","F8","F9","10","11"],["1","2","3","4","5","6","7","8","9","0"],["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],["-","=","[","]","\\",";","'",",",".","/","`"],["ES","TA","CA","SH","CT","AL","SP","BS","EN","DE"]];e.forEach(function(k){for(var j=0;j<k.length;j++){core.fillText("ui",k[j],core.ui.HPIXEL+32*(j-5),f)}f+=32});core.fillText("ui","返回游戏",this.HPIXEL+128,f-3,"#FFFFFF",this._buildFont(15,true));if(c){this.drawWindowSelector(core.status.textAttribute.background,this.HPIXEL+92,f-22,72,27)}else{core.strokeRect("ui",this.HPIXEL+92,f-22,72,27,"#FFD700",2)}};ui.prototype.drawStatusBar=function(){this.uidata.drawStatusBar()};ui.prototype.drawStatistics=function(a){var b=this._drawStatistics_buildObj();if(typeof a=="string"){a=[a]}(a||core.floorIds).forEach(function(d){core.ui._drawStatistics_floorId(d,b)});var c=core.status.hero.statistics;core.setFlag("__replayText__",true);core.drawText([this._drawStatistics_generateText(b,"全塔",b.total),this._drawStatistics_generateText(b,"当前",b.current),"当前总步数："+core.status.hero.steps+"，当前游戏时长："+core.formatTime(c.currTime)+"，总游戏时长"+core.formatTime(c.totalTime)+"。\n瞬间移动次数："+c.moveDirectly+"，共计少走"+c.ignoreSteps+"步。\n\n总计通过血瓶恢复生命值为"+core.formatBigNumber(c.hp)+"点。\n\n总计打死了"+c.battle+"个怪物，得到了"+core.formatBigNumber(c.money)+"金币，"+core.formatBigNumber(c.experience)+"点经验。\n\n受到的总伤害为"+core.formatBigNumber(c.battleDamage+c.poisonDamage+c.extraDamage)+"，其中战斗伤害"+core.formatBigNumber(c.battleDamage)+"点"+(core.flags.enableDebuff?("，中毒伤害"+core.formatBigNumber(c.poisonDamage)+"点"):"")+"，领域/夹击/阻击/血网伤害"+core.formatBigNumber(c.extraDamage)+"点。","\t[说明]1. 地图数据统计的效果仅模拟当前立刻获得该道具的效果。\n2. 不会计算“不可被浏览地图”的隐藏层的数据。\n3. 不会计算任何通过事件得到的道具（显示事件、改变图块、或直接增加道具等）。\n4. 在自定义道具（例如其他宝石）后，需在脚本编辑的drawStatistics中注册，不然不会进行统计。\n5. 所有统计信息仅供参考，如有错误，概不负责。"]);core.removeFlag("__replayText__")};ui.prototype._drawStatistics_buildObj=function(){var g=this.uidata.drawStatistics();var d=g.filter(function(h){return h.endsWith("Door")||core.material.items[h]});var b={},a={},c={};d.forEach(function(h){if(h.endsWith("Door")){a[h]="doors"}else{a[h]=core.material.items[h].cls}b[h]=0});var f=["doors","keys","items","tools","constants","equips"];d.sort(function(h,i){var j=f.indexOf(a[h]),k=f.indexOf(a[i]);if(j==k){return g.indexOf(h)-g.indexOf(i)}return j-k});var e={monster:{count:0,money:0,experience:0,point:0,},count:b,add:{hp:0,atk:0,def:0,mdef:0}};return{ids:d,cls:a,ext:c,total:core.clone(e),current:core.clone(e)}};ui.prototype._drawStatistics_add=function(a,b,d,e,c){b.total[d][e]+=c||0;if(a==core.status.floorId){b.current[d][e]+=c||0}};ui.prototype._drawStatistics_floorId=function(c,d){var b=core.status.maps[c],a=b.blocks;if(b.cannotViewMap&&c!=core.status.floorId){return}a.forEach(function(e){if(e.disable){return}var f=e.event;if(f.cls.indexOf("enemy")==0){core.ui._drawStatistics_enemy(c,f.id,d)}else{var g=f.id;if(d.total.count[g]!=null){core.ui._drawStatistics_items(c,b,g,d)}}})};ui.prototype._drawStatistics_enemy=function(b,c,d){var a=core.material.enemys[c];this._drawStatistics_add(b,d,"monster","money",a.money);this._drawStatistics_add(b,d,"monster","experience",a.experience);this._drawStatistics_add(b,d,"monster","point",a.point);this._drawStatistics_add(b,d,"monster","count",1)};ui.prototype._drawStatistics_items=function(floorId,floor,id,obj){var hp=0,atk=0,def=0,mdef=0;if(obj.cls[id]=="items"&&id!="superPotion"){var temp=core.clone(core.status.hero);core.setFlag("__statistics__",true);var ratio=floor.item_ratio||1;try{eval(core.items.itemEffect[id])}catch(e){}hp=core.status.hero.hp-temp.hp;atk=core.status.hero.atk-temp.atk;def=core.status.hero.def-temp.def;mdef=core.status.hero.mdef-temp.mdef;core.status.hero=temp}else{if(obj.cls[id]=="equips"){var values=core.material.items[id].equip||{};atk=values.atk||0;def=values.def||0;mdef=values.mdef||0}}if(id.indexOf("sword")==0||id.indexOf("shield")==0||obj.cls[id]=="equips"){var t="";if(atk>0){t+=atk+"攻"}if(def>0){t+=def+"防"}if(mdef>0){t+=mdef+"魔防"}if(t!=""){obj.ext[id]=t}}this._drawStatistics_add(floorId,obj,"count",id,1);this._drawStatistics_add(floorId,obj,"add","hp",hp);this._drawStatistics_add(floorId,obj,"add","atk",atk);this._drawStatistics_add(floorId,obj,"add","def",def);this._drawStatistics_add(floorId,obj,"add","mdef",mdef)};ui.prototype._drawStatistics_generateText=function(b,e,a){var d=e+"地图中：\n";d+="共有怪物"+a.monster.count+"个";if(core.flags.enableMoney){d+="，总金币数"+a.monster.money}if(core.flags.enableExperience){d+="，总经验数"+a.monster.experience}if(core.flags.enableAddPoint){d+="，总加点数"+a.monster.point}d+="。\n";var c="";b.ids.forEach(function(f){var g=a.count[f];if(g==0){return}if(b.cls[f]!=c){if(c!=""){d+="。"}d+="\n"}else{d+="，"}c=b.cls[f];d+=core.ui._drawStatistics_getName(f)+g+"个";if(b.ext[f]){d+="("+b.ext[f]+")"}});if(c!=""){d+="。"}d+="\n\n";d+="共加生命值"+core.formatBigNumber(a.add.hp)+"点，攻击"+core.formatBigNumber(a.add.atk)+"点，防御"+core.formatBigNumber(a.add.def)+"点，魔防"+core.formatBigNumber(a.add.mdef)+"点。";return d};ui.prototype._drawStatistics_getName=function(a){return{yellowDoor:"黄门",blueDoor:"蓝门",redDoor:"红门",greenDoor:"绿门",steelDoor:"铁门"}[a]||core.material.items[a].name};ui.prototype.drawAbout=function(){return this.uidata.drawAbout()};ui.prototype.drawPaint=function(){core.drawText("\t[进入绘图模式]你可以在此页面上任意进行绘图和标记操作。\nM键可以进入或退出此模式。\n\n绘图的内容会自动保存，且以页面为生命周期，和存读档无关，重新开始游戏或读档后绘制的内容仍有效，但刷新页面就会消失。\n你可以将绘制内容保存到文件，也可以从文件读取保存的绘制内容。\n浏览地图页面可以按楼传按钮或M键来开启/关闭该层的绘图显示。\n\n更多功能请详见文档-元件-绘图模式。",this._drawPaint_draw)};ui.prototype._drawPaint_draw=function(){core.drawTip("打开绘图模式，现在可以任意在界面上绘图标记");core.lockControl();core.status.event.id="paint";core.status.event.data={x:null,y:null,erase:false};core.clearUI();core.createCanvas("paint",-core.bigmap.offsetX,-core.bigmap.offsetY,32*core.bigmap.width,32*core.bigmap.height,95);var a=core.paint[core.status.floorId];if(core.isset(a)){a=lzw_decode(a).split(",")}core.utils._decodeCanvas(a,32*core.bigmap.width,32*core.bigmap.height);core.drawImage("paint",core.bigmap.tempCanvas.canvas,0,0);core.setLineWidth("paint",3);core.setStrokeStyle("paint","#FF0000");core.statusBar.image.keyboard.style.opacity=0;core.statusBar.image.shop.style.opacity=0;core.statusBar.image.book.src=core.statusBar.icons.paint.src;core.statusBar.image.fly.src=core.statusBar.icons.erase.src;core.statusBar.image.toolbox.src=core.statusBar.icons.empty.src;core.statusBar.image.settings.src=core.statusBar.icons.exit.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.style.opacity=1};ui.prototype.drawHelp=function(){core.clearUI();if(core.material.images.keyboard){core.status.event.id="help";core.lockControl();core.setAlpha("ui",1);core.fillRect("ui",0,0,this.PIXEL,this.PIXEL,"#FFFFFF");core.drawImage("ui",core.material.images.keyboard,32*(this.HSIZE-6),32*(this.HSIZE-6))}else{core.drawText(["\t[键盘快捷键列表][CTRL] 跳过对话   [Z] 转向\n[X] 怪物手册   [G] 楼层传送\n[A] 读取自动存档   [S/D] 存读档页面\n[V] 快捷商店   [ESC] 系统菜单\n[T] 道具页面   [Q] 装备页面\n[B] 数据统计   [H] 帮助页面\n[R] 回放录像   [E] 显示光标\n[SPACE] 轻按   [M] 绘图模式\n[N] 返回标题页面   [P] 游戏主页\n[O] 查看工程   [F7] 打开debug穿墙模式\n[PgUp/PgDn] 浏览地图\n[1~4] 快捷使用破炸飞和其他道具\n[Alt+0~9] 快捷换装","\t[鼠标操作]点状态栏中图标： 进行对应的操作\n点任意块： 寻路并移动\n点任意块并拖动： 指定寻路路线\n双击空地： 瞬间移动\n单击勇士： 转向\n双击勇士： 轻按（仅在轻按开关打开时有效）\n长按任意位置：跳过剧情对话或打开虚拟键盘"])}};ui.prototype.createCanvas=function(b,e,f,d,a,g){if(core.isset(core.dymCanvas[b])){this.relocateCanvas(b,e,f);this.resizeCanvas(b,d,a);core.dymCanvas[b].canvas.style.zIndex=g;return core.dymCanvas[b]}var c=document.createElement("canvas");c.id=b;c.style.display="block";c.width=d;c.height=a;c.setAttribute("_left",e);c.setAttribute("_top",f);c.style.width=d*core.domStyle.scale+"px";c.style.height=a*core.domStyle.scale+"px";c.style.left=e*core.domStyle.scale+"px";c.style.top=f*core.domStyle.scale+"px";c.style.zIndex=g;c.style.position="absolute";core.dymCanvas[b]=c.getContext("2d");core.dom.gameDraw.appendChild(c);return core.dymCanvas[b]};ui.prototype.relocateCanvas=function(b,c,d){var a=core.dymCanvas[b];if(!core.isset(a)){return null}if(core.isset(c)){a.canvas.style.left=c*core.domStyle.scale+"px";a.canvas.setAttribute("_left",c)}if(core.isset(d)){a.canvas.style.top=d*core.domStyle.scale+"px";a.canvas.setAttribute("_top",d)}return a};ui.prototype.resizeCanvas=function(c,d,b){var a=core.dymCanvas[c];if(!core.isset(a)){return null}if(core.isset(d)){a.canvas.width=d;a.canvas.style.width=d*core.domStyle.scale+"px"}if(core.isset(b)){a.canvas.height=b;a.canvas.style.height=b*core.domStyle.scale+"px"}return a};ui.prototype.deleteCanvas=function(a){if(!core.isset(core.dymCanvas[a])){return null}core.dom.gameDraw.removeChild(core.dymCanvas[a].canvas);delete core.dymCanvas[a]};ui.prototype.deleteAllCanvas=function(){Object.keys(core.dymCanvas).forEach(function(a){core.dom.gameDraw.removeChild(core.dymCanvas[a].canvas);delete core.dymCanvas[a]})};"use strict";function core(){this.__SIZE__=13;this.__PIXELS__=this.__SIZE__*32;this.__HALF_SIZE__=Math.floor(this.__SIZE__/2);this.material={animates:{},images:{},bgms:{},sounds:{},ground:null,items:{},enemys:{},icons:{}};this.timeout={tipTimeout:null,turnHeroTimeout:null,onDownTimeout:null,sleepTimeout:null,};this.interval={heroMoveInterval:null,tipAnimate:null,onDownInterval:null,};this.animateFrame={totalTime:0,totalTimeStart:0,globalAnimate:false,globalTime:0,selectorTime:0,selectorUp:true,animateTime:0,moveTime:0,lastLegTime:0,leftLeg:true,weather:{time:0,type:null,nodes:[],data:null,fog:null,},asyncId:{}};this.musicStatus={audioContext:null,bgmStatus:false,soundStatus:true,playingBgm:null,lastBgm:null,gainNode:null,playingSounds:{},volume:1,cachedBgms:[],cachedBgmCount:4,};this.platform={isOnline:true,isPC:true,isAndroid:false,isIOS:false,string:"PC",isWeChat:false,isQQ:false,isChrome:false,supportCopy:false,useLocalForage:true,fileInput:null,fileReader:null,successCallback:null,errorCallback:null,};this.domStyle={scale:1,isVertical:false,showStatusBar:true,toolbarBtn:false,};this.bigmap={canvas:["bg","event","event2","fg","damage"],offsetX:0,offsetY:0,width:this.__SIZE__,height:this.__SIZE__,tempCanvas:null,};this.paint={};this.saves={saveIndex:null,ids:{},autosave:{data:null,time:0,updated:false,},favorite:[],favoriteName:{}};this.initStatus={played:false,gameOver:false,hero:{},floorId:null,thisMap:null,maps:null,bgmaps:{},fgmaps:{},checkBlock:{},lockControl:false,heroMoving:0,heroStop:true,automaticRoute:{autoHeroMove:false,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,offsetX:null,offsetY:null,autoStepRoutes:[],moveStepBeforeStop:[],lastDirection:null,cursorX:null,cursorY:null,moveDirectly:false,},downTime:null,ctrlDown:false,route:[],replay:{replaying:false,pausing:false,animate:false,toReplay:[],totalList:[],speed:1,steps:0,save:[],},shops:{},event:{id:null,data:null,selection:null,ui:null,interval:null,},textAttribute:{position:"center",offset:0,title:[255,215,0,1],background:[0,0,0,0.85],text:[255,255,255,1],titlefont:22,textfont:16,bold:false,time:0,},globalAttribute:{equipName:main.equipName||[],statusLeftBackground:main.statusLeftBackground||"url(project/images/ground.png) repeat",statusTopBackground:main.statusTopBackground||"url(project/images/ground.png) repeat",toolsBackground:main.toolsBackground||"url(project/images/ground.png) repeat",borderColor:main.borderColor||"white",statusBarColor:main.statusBarColor||"white",hardLabelColor:main.hardLabelColor||"red",floorChangingBackground:main.floorChangingBackground||"black",floorChangingTextColor:main.floorChangingTextColor||"white",font:main.font||"Verdana"},curtainColor:null,openingDoor:null,globalAnimateObjs:[],floorAnimateObjs:[],boxAnimateObjs:[],autotileAnimateObjs:{blocks:[],map:null,bgmap:null,fgmap:null},globalAnimateStatus:0,animateObjs:[],};this.status={};this.dymCanvas={}}core.prototype.init=function(b,a){this._forwardFuncs();for(var c in b){core[c]=b[c]}this._init_flags();this._init_platform();this._init_others();this._initPlugins();core.loader._load(function(){core._afterLoadResources(a)})};core.prototype._init_flags=function(){core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.clone(core.data.firstData);this._init_sys_flags();core.dom.versionLabel.innerHTML=core.firstData.version;core.dom.logoLabel.innerHTML=core.firstData.title;document.title=core.firstData.title;document.getElementById("startLogo").innerHTML=core.firstData.title;(core.firstData.shops||[]).forEach(function(a){core.initStatus.shops[a.id]=a});core.maps._setFloorSize();core.material.enemys=core.enemys.getEnemys();core.material.items=core.items.getItems();core.items._resetItems();core.material.icons=core.icons.getIcons()};core.prototype._init_sys_flags=function(){if(!core.flags.enableExperience){core.flags.enableLevelUp=false}if(!core.flags.enableLevelUp){core.flags.levelUpLeftMode=false}if(core.flags.equipboxButton){core.flags.equipment=true}core.flags.displayEnemyDamage=core.getLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.flags.displayCritical=core.getLocalStorage("critical",core.flags.displayCritical);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",core.flags.displayExtraDamage);core.values.moveSpeed=core.getLocalStorage("moveSpeed",core.values.moveSpeed)};core.prototype._init_platform=function(){core.platform.isOnline=location.protocol.indexOf("http")==0;if(!core.platform.isOnline){alert("请勿直接打开html文件！使用启动服务或者APP进行离线游戏。")}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;try{core.musicStatus.audioContext=new window.AudioContext();core.musicStatus.gainNode=core.musicStatus.audioContext.createGain();core.musicStatus.gainNode.connect(core.musicStatus.audioContext.destination)}catch(b){console.log("该浏览器不支持AudioContext");core.musicStatus.audioContext=null}core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",true);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",true);["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"].forEach(function(c){if(navigator.userAgent.indexOf(c)>=0){if(c=="iPhone"||c=="iPad"||c=="iPod"){core.platform.isIOS=true}if(c=="Android"){core.platform.isAndroid=true}core.platform.isPC=false}});core.platform.string=core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"";core.platform.supportCopy=document.queryCommandSupported||document.queryCommandSupported("copy");var a=/Chrome\/(\d+)\./i.exec(navigator.userAgent);if(a&&parseInt(a[1])>=50){core.platform.isChrome=true}core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);this._init_checkLocalForage();if(window.FileReader){core.platform.fileReader=new FileReader();core.platform.fileReader.onload=function(){core.readFileContent(core.platform.fileReader.result)};core.platform.fileReader.onerror=function(){if(core.platform.errorCallback){core.platform.errorCallback()}}}};core.prototype._init_checkLocalForage=function(){core.platform.useLocalForage=core.getLocalStorage("useLocalForage",true);var a=function(c){main.log(c);core.platform.useLocalForage=false};if(core.platform.useLocalForage){try{core.setLocalForage("__test__",lzw_encode("__test__"),function(){try{core.getLocalForage("__test__",null,function(d){try{if(lzw_decode(d)!="__test__"){console.log("localForage unsupported!");core.platform.useLocalForage=false}else{core.removeLocalForage("__test__")}}catch(f){a(f)}},a)}catch(c){a(c)}},a)}catch(b){a(b)}}};core.prototype._init_others=function(){core.material.groundCanvas=document.createElement("canvas").getContext("2d");core.material.groundCanvas.canvas.width=core.material.groundCanvas.canvas.height=32;core.material.groundPattern=core.material.groundCanvas.createPattern(core.material.groundCanvas.canvas,"repeat");core.bigmap.tempCanvas=document.createElement("canvas").getContext("2d");core.loadImage("fog",function(b,a){core.animateFrame.weather.fog=a});core.loadImage("keyboard",function(b,a){core.material.images.keyboard=a});core.saves.saveIndex=core.getLocalStorage("saveIndex",1);core.control.getSaveIndexes(function(a){core.saves.ids=a})};core.prototype._afterLoadResources=function(a){core.initStatus.maps=core.maps._initMaps();core.control._setRequestAnimationFrame();if(core.plugin._afterLoadResources){core.plugin._afterLoadResources()}core.showStartAnimate();if(a){a()}};core.prototype._initPlugins=function(){core.plugin=new function(){};for(var b in plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1){if(plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b] instanceof Function){try{plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b].apply(core.plugin)}catch(a){main.log(a);main.log("无法初始化插件"+b)}}}core._forwardFunc("plugin")};core.prototype._forwardFuncs=function(){for(var a=0;a<main.loadList.length;++a){var b=main.loadList[a];if(b=="core"){continue}this._forwardFunc(b)}};core.prototype._forwardFunc=function(name,funcname){if(funcname==null){for(funcname in core[name]){if(funcname.charAt(0)!="_"&&core[name][funcname] instanceof Function){this._forwardFunc(name,funcname)}}return}if(core[funcname]){console.error("ERROR: 无法转发 "+name+" 中的函数 "+funcname+" 到 core 中！同名函数已存在。");return}var parameterInfo=/^\s*function\s*[\w_$]*\(([\w_,$\s]*)\)\s*\{/.exec(core[name][funcname].toString());var parameters=(parameterInfo==null?"":parameterInfo[1]).replace(/\s*/g,"").replace(/,/g,", ");eval("core."+funcname+" = function ("+parameters+") {\n\treturn core."+name+"."+funcname+"("+parameters+");\n}");if(name=="plugin"){}};core.prototype.doFunc=function(b,a){if(typeof b=="string"){b=core.plugin[b];a=core.plugin}return b.apply(a,Array.prototype.slice.call(arguments,2))};var core=new core();